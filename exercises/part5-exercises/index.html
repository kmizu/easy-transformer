
<!doctype html>
<html lang="ja" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="プログラミング言語実装者のためのTransformer解説と実装">
      
      
        <meta name="author" content="Kota Mizushima">
      
      
        <link rel="canonical" href="https://kmizu.github.io/easy-transformer/exercises/part5-exercises/">
      
      
        <link rel="prev" href="../part4-exercises/">
      
      
        <link rel="next" href="../../advanced/optimization/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.27">
    
    
      
        <title>第5部 演習 - かんたんTransformer</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#5" class="md-skip">
          コンテンツにスキップ
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="ヘッダー">
    <a href="../.." title="かんたんTransformer" class="md-header__button md-logo" aria-label="かんたんTransformer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            かんたんTransformer
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              第5部 演習
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="ダークモードに切り替え"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="ダークモードに切り替え" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="ライトモードに切り替え"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="ライトモードに切り替え" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="検索" placeholder="検索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="検索">
        
        <button type="reset" class="md-search__icon md-icon" title="クリア" aria-label="クリア" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            検索を初期化
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kmizu/easy-transformer" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    easy-transformer
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="ナビゲーション" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="かんたんTransformer" class="md-nav__button md-logo" aria-label="かんたんTransformer" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    かんたんTransformer
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kmizu/easy-transformer" title="リポジトリへ" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    easy-transformer
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ホーム
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    第1部 導入と基礎概念
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            第1部 導入と基礎概念
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/why-transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    なぜTransformerが重要なのか
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/similarities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    プログラミング言語処理との類似点
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/math-basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    必要な数学的基礎
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part1/pytorch-basics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    PyTorchの最小限の使い方
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    第2部 Transformerへの道のり
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            第2部 Transformerへの道のり
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/tokenization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    単語の数値表現
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/attention-intuition/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    注意機構の直感的理解
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/positional-encoding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    位置エンコーディング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part2/layers-and-deep-learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    層の概念と深層学習
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    第3部 Transformerアーキテクチャ詳解
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            第3部 Transformerアーキテクチャ詳解
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/multi-head-attention/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi-Head Attention
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/feed-forward/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Feed Forward Network
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/residual-normalization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    残差接続と層正規化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part3/encoder-decoder/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    エンコーダとデコーダ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    第4部 実装編
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            第4部 実装編
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/minimal-transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    最小限のTransformer実装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/component-implementation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    各コンポーネントの実装
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/debugging-visualization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    デバッグとビジュアライゼーション
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part4/validation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    動作確認
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    第5部 LLMへの拡張
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            第5部 LLMへの拡張
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/gpt-architecture/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    GPTアーキテクチャ
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/pretraining-finetuning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    事前学習とファインチューニング
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/tokenizer-details/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    トークナイザーの詳細
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../part5/inference-techniques/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    推論時の工夫
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    演習問題
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            演習問題
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part1-exercises/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第1部 演習
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part2-exercises/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第2部 演習
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part3-exercises/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第3部 演習
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../part4-exercises/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第4部 演習
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    第5部 演習
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    第5部 演習
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目次">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目次
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#51-gpt" class="md-nav__link">
    <span class="md-ellipsis">
      演習 5.1: GPTアーキテクチャ
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習 5.1: GPTアーキテクチャ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      問題 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      問題 2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      演習 5.2: 事前学習とファインチューニング
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習 5.2: 事前学習とファインチューニング">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      問題 3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      問題 4
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    <span class="md-ellipsis">
      演習 5.3: トークナイザーの詳細
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習 5.3: トークナイザーの詳細">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#5_1" class="md-nav__link">
    <span class="md-ellipsis">
      問題 5
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      問題 6
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    <span class="md-ellipsis">
      演習 5.4: 推論時の工夫
    </span>
  </a>
  
    <nav class="md-nav" aria-label="演習 5.4: 推論時の工夫">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      問題 7
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      チャレンジ問題
    </span>
  </a>
  
    <nav class="md-nav" aria-label="チャレンジ問題">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      問題 8 🌟
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      次のステップ
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    発展的なトピック
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            発展的なトピック
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/optimization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    最適化技術
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../advanced/multimodal/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    マルチモーダル
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    付録
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            付録
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/glossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    用語集
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../appendix/resources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    参考資料
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="5">第5部 演習問題<a class="headerlink" href="#5" title="Permanent link">&para;</a></h1>
<h2 id="51-gpt">演習 5.1: GPTアーキテクチャ<a class="headerlink" href="#51-gpt" title="Permanent link">&para;</a></h2>
<h3 id="1">問題 1<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>因果的（causal）マスキングを実装し、その効果を可視化してください。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">CausalMasking</span><span class="p">:</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;因果的マスキングの実装と可視化&quot;&quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_causal_mask</span><span class="p">(</span><span class="n">seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;因果的マスクの作成&quot;&quot;&quot;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>        <span class="c1"># 下三角行列を作成（対角成分を含む）</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>        <span class="n">mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">))</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>        <span class="k">return</span> <span class="n">mask</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_masks</span><span class="p">():</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;様々なマスキングパターンの可視化&quot;&quot;&quot;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>        <span class="n">seq_len</span> <span class="o">=</span> <span class="mi">10</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>        <span class="c1"># 1. 因果的マスク</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>        <span class="n">causal_mask</span> <span class="o">=</span> <span class="n">CausalMasking</span><span class="o">.</span><span class="n">create_causal_mask</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">causal_mask</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>                   <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.0f&#39;</span><span class="p">)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Causal Mask (GPT-style)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>        <span class="c1"># 2. 双方向マスク（BERT-style）</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>        <span class="n">bidirectional_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">bidirectional_mask</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>                   <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.0f&#39;</span><span class="p">)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Bidirectional Mask (BERT-style)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a>        <span class="c1"># 3. Prefix LMマスク</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a>        <span class="n">prefix_len</span> <span class="o">=</span> <span class="mi">4</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a>        <span class="n">prefix_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a>        <span class="n">prefix_mask</span><span class="p">[</span><span class="n">prefix_len</span><span class="p">:,</span> <span class="n">prefix_len</span><span class="p">:]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">seq_len</span> <span class="o">-</span> <span class="n">prefix_len</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">-</span> <span class="n">prefix_len</span><span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a>        <span class="p">)</span>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">prefix_mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a>                   <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.0f&#39;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Prefix LM Mask (prefix=</span><span class="si">{</span><span class="n">prefix_len</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a>        <span class="c1"># 4. スライディングウィンドウマスク</span>
<a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a>        <span class="n">window_size</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a>        <span class="n">sliding_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">seq_len</span><span class="p">):</span>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a>            <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a>            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a>            <span class="n">sliding_mask</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">sliding_mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a>                   <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.0f&#39;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sliding Window (size=</span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a>        <span class="c1"># 5. ランダムマスク（ドロップアウト風）</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a>        <span class="n">random_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a>        <span class="n">random_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">random_mask</span><span class="p">)</span>  <span class="c1"># 因果性を保持</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">random_mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a>                   <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.0f&#39;</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63" href="#__codelineno-0-63"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Random Causal Mask (80% keep)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64" href="#__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65" href="#__codelineno-0-65"></a>        <span class="c1"># 6. ブロック対角マスク</span>
<a id="__codelineno-0-66" name="__codelineno-0-66" href="#__codelineno-0-66"></a>        <span class="n">block_size</span> <span class="o">=</span> <span class="mi">3</span>
<a id="__codelineno-0-67" name="__codelineno-0-67" href="#__codelineno-0-67"></a>        <span class="n">block_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68" href="#__codelineno-0-68"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">block_size</span><span class="p">):</span>
<a id="__codelineno-0-69" name="__codelineno-0-69" href="#__codelineno-0-69"></a>            <span class="n">end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70" href="#__codelineno-0-70"></a>            <span class="n">block_mask</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<a id="__codelineno-0-71" name="__codelineno-0-71" href="#__codelineno-0-71"></a>        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">block_mask</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> 
<a id="__codelineno-0-72" name="__codelineno-0-72" href="#__codelineno-0-72"></a>                   <span class="n">cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.0f&#39;</span><span class="p">)</span>
<a id="__codelineno-0-73" name="__codelineno-0-73" href="#__codelineno-0-73"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Block Diagonal (size=</span><span class="si">{</span><span class="n">block_size</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-74" name="__codelineno-0-74" href="#__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75" href="#__codelineno-0-75"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-0-76" name="__codelineno-0-76" href="#__codelineno-0-76"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-0-77" name="__codelineno-0-77" href="#__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78" href="#__codelineno-0-78"></a><span class="k">class</span><span class="w"> </span><span class="nc">CausalGPTAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-0-79" name="__codelineno-0-79" href="#__codelineno-0-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;因果的自己注意機構の実装&quot;&quot;&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80" href="#__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81" href="#__codelineno-0-81"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">,</span> <span class="n">max_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">dropout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82" href="#__codelineno-0-82"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-0-83" name="__codelineno-0-83" href="#__codelineno-0-83"></a>        <span class="k">assert</span> <span class="n">d_model</span> <span class="o">%</span> <span class="n">n_heads</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-84" name="__codelineno-0-84" href="#__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85" href="#__codelineno-0-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a id="__codelineno-0-86" name="__codelineno-0-86" href="#__codelineno-0-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span> <span class="o">=</span> <span class="n">n_heads</span>
<a id="__codelineno-0-87" name="__codelineno-0-87" href="#__codelineno-0-87"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span> <span class="o">=</span> <span class="n">d_model</span> <span class="o">//</span> <span class="n">n_heads</span>
<a id="__codelineno-0-88" name="__codelineno-0-88" href="#__codelineno-0-88"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89" href="#__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90" href="#__codelineno-0-90"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">qkv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-91" name="__codelineno-0-91" href="#__codelineno-0-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">out_proj</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-0-92" name="__codelineno-0-92" href="#__codelineno-0-92"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93" href="#__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94" href="#__codelineno-0-94"></a>        <span class="c1"># 因果的マスクをバッファとして登録</span>
<a id="__codelineno-0-95" name="__codelineno-0-95" href="#__codelineno-0-95"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96" href="#__codelineno-0-96"></a>            <span class="s1">&#39;causal_mask&#39;</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97" href="#__codelineno-0-97"></a>            <span class="n">torch</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">max_len</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-98" name="__codelineno-0-98" href="#__codelineno-0-98"></a>        <span class="p">)</span>
<a id="__codelineno-0-99" name="__codelineno-0-99" href="#__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100" href="#__codelineno-0-100"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">output_attentions</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101" href="#__codelineno-0-101"></a>        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-0-102" name="__codelineno-0-102" href="#__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103" href="#__codelineno-0-103"></a>        <span class="c1"># Q, K, V を計算</span>
<a id="__codelineno-0-104" name="__codelineno-0-104" href="#__codelineno-0-104"></a>        <span class="n">qkv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qkv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105" href="#__codelineno-0-105"></a>        <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_k</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> 
<a id="__codelineno-0-106" name="__codelineno-0-106" href="#__codelineno-0-106"></a>                  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">qkv</span><span class="p">]</span>
<a id="__codelineno-0-107" name="__codelineno-0-107" href="#__codelineno-0-107"></a>
<a id="__codelineno-0-108" name="__codelineno-0-108" href="#__codelineno-0-108"></a>        <span class="c1"># アテンションスコア計算</span>
<a id="__codelineno-0-109" name="__codelineno-0-109" href="#__codelineno-0-109"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
<a id="__codelineno-0-110" name="__codelineno-0-110" href="#__codelineno-0-110"></a>
<a id="__codelineno-0-111" name="__codelineno-0-111" href="#__codelineno-0-111"></a>        <span class="c1"># 因果的マスク適用</span>
<a id="__codelineno-0-112" name="__codelineno-0-112" href="#__codelineno-0-112"></a>        <span class="n">causal_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">causal_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="n">seq_len</span><span class="p">,</span> <span class="p">:</span><span class="n">seq_len</span><span class="p">]</span>
<a id="__codelineno-0-113" name="__codelineno-0-113" href="#__codelineno-0-113"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">masked_fill</span><span class="p">(</span><span class="n">causal_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e9</span><span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114" href="#__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115" href="#__codelineno-0-115"></a>        <span class="c1"># ソフトマックスとドロップアウト</span>
<a id="__codelineno-0-116" name="__codelineno-0-116" href="#__codelineno-0-116"></a>        <span class="n">attn_weights</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117" href="#__codelineno-0-117"></a>        <span class="n">attn_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118" href="#__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119" href="#__codelineno-0-119"></a>        <span class="c1"># 値との積</span>
<a id="__codelineno-0-120" name="__codelineno-0-120" href="#__codelineno-0-120"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121" href="#__codelineno-0-121"></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122" href="#__codelineno-0-122"></a>            <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span>
<a id="__codelineno-0-123" name="__codelineno-0-123" href="#__codelineno-0-123"></a>        <span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124" href="#__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125" href="#__codelineno-0-125"></a>        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_proj</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126" href="#__codelineno-0-126"></a>
<a id="__codelineno-0-127" name="__codelineno-0-127" href="#__codelineno-0-127"></a>        <span class="k">if</span> <span class="n">output_attentions</span><span class="p">:</span>
<a id="__codelineno-0-128" name="__codelineno-0-128" href="#__codelineno-0-128"></a>            <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">attn_weights</span>
<a id="__codelineno-0-129" name="__codelineno-0-129" href="#__codelineno-0-129"></a>        <span class="k">return</span> <span class="n">output</span>
<a id="__codelineno-0-130" name="__codelineno-0-130" href="#__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131" href="#__codelineno-0-131"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_causal_masking</span><span class="p">():</span>
<a id="__codelineno-0-132" name="__codelineno-0-132" href="#__codelineno-0-132"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;因果的マスキングのテスト&quot;&quot;&quot;</span>
<a id="__codelineno-0-133" name="__codelineno-0-133" href="#__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134" href="#__codelineno-0-134"></a>    <span class="c1"># マスクパターンの可視化</span>
<a id="__codelineno-0-135" name="__codelineno-0-135" href="#__codelineno-0-135"></a>    <span class="n">CausalMasking</span><span class="o">.</span><span class="n">visualize_masks</span><span class="p">()</span>
<a id="__codelineno-0-136" name="__codelineno-0-136" href="#__codelineno-0-136"></a>
<a id="__codelineno-0-137" name="__codelineno-0-137" href="#__codelineno-0-137"></a>    <span class="c1"># 実際のアテンション計算でのマスク効果</span>
<a id="__codelineno-0-138" name="__codelineno-0-138" href="#__codelineno-0-138"></a>    <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span>
<a id="__codelineno-0-139" name="__codelineno-0-139" href="#__codelineno-0-139"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">CausalGPTAttention</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140" href="#__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141" href="#__codelineno-0-141"></a>    <span class="c1"># テスト入力</span>
<a id="__codelineno-0-142" name="__codelineno-0-142" href="#__codelineno-0-142"></a>    <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span>
<a id="__codelineno-0-143" name="__codelineno-0-143" href="#__codelineno-0-143"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144" href="#__codelineno-0-144"></a>
<a id="__codelineno-0-145" name="__codelineno-0-145" href="#__codelineno-0-145"></a>    <span class="c1"># アテンション重みを取得</span>
<a id="__codelineno-0-146" name="__codelineno-0-146" href="#__codelineno-0-146"></a>    <span class="n">output</span><span class="p">,</span> <span class="n">attn_weights</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">output_attentions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-147" name="__codelineno-0-147" href="#__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148" href="#__codelineno-0-148"></a>    <span class="c1"># 最初のバッチ、最初のヘッドのアテンション重みを可視化</span>
<a id="__codelineno-0-149" name="__codelineno-0-149" href="#__codelineno-0-149"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<a id="__codelineno-0-150" name="__codelineno-0-150" href="#__codelineno-0-150"></a>    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
<a id="__codelineno-0-151" name="__codelineno-0-151" href="#__codelineno-0-151"></a>               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152" href="#__codelineno-0-152"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Causal Attention Weights (Batch 0, Head 0)&#39;</span><span class="p">)</span>
<a id="__codelineno-0-153" name="__codelineno-0-153" href="#__codelineno-0-153"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Key Position&#39;</span><span class="p">)</span>
<a id="__codelineno-0-154" name="__codelineno-0-154" href="#__codelineno-0-154"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Query Position&#39;</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155" href="#__codelineno-0-155"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-0-156" name="__codelineno-0-156" href="#__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157" href="#__codelineno-0-157"></a>    <span class="c1"># マスクの効果を確認（未来の情報が0になっているか）</span>
<a id="__codelineno-0-158" name="__codelineno-0-158" href="#__codelineno-0-158"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attention weights upper triangle (should be ~0):&quot;</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159" href="#__codelineno-0-159"></a>    <span class="n">upper_triangle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">attn_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">diagonal</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160" href="#__codelineno-0-160"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">upper_triangle</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161" href="#__codelineno-0-161"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max value in upper triangle: </span><span class="si">{</span><span class="n">upper_triangle</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162" href="#__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163" href="#__codelineno-0-163"></a><span class="c1"># テスト実行</span>
<a id="__codelineno-0-164" name="__codelineno-0-164" href="#__codelineno-0-164"></a><span class="n">test_causal_masking</span><span class="p">()</span>
</code></pre></div>
</details>
<h3 id="2">問題 2<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p>GPTの位置エンコーディング（learned vs sinusoidal）を比較実装してください。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">PositionalEncodingComparison</span><span class="p">:</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;位置エンコーディング手法の比較&quot;&quot;&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_sinusoidal_encoding</span><span class="p">(</span><span class="n">seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;正弦波位置エンコーディング&quot;&quot;&quot;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>        <span class="n">pe</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>        <span class="n">position</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>        <span class="n">div_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">*</span> 
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>                           <span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10000.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">d_model</span><span class="p">))</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>        <span class="n">pe</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">position</span> <span class="o">*</span> <span class="n">div_term</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>        <span class="k">return</span> <span class="n">pe</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_learned_encoding</span><span class="p">(</span><span class="n">seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">d_model</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">:</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;学習可能な位置エンコーディング&quot;&quot;&quot;</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>        <span class="n">pe</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>        <span class="k">return</span> <span class="n">pe</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="k">class</span><span class="w"> </span><span class="nc">GPTWithPositionalEncoding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;異なる位置エンコーディングを持つGPTモデル&quot;&quot;&quot;</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> 
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a>                 <span class="n">max_len</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span> <span class="n">encoding_type</span><span class="o">=</span><span class="s1">&#39;sinusoidal&#39;</span><span class="p">):</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">d_model</span> <span class="o">=</span> <span class="n">d_model</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoding_type</span> <span class="o">=</span> <span class="n">encoding_type</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>        <span class="c1"># 埋め込み層</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">token_embedding</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a>        <span class="c1"># 位置エンコーディング</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a>        <span class="k">if</span> <span class="n">encoding_type</span> <span class="o">==</span> <span class="s1">&#39;sinusoidal&#39;</span><span class="p">:</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>            <span class="n">pe</span> <span class="o">=</span> <span class="n">PositionalEncodingComparison</span><span class="o">.</span><span class="n">create_sinusoidal_encoding</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;position_encoding&#39;</span><span class="p">,</span> <span class="n">pe</span><span class="p">)</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a>        <span class="k">elif</span> <span class="n">encoding_type</span> <span class="o">==</span> <span class="s1">&#39;learned&#39;</span><span class="p">:</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">position_encoding</span> <span class="o">=</span> <span class="n">PositionalEncodingComparison</span><span class="o">.</span><span class="n">create_learned_encoding</span><span class="p">(</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a>                <span class="n">max_len</span><span class="p">,</span> <span class="n">d_model</span>
<a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a>            <span class="p">)</span>
<a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a>        <span class="k">elif</span> <span class="n">encoding_type</span> <span class="o">==</span> <span class="s1">&#39;rotary&#39;</span><span class="p">:</span>
<a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">rotary_emb</span> <span class="o">=</span> <span class="n">RotaryPositionalEmbedding</span><span class="p">(</span><span class="n">d_model</span> <span class="o">//</span> <span class="n">n_heads</span><span class="p">)</span>
<a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a>
<a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a>        <span class="c1"># Transformerブロック</span>
<a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span>
<a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a>            <span class="n">GPTBlock</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers</span><span class="p">)</span>
<a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a>        <span class="p">])</span>
<a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a>
<a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ln_f</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-60" name="__codelineno-1-60" href="#__codelineno-1-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-1-61" name="__codelineno-1-61" href="#__codelineno-1-61"></a>
<a id="__codelineno-1-62" name="__codelineno-1-62" href="#__codelineno-1-62"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">):</span>
<a id="__codelineno-1-63" name="__codelineno-1-63" href="#__codelineno-1-63"></a>        <span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span>
<a id="__codelineno-1-64" name="__codelineno-1-64" href="#__codelineno-1-64"></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">device</span>
<a id="__codelineno-1-65" name="__codelineno-1-65" href="#__codelineno-1-65"></a>
<a id="__codelineno-1-66" name="__codelineno-1-66" href="#__codelineno-1-66"></a>        <span class="c1"># トークン埋め込み</span>
<a id="__codelineno-1-67" name="__codelineno-1-67" href="#__codelineno-1-67"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token_embedding</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-1-68" name="__codelineno-1-68" href="#__codelineno-1-68"></a>
<a id="__codelineno-1-69" name="__codelineno-1-69" href="#__codelineno-1-69"></a>        <span class="c1"># 位置エンコーディングの追加</span>
<a id="__codelineno-1-70" name="__codelineno-1-70" href="#__codelineno-1-70"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sinusoidal&#39;</span><span class="p">,</span> <span class="s1">&#39;learned&#39;</span><span class="p">]:</span>
<a id="__codelineno-1-71" name="__codelineno-1-71" href="#__codelineno-1-71"></a>            <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-1-72" name="__codelineno-1-72" href="#__codelineno-1-72"></a>            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">position_encoding</span><span class="p">[</span><span class="n">positions</span><span class="p">]</span>
<a id="__codelineno-1-73" name="__codelineno-1-73" href="#__codelineno-1-73"></a>        <span class="c1"># rotaryの場合は各アテンション層で適用</span>
<a id="__codelineno-1-74" name="__codelineno-1-74" href="#__codelineno-1-74"></a>
<a id="__codelineno-1-75" name="__codelineno-1-75" href="#__codelineno-1-75"></a>        <span class="c1"># Transformerブロック</span>
<a id="__codelineno-1-76" name="__codelineno-1-76" href="#__codelineno-1-76"></a>        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocks</span><span class="p">:</span>
<a id="__codelineno-1-77" name="__codelineno-1-77" href="#__codelineno-1-77"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoding_type</span> <span class="o">==</span> <span class="s1">&#39;rotary&#39;</span><span class="p">:</span>
<a id="__codelineno-1-78" name="__codelineno-1-78" href="#__codelineno-1-78"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">rotary_emb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rotary_emb</span><span class="p">)</span>
<a id="__codelineno-1-79" name="__codelineno-1-79" href="#__codelineno-1-79"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-1-80" name="__codelineno-1-80" href="#__codelineno-1-80"></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">block</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-81" name="__codelineno-1-81" href="#__codelineno-1-81"></a>
<a id="__codelineno-1-82" name="__codelineno-1-82" href="#__codelineno-1-82"></a>        <span class="c1"># 最終層正規化と出力</span>
<a id="__codelineno-1-83" name="__codelineno-1-83" href="#__codelineno-1-83"></a>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ln_f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-84" name="__codelineno-1-84" href="#__codelineno-1-84"></a>        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lm_head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-1-85" name="__codelineno-1-85" href="#__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86" href="#__codelineno-1-86"></a>        <span class="k">return</span> <span class="n">logits</span>
<a id="__codelineno-1-87" name="__codelineno-1-87" href="#__codelineno-1-87"></a>
<a id="__codelineno-1-88" name="__codelineno-1-88" href="#__codelineno-1-88"></a><span class="k">class</span><span class="w"> </span><span class="nc">RotaryPositionalEmbedding</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-89" name="__codelineno-1-89" href="#__codelineno-1-89"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Rotary Position Embedding (RoPE)&quot;&quot;&quot;</span>
<a id="__codelineno-1-90" name="__codelineno-1-90" href="#__codelineno-1-90"></a>
<a id="__codelineno-1-91" name="__codelineno-1-91" href="#__codelineno-1-91"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">max_position_embeddings</span><span class="o">=</span><span class="mi">2048</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<a id="__codelineno-1-92" name="__codelineno-1-92" href="#__codelineno-1-92"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-93" name="__codelineno-1-93" href="#__codelineno-1-93"></a>        <span class="n">inv_freq</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">base</span> <span class="o">**</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">/</span> <span class="n">dim</span><span class="p">))</span>
<a id="__codelineno-1-94" name="__codelineno-1-94" href="#__codelineno-1-94"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;inv_freq&#39;</span><span class="p">,</span> <span class="n">inv_freq</span><span class="p">)</span>
<a id="__codelineno-1-95" name="__codelineno-1-95" href="#__codelineno-1-95"></a>
<a id="__codelineno-1-96" name="__codelineno-1-96" href="#__codelineno-1-96"></a>        <span class="c1"># キャッシュ</span>
<a id="__codelineno-1-97" name="__codelineno-1-97" href="#__codelineno-1-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cos_cached</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-98" name="__codelineno-1-98" href="#__codelineno-1-98"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_sin_cached</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-99" name="__codelineno-1-99" href="#__codelineno-1-99"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_seq_len_cached</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-1-100" name="__codelineno-1-100" href="#__codelineno-1-100"></a>
<a id="__codelineno-1-101" name="__codelineno-1-101" href="#__codelineno-1-101"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">seq_len</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-1-102" name="__codelineno-1-102" href="#__codelineno-1-102"></a>        <span class="k">if</span> <span class="n">seq_len</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-103" name="__codelineno-1-103" href="#__codelineno-1-103"></a>            <span class="n">seq_len</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-104" name="__codelineno-1-104" href="#__codelineno-1-104"></a>
<a id="__codelineno-1-105" name="__codelineno-1-105" href="#__codelineno-1-105"></a>        <span class="k">if</span> <span class="n">seq_len</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seq_len_cached</span><span class="p">:</span>
<a id="__codelineno-1-106" name="__codelineno-1-106" href="#__codelineno-1-106"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_seq_len_cached</span> <span class="o">=</span> <span class="n">seq_len</span>
<a id="__codelineno-1-107" name="__codelineno-1-107" href="#__codelineno-1-107"></a>            <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">type_as</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inv_freq</span><span class="p">)</span>
<a id="__codelineno-1-108" name="__codelineno-1-108" href="#__codelineno-1-108"></a>            <span class="n">freqs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;i,j-&gt;ij&#39;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_freq</span><span class="p">)</span>
<a id="__codelineno-1-109" name="__codelineno-1-109" href="#__codelineno-1-109"></a>            <span class="n">emb</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">freqs</span><span class="p">,</span> <span class="n">freqs</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-110" name="__codelineno-1-110" href="#__codelineno-1-110"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_cos_cached</span> <span class="o">=</span> <span class="n">emb</span><span class="o">.</span><span class="n">cos</span><span class="p">()[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-1-111" name="__codelineno-1-111" href="#__codelineno-1-111"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_sin_cached</span> <span class="o">=</span> <span class="n">emb</span><span class="o">.</span><span class="n">sin</span><span class="p">()[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-1-112" name="__codelineno-1-112" href="#__codelineno-1-112"></a>
<a id="__codelineno-1-113" name="__codelineno-1-113" href="#__codelineno-1-113"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cos_cached</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sin_cached</span>
<a id="__codelineno-1-114" name="__codelineno-1-114" href="#__codelineno-1-114"></a>
<a id="__codelineno-1-115" name="__codelineno-1-115" href="#__codelineno-1-115"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-1-116" name="__codelineno-1-116" href="#__codelineno-1-116"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">rotate_half</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<a id="__codelineno-1-117" name="__codelineno-1-117" href="#__codelineno-1-117"></a>        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span><span class="p">:]</span>
<a id="__codelineno-1-118" name="__codelineno-1-118" href="#__codelineno-1-118"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="o">-</span><span class="n">x2</span><span class="p">,</span> <span class="n">x1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-119" name="__codelineno-1-119" href="#__codelineno-1-119"></a>
<a id="__codelineno-1-120" name="__codelineno-1-120" href="#__codelineno-1-120"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_rotary_pos_emb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
<a id="__codelineno-1-121" name="__codelineno-1-121" href="#__codelineno-1-121"></a>        <span class="n">q_embed</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">*</span> <span class="n">cos</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotate_half</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">)</span>
<a id="__codelineno-1-122" name="__codelineno-1-122" href="#__codelineno-1-122"></a>        <span class="n">k_embed</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="n">cos</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotate_half</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">)</span>
<a id="__codelineno-1-123" name="__codelineno-1-123" href="#__codelineno-1-123"></a>        <span class="k">return</span> <span class="n">q_embed</span><span class="p">,</span> <span class="n">k_embed</span>
<a id="__codelineno-1-124" name="__codelineno-1-124" href="#__codelineno-1-124"></a>
<a id="__codelineno-1-125" name="__codelineno-1-125" href="#__codelineno-1-125"></a><span class="k">class</span><span class="w"> </span><span class="nc">GPTBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-1-126" name="__codelineno-1-126" href="#__codelineno-1-126"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;GPTのTransformerブロック&quot;&quot;&quot;</span>
<a id="__codelineno-1-127" name="__codelineno-1-127" href="#__codelineno-1-127"></a>
<a id="__codelineno-1-128" name="__codelineno-1-128" href="#__codelineno-1-128"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">):</span>
<a id="__codelineno-1-129" name="__codelineno-1-129" href="#__codelineno-1-129"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-1-130" name="__codelineno-1-130" href="#__codelineno-1-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ln_1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-131" name="__codelineno-1-131" href="#__codelineno-1-131"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attn</span> <span class="o">=</span> <span class="n">CausalGPTAttention</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">)</span>
<a id="__codelineno-1-132" name="__codelineno-1-132" href="#__codelineno-1-132"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ln_2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">(</span><span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-133" name="__codelineno-1-133" href="#__codelineno-1-133"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<a id="__codelineno-1-134" name="__codelineno-1-134" href="#__codelineno-1-134"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d_model</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">d_model</span><span class="p">),</span>
<a id="__codelineno-1-135" name="__codelineno-1-135" href="#__codelineno-1-135"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">GELU</span><span class="p">(),</span>
<a id="__codelineno-1-136" name="__codelineno-1-136" href="#__codelineno-1-136"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">d_model</span><span class="p">),</span>
<a id="__codelineno-1-137" name="__codelineno-1-137" href="#__codelineno-1-137"></a>            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-1-138" name="__codelineno-1-138" href="#__codelineno-1-138"></a>        <span class="p">)</span>
<a id="__codelineno-1-139" name="__codelineno-1-139" href="#__codelineno-1-139"></a>
<a id="__codelineno-1-140" name="__codelineno-1-140" href="#__codelineno-1-140"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rotary_emb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-1-141" name="__codelineno-1-141" href="#__codelineno-1-141"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">attn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ln_1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-1-142" name="__codelineno-1-142" href="#__codelineno-1-142"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ln_2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<a id="__codelineno-1-143" name="__codelineno-1-143" href="#__codelineno-1-143"></a>        <span class="k">return</span> <span class="n">x</span>
<a id="__codelineno-1-144" name="__codelineno-1-144" href="#__codelineno-1-144"></a>
<a id="__codelineno-1-145" name="__codelineno-1-145" href="#__codelineno-1-145"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_positional_encodings</span><span class="p">():</span>
<a id="__codelineno-1-146" name="__codelineno-1-146" href="#__codelineno-1-146"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;位置エンコーディングの比較実験&quot;&quot;&quot;</span>
<a id="__codelineno-1-147" name="__codelineno-1-147" href="#__codelineno-1-147"></a>
<a id="__codelineno-1-148" name="__codelineno-1-148" href="#__codelineno-1-148"></a>    <span class="c1"># 設定</span>
<a id="__codelineno-1-149" name="__codelineno-1-149" href="#__codelineno-1-149"></a>    <span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">1000</span>
<a id="__codelineno-1-150" name="__codelineno-1-150" href="#__codelineno-1-150"></a>    <span class="n">d_model</span> <span class="o">=</span> <span class="mi">128</span>
<a id="__codelineno-1-151" name="__codelineno-1-151" href="#__codelineno-1-151"></a>    <span class="n">n_heads</span> <span class="o">=</span> <span class="mi">4</span>
<a id="__codelineno-1-152" name="__codelineno-1-152" href="#__codelineno-1-152"></a>    <span class="n">n_layers</span> <span class="o">=</span> <span class="mi">2</span>
<a id="__codelineno-1-153" name="__codelineno-1-153" href="#__codelineno-1-153"></a>    <span class="n">seq_len</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-1-154" name="__codelineno-1-154" href="#__codelineno-1-154"></a>
<a id="__codelineno-1-155" name="__codelineno-1-155" href="#__codelineno-1-155"></a>    <span class="c1"># 各エンコーディングタイプのモデル作成</span>
<a id="__codelineno-1-156" name="__codelineno-1-156" href="#__codelineno-1-156"></a>    <span class="n">models</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-1-157" name="__codelineno-1-157" href="#__codelineno-1-157"></a>        <span class="s1">&#39;sinusoidal&#39;</span><span class="p">:</span> <span class="n">GPTWithPositionalEncoding</span><span class="p">(</span>
<a id="__codelineno-1-158" name="__codelineno-1-158" href="#__codelineno-1-158"></a>            <span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">encoding_type</span><span class="o">=</span><span class="s1">&#39;sinusoidal&#39;</span>
<a id="__codelineno-1-159" name="__codelineno-1-159" href="#__codelineno-1-159"></a>        <span class="p">),</span>
<a id="__codelineno-1-160" name="__codelineno-1-160" href="#__codelineno-1-160"></a>        <span class="s1">&#39;learned&#39;</span><span class="p">:</span> <span class="n">GPTWithPositionalEncoding</span><span class="p">(</span>
<a id="__codelineno-1-161" name="__codelineno-1-161" href="#__codelineno-1-161"></a>            <span class="n">vocab_size</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">n_heads</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">encoding_type</span><span class="o">=</span><span class="s1">&#39;learned&#39;</span>
<a id="__codelineno-1-162" name="__codelineno-1-162" href="#__codelineno-1-162"></a>        <span class="p">)</span>
<a id="__codelineno-1-163" name="__codelineno-1-163" href="#__codelineno-1-163"></a>    <span class="p">}</span>
<a id="__codelineno-1-164" name="__codelineno-1-164" href="#__codelineno-1-164"></a>
<a id="__codelineno-1-165" name="__codelineno-1-165" href="#__codelineno-1-165"></a>    <span class="c1"># 可視化</span>
<a id="__codelineno-1-166" name="__codelineno-1-166" href="#__codelineno-1-166"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-1-167" name="__codelineno-1-167" href="#__codelineno-1-167"></a>
<a id="__codelineno-1-168" name="__codelineno-1-168" href="#__codelineno-1-168"></a>    <span class="c1"># 1. Sinusoidal encoding</span>
<a id="__codelineno-1-169" name="__codelineno-1-169" href="#__codelineno-1-169"></a>    <span class="n">sinusoidal_pe</span> <span class="o">=</span> <span class="n">PositionalEncodingComparison</span><span class="o">.</span><span class="n">create_sinusoidal_encoding</span><span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">d_model</span><span class="p">)</span>
<a id="__codelineno-1-170" name="__codelineno-1-170" href="#__codelineno-1-170"></a>    <span class="n">im1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sinusoidal_pe</span><span class="p">[:</span><span class="mi">20</span><span class="p">,</span> <span class="p">:</span><span class="mi">64</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<a id="__codelineno-1-171" name="__codelineno-1-171" href="#__codelineno-1-171"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sinusoidal Position Encoding&#39;</span><span class="p">)</span>
<a id="__codelineno-1-172" name="__codelineno-1-172" href="#__codelineno-1-172"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<a id="__codelineno-1-173" name="__codelineno-1-173" href="#__codelineno-1-173"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dimension&#39;</span><span class="p">)</span>
<a id="__codelineno-1-174" name="__codelineno-1-174" href="#__codelineno-1-174"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-1-175" name="__codelineno-1-175" href="#__codelineno-1-175"></a>
<a id="__codelineno-1-176" name="__codelineno-1-176" href="#__codelineno-1-176"></a>    <span class="c1"># 2. Learned encoding (初期値)</span>
<a id="__codelineno-1-177" name="__codelineno-1-177" href="#__codelineno-1-177"></a>    <span class="n">learned_pe</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;learned&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">position_encoding</span><span class="o">.</span><span class="n">detach</span><span class="p">()[:</span><span class="mi">20</span><span class="p">,</span> <span class="p">:</span><span class="mi">64</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
<a id="__codelineno-1-178" name="__codelineno-1-178" href="#__codelineno-1-178"></a>    <span class="n">im2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">learned_pe</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
<a id="__codelineno-1-179" name="__codelineno-1-179" href="#__codelineno-1-179"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Learned Position Encoding (Initial)&#39;</span><span class="p">)</span>
<a id="__codelineno-1-180" name="__codelineno-1-180" href="#__codelineno-1-180"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<a id="__codelineno-1-181" name="__codelineno-1-181" href="#__codelineno-1-181"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Dimension&#39;</span><span class="p">)</span>
<a id="__codelineno-1-182" name="__codelineno-1-182" href="#__codelineno-1-182"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-1-183" name="__codelineno-1-183" href="#__codelineno-1-183"></a>
<a id="__codelineno-1-184" name="__codelineno-1-184" href="#__codelineno-1-184"></a>    <span class="c1"># 3. 位置による類似度（Sinusoidal）</span>
<a id="__codelineno-1-185" name="__codelineno-1-185" href="#__codelineno-1-185"></a>    <span class="n">cos_sim_sin</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cosine_similarity</span><span class="p">(</span>
<a id="__codelineno-1-186" name="__codelineno-1-186" href="#__codelineno-1-186"></a>        <span class="n">sinusoidal_pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">sinusoidal_pe</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span>
<a id="__codelineno-1-187" name="__codelineno-1-187" href="#__codelineno-1-187"></a>    <span class="p">)</span>
<a id="__codelineno-1-188" name="__codelineno-1-188" href="#__codelineno-1-188"></a>    <span class="n">im3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cos_sim_sin</span><span class="p">[:</span><span class="mi">20</span><span class="p">,</span> <span class="p">:</span><span class="mi">20</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-1-189" name="__codelineno-1-189" href="#__codelineno-1-189"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Position Similarity (Sinusoidal)&#39;</span><span class="p">)</span>
<a id="__codelineno-1-190" name="__codelineno-1-190" href="#__codelineno-1-190"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<a id="__codelineno-1-191" name="__codelineno-1-191" href="#__codelineno-1-191"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<a id="__codelineno-1-192" name="__codelineno-1-192" href="#__codelineno-1-192"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-1-193" name="__codelineno-1-193" href="#__codelineno-1-193"></a>
<a id="__codelineno-1-194" name="__codelineno-1-194" href="#__codelineno-1-194"></a>    <span class="c1"># 4. 各エンコーディングの特性</span>
<a id="__codelineno-1-195" name="__codelineno-1-195" href="#__codelineno-1-195"></a>    <span class="n">positions</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">seq_len</span><span class="p">)</span>
<a id="__codelineno-1-196" name="__codelineno-1-196" href="#__codelineno-1-196"></a>
<a id="__codelineno-1-197" name="__codelineno-1-197" href="#__codelineno-1-197"></a>    <span class="c1"># 周期性の分析</span>
<a id="__codelineno-1-198" name="__codelineno-1-198" href="#__codelineno-1-198"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]):</span>
<a id="__codelineno-1-199" name="__codelineno-1-199" href="#__codelineno-1-199"></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">&lt;</span> <span class="n">d_model</span><span class="p">:</span>
<a id="__codelineno-1-200" name="__codelineno-1-200" href="#__codelineno-1-200"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">[:</span><span class="mi">30</span><span class="p">],</span> <span class="n">sinusoidal_pe</span><span class="p">[:</span><span class="mi">30</span><span class="p">,</span> <span class="n">dim</span><span class="p">],</span> 
<a id="__codelineno-1-201" name="__codelineno-1-201" href="#__codelineno-1-201"></a>                          <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Dim </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-1-202" name="__codelineno-1-202" href="#__codelineno-1-202"></a>
<a id="__codelineno-1-203" name="__codelineno-1-203" href="#__codelineno-1-203"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Sinusoidal Encoding Periodicity&#39;</span><span class="p">)</span>
<a id="__codelineno-1-204" name="__codelineno-1-204" href="#__codelineno-1-204"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Position&#39;</span><span class="p">)</span>
<a id="__codelineno-1-205" name="__codelineno-1-205" href="#__codelineno-1-205"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Value&#39;</span><span class="p">)</span>
<a id="__codelineno-1-206" name="__codelineno-1-206" href="#__codelineno-1-206"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-1-207" name="__codelineno-1-207" href="#__codelineno-1-207"></a>    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-1-208" name="__codelineno-1-208" href="#__codelineno-1-208"></a>
<a id="__codelineno-1-209" name="__codelineno-1-209" href="#__codelineno-1-209"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-1-210" name="__codelineno-1-210" href="#__codelineno-1-210"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-1-211" name="__codelineno-1-211" href="#__codelineno-1-211"></a>
<a id="__codelineno-1-212" name="__codelineno-1-212" href="#__codelineno-1-212"></a>    <span class="c1"># 簡単な学習実験</span>
<a id="__codelineno-1-213" name="__codelineno-1-213" href="#__codelineno-1-213"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Training Comparison ===&quot;</span><span class="p">)</span>
<a id="__codelineno-1-214" name="__codelineno-1-214" href="#__codelineno-1-214"></a>
<a id="__codelineno-1-215" name="__codelineno-1-215" href="#__codelineno-1-215"></a>    <span class="c1"># ダミーデータで簡単な訓練</span>
<a id="__codelineno-1-216" name="__codelineno-1-216" href="#__codelineno-1-216"></a>    <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<a id="__codelineno-1-217" name="__codelineno-1-217" href="#__codelineno-1-217"></a>    <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<a id="__codelineno-1-218" name="__codelineno-1-218" href="#__codelineno-1-218"></a>
<a id="__codelineno-1-219" name="__codelineno-1-219" href="#__codelineno-1-219"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-1-220" name="__codelineno-1-220" href="#__codelineno-1-220"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
<a id="__codelineno-1-221" name="__codelineno-1-221" href="#__codelineno-1-221"></a>
<a id="__codelineno-1-222" name="__codelineno-1-222" href="#__codelineno-1-222"></a>        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-1-223" name="__codelineno-1-223" href="#__codelineno-1-223"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
<a id="__codelineno-1-224" name="__codelineno-1-224" href="#__codelineno-1-224"></a>            <span class="c1"># ランダムな入力生成</span>
<a id="__codelineno-1-225" name="__codelineno-1-225" href="#__codelineno-1-225"></a>            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">))</span>
<a id="__codelineno-1-226" name="__codelineno-1-226" href="#__codelineno-1-226"></a>            <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">))</span>
<a id="__codelineno-1-227" name="__codelineno-1-227" href="#__codelineno-1-227"></a>
<a id="__codelineno-1-228" name="__codelineno-1-228" href="#__codelineno-1-228"></a>            <span class="c1"># 順伝播</span>
<a id="__codelineno-1-229" name="__codelineno-1-229" href="#__codelineno-1-229"></a>            <span class="n">logits</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-1-230" name="__codelineno-1-230" href="#__codelineno-1-230"></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">),</span> <span class="n">targets</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-231" name="__codelineno-1-231" href="#__codelineno-1-231"></a>
<a id="__codelineno-1-232" name="__codelineno-1-232" href="#__codelineno-1-232"></a>            <span class="c1"># 逆伝播</span>
<a id="__codelineno-1-233" name="__codelineno-1-233" href="#__codelineno-1-233"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-1-234" name="__codelineno-1-234" href="#__codelineno-1-234"></a>            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-1-235" name="__codelineno-1-235" href="#__codelineno-1-235"></a>            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-1-236" name="__codelineno-1-236" href="#__codelineno-1-236"></a>
<a id="__codelineno-1-237" name="__codelineno-1-237" href="#__codelineno-1-237"></a>            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-1-238" name="__codelineno-1-238" href="#__codelineno-1-238"></a>
<a id="__codelineno-1-239" name="__codelineno-1-239" href="#__codelineno-1-239"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> - Final loss: </span><span class="si">{</span><span class="n">losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-1-240" name="__codelineno-1-240" href="#__codelineno-1-240"></a>              <span class="sa">f</span><span class="s2">&quot;Improvement: </span><span class="si">{</span><span class="p">(</span><span class="n">losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">losses</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">losses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
<a id="__codelineno-1-241" name="__codelineno-1-241" href="#__codelineno-1-241"></a>
<a id="__codelineno-1-242" name="__codelineno-1-242" href="#__codelineno-1-242"></a>    <span class="k">return</span> <span class="n">models</span>
<a id="__codelineno-1-243" name="__codelineno-1-243" href="#__codelineno-1-243"></a>
<a id="__codelineno-1-244" name="__codelineno-1-244" href="#__codelineno-1-244"></a><span class="c1"># 比較実行</span>
<a id="__codelineno-1-245" name="__codelineno-1-245" href="#__codelineno-1-245"></a><span class="n">models</span> <span class="o">=</span> <span class="n">compare_positional_encodings</span><span class="p">()</span>
</code></pre></div>
</details>
<h2 id="52">演習 5.2: 事前学習とファインチューニング<a class="headerlink" href="#52" title="Permanent link">&para;</a></h2>
<h3 id="3">問題 3<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>簡単な言語モデルの事前学習ループを実装してください。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">TextDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;シンプルなテキストデータセット&quot;&quot;&quot;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">):</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span> <span class="o">=</span> <span class="n">texts</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">)</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a>        <span class="c1"># パディングまたはトランケート</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a>        <span class="c1"># 言語モデリングでは入力と目標が1つずれる</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a>            <span class="s1">&#39;input_ids&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a>            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a>        <span class="p">}</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="k">class</span><span class="w"> </span><span class="nc">SimpleTokenizer</span><span class="p">:</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;文字レベルの簡単なトークナイザー&quot;&quot;&quot;</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a>        <span class="k">if</span> <span class="n">vocab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a>            <span class="c1"># 基本的な文字セット</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a>            <span class="n">chars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz &quot;</span><span class="p">)</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><span class="p">)</span>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a>            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;0123456789&quot;</span><span class="p">)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a>            <span class="n">chars</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="s2">&quot;.,!?-&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;&lt;pad&gt;&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;&lt;bos&gt;&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;&lt;eos&gt;&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chars</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">vocab</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inv_vocab</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s1">&#39;&lt;pad&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unk_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s1">&#39;&lt;bos&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="s1">&#39;&lt;eos&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a>            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token_id</span><span class="p">))</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a>        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">)</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a>        <span class="k">return</span> <span class="n">tokens</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a>        <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a>        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a>            <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_vocab</span><span class="p">:</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a>                <span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inv_vocab</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a>                <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&lt;pad&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;bos&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;eos&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span><span class="p">]:</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a>                    <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a><span class="k">class</span><span class="w"> </span><span class="nc">PretrainingTrainer</span><span class="p">:</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;事前学習トレーナー&quot;&quot;&quot;</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
<a id="__codelineno-2-83" name="__codelineno-2-83" href="#__codelineno-2-83"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-84" name="__codelineno-2-84" href="#__codelineno-2-84"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-2-85" name="__codelineno-2-85" href="#__codelineno-2-85"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-2-86" name="__codelineno-2-86" href="#__codelineno-2-86"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;perplexity&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-2-87" name="__codelineno-2-87" href="#__codelineno-2-87"></a>
<a id="__codelineno-2-88" name="__codelineno-2-88" href="#__codelineno-2-88"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
<a id="__codelineno-2-89" name="__codelineno-2-89" href="#__codelineno-2-89"></a>             <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
<a id="__codelineno-2-90" name="__codelineno-2-90" href="#__codelineno-2-90"></a>             <span class="n">warmup_steps</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">gradient_clip</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<a id="__codelineno-2-91" name="__codelineno-2-91" href="#__codelineno-2-91"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;事前学習の実行&quot;&quot;&quot;</span>
<a id="__codelineno-2-92" name="__codelineno-2-92" href="#__codelineno-2-92"></a>
<a id="__codelineno-2-93" name="__codelineno-2-93" href="#__codelineno-2-93"></a>        <span class="c1"># データローダー</span>
<a id="__codelineno-2-94" name="__codelineno-2-94" href="#__codelineno-2-94"></a>        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
<a id="__codelineno-2-95" name="__codelineno-2-95" href="#__codelineno-2-95"></a>                                <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-2-96" name="__codelineno-2-96" href="#__codelineno-2-96"></a>        <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> 
<a id="__codelineno-2-97" name="__codelineno-2-97" href="#__codelineno-2-97"></a>                              <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">val_dataset</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-2-98" name="__codelineno-2-98" href="#__codelineno-2-98"></a>
<a id="__codelineno-2-99" name="__codelineno-2-99" href="#__codelineno-2-99"></a>        <span class="c1"># オプティマイザとスケジューラ</span>
<a id="__codelineno-2-100" name="__codelineno-2-100" href="#__codelineno-2-100"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
<a id="__codelineno-2-101" name="__codelineno-2-101" href="#__codelineno-2-101"></a>                                    <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-2-102" name="__codelineno-2-102" href="#__codelineno-2-102"></a>
<a id="__codelineno-2-103" name="__codelineno-2-103" href="#__codelineno-2-103"></a>        <span class="c1"># 線形ウォームアップ + コサイン減衰</span>
<a id="__codelineno-2-104" name="__codelineno-2-104" href="#__codelineno-2-104"></a>        <span class="n">total_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_epochs</span>
<a id="__codelineno-2-105" name="__codelineno-2-105" href="#__codelineno-2-105"></a>        <span class="n">scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_linear_schedule_with_warmup</span><span class="p">(</span>
<a id="__codelineno-2-106" name="__codelineno-2-106" href="#__codelineno-2-106"></a>            <span class="n">optimizer</span><span class="p">,</span> <span class="n">warmup_steps</span><span class="p">,</span> <span class="n">total_steps</span>
<a id="__codelineno-2-107" name="__codelineno-2-107" href="#__codelineno-2-107"></a>        <span class="p">)</span>
<a id="__codelineno-2-108" name="__codelineno-2-108" href="#__codelineno-2-108"></a>
<a id="__codelineno-2-109" name="__codelineno-2-109" href="#__codelineno-2-109"></a>        <span class="c1"># 訓練ループ</span>
<a id="__codelineno-2-110" name="__codelineno-2-110" href="#__codelineno-2-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-2-111" name="__codelineno-2-111" href="#__codelineno-2-111"></a>        <span class="n">global_step</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-2-112" name="__codelineno-2-112" href="#__codelineno-2-112"></a>
<a id="__codelineno-2-113" name="__codelineno-2-113" href="#__codelineno-2-113"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
<a id="__codelineno-2-114" name="__codelineno-2-114" href="#__codelineno-2-114"></a>            <span class="n">epoch_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-2-115" name="__codelineno-2-115" href="#__codelineno-2-115"></a>            <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-2-116" name="__codelineno-2-116" href="#__codelineno-2-116"></a>
<a id="__codelineno-2-117" name="__codelineno-2-117" href="#__codelineno-2-117"></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">progress_bar</span><span class="p">:</span>
<a id="__codelineno-2-118" name="__codelineno-2-118" href="#__codelineno-2-118"></a>                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-119" name="__codelineno-2-119" href="#__codelineno-2-119"></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-120" name="__codelineno-2-120" href="#__codelineno-2-120"></a>
<a id="__codelineno-2-121" name="__codelineno-2-121" href="#__codelineno-2-121"></a>                <span class="c1"># 順伝播</span>
<a id="__codelineno-2-122" name="__codelineno-2-122" href="#__codelineno-2-122"></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-2-123" name="__codelineno-2-123" href="#__codelineno-2-123"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
<a id="__codelineno-2-124" name="__codelineno-2-124" href="#__codelineno-2-124"></a>                    <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
<a id="__codelineno-2-125" name="__codelineno-2-125" href="#__codelineno-2-125"></a>                    <span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-2-126" name="__codelineno-2-126" href="#__codelineno-2-126"></a>                    <span class="n">ignore_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-2-127" name="__codelineno-2-127" href="#__codelineno-2-127"></a>                <span class="p">)</span>
<a id="__codelineno-2-128" name="__codelineno-2-128" href="#__codelineno-2-128"></a>
<a id="__codelineno-2-129" name="__codelineno-2-129" href="#__codelineno-2-129"></a>                <span class="c1"># 逆伝播</span>
<a id="__codelineno-2-130" name="__codelineno-2-130" href="#__codelineno-2-130"></a>                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-2-131" name="__codelineno-2-131" href="#__codelineno-2-131"></a>
<a id="__codelineno-2-132" name="__codelineno-2-132" href="#__codelineno-2-132"></a>                <span class="c1"># 勾配クリッピング</span>
<a id="__codelineno-2-133" name="__codelineno-2-133" href="#__codelineno-2-133"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">gradient_clip</span><span class="p">)</span>
<a id="__codelineno-2-134" name="__codelineno-2-134" href="#__codelineno-2-134"></a>
<a id="__codelineno-2-135" name="__codelineno-2-135" href="#__codelineno-2-135"></a>                <span class="c1"># パラメータ更新</span>
<a id="__codelineno-2-136" name="__codelineno-2-136" href="#__codelineno-2-136"></a>                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-2-137" name="__codelineno-2-137" href="#__codelineno-2-137"></a>                <span class="n">scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-2-138" name="__codelineno-2-138" href="#__codelineno-2-138"></a>                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-2-139" name="__codelineno-2-139" href="#__codelineno-2-139"></a>
<a id="__codelineno-2-140" name="__codelineno-2-140" href="#__codelineno-2-140"></a>                <span class="c1"># 統計情報</span>
<a id="__codelineno-2-141" name="__codelineno-2-141" href="#__codelineno-2-141"></a>                <span class="n">epoch_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-2-142" name="__codelineno-2-142" href="#__codelineno-2-142"></a>                <span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-2-143" name="__codelineno-2-143" href="#__codelineno-2-143"></a>
<a id="__codelineno-2-144" name="__codelineno-2-144" href="#__codelineno-2-144"></a>                <span class="c1"># プログレスバー更新</span>
<a id="__codelineno-2-145" name="__codelineno-2-145" href="#__codelineno-2-145"></a>                <span class="n">progress_bar</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span>
<a id="__codelineno-2-146" name="__codelineno-2-146" href="#__codelineno-2-146"></a>                    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-2-147" name="__codelineno-2-147" href="#__codelineno-2-147"></a>                    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">scheduler</span><span class="o">.</span><span class="n">get_last_lr</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
<a id="__codelineno-2-148" name="__codelineno-2-148" href="#__codelineno-2-148"></a>                    <span class="s1">&#39;ppl&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
<a id="__codelineno-2-149" name="__codelineno-2-149" href="#__codelineno-2-149"></a>                <span class="p">})</span>
<a id="__codelineno-2-150" name="__codelineno-2-150" href="#__codelineno-2-150"></a>
<a id="__codelineno-2-151" name="__codelineno-2-151" href="#__codelineno-2-151"></a>            <span class="c1"># エポック終了時の処理</span>
<a id="__codelineno-2-152" name="__codelineno-2-152" href="#__codelineno-2-152"></a>            <span class="n">avg_train_loss</span> <span class="o">=</span> <span class="n">epoch_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-2-153" name="__codelineno-2-153" href="#__codelineno-2-153"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_train_loss</span><span class="p">)</span>
<a id="__codelineno-2-154" name="__codelineno-2-154" href="#__codelineno-2-154"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;perplexity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">avg_train_loss</span><span class="p">))</span>
<a id="__codelineno-2-155" name="__codelineno-2-155" href="#__codelineno-2-155"></a>
<a id="__codelineno-2-156" name="__codelineno-2-156" href="#__codelineno-2-156"></a>            <span class="c1"># 検証</span>
<a id="__codelineno-2-157" name="__codelineno-2-157" href="#__codelineno-2-157"></a>            <span class="k">if</span> <span class="n">val_loader</span><span class="p">:</span>
<a id="__codelineno-2-158" name="__codelineno-2-158" href="#__codelineno-2-158"></a>                <span class="n">val_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">)</span>
<a id="__codelineno-2-159" name="__codelineno-2-159" href="#__codelineno-2-159"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
<a id="__codelineno-2-160" name="__codelineno-2-160" href="#__codelineno-2-160"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Train Loss = </span><span class="si">{</span><span class="n">avg_train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-2-161" name="__codelineno-2-161" href="#__codelineno-2-161"></a>                      <span class="sa">f</span><span class="s2">&quot;Val Loss = </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-2-162" name="__codelineno-2-162" href="#__codelineno-2-162"></a>                      <span class="sa">f</span><span class="s2">&quot;Val Perplexity = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-163" name="__codelineno-2-163" href="#__codelineno-2-163"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-2-164" name="__codelineno-2-164" href="#__codelineno-2-164"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: Train Loss = </span><span class="si">{</span><span class="n">avg_train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-2-165" name="__codelineno-2-165" href="#__codelineno-2-165"></a>                      <span class="sa">f</span><span class="s2">&quot;Perplexity = </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">avg_train_loss</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-166" name="__codelineno-2-166" href="#__codelineno-2-166"></a>
<a id="__codelineno-2-167" name="__codelineno-2-167" href="#__codelineno-2-167"></a>            <span class="c1"># 生成サンプル</span>
<a id="__codelineno-2-168" name="__codelineno-2-168" href="#__codelineno-2-168"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-2-169" name="__codelineno-2-169" href="#__codelineno-2-169"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">generate_samples</span><span class="p">()</span>
<a id="__codelineno-2-170" name="__codelineno-2-170" href="#__codelineno-2-170"></a>
<a id="__codelineno-2-171" name="__codelineno-2-171" href="#__codelineno-2-171"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">):</span>
<a id="__codelineno-2-172" name="__codelineno-2-172" href="#__codelineno-2-172"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルの評価&quot;&quot;&quot;</span>
<a id="__codelineno-2-173" name="__codelineno-2-173" href="#__codelineno-2-173"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-2-174" name="__codelineno-2-174" href="#__codelineno-2-174"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-2-175" name="__codelineno-2-175" href="#__codelineno-2-175"></a>
<a id="__codelineno-2-176" name="__codelineno-2-176" href="#__codelineno-2-176"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-2-177" name="__codelineno-2-177" href="#__codelineno-2-177"></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
<a id="__codelineno-2-178" name="__codelineno-2-178" href="#__codelineno-2-178"></a>                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-179" name="__codelineno-2-179" href="#__codelineno-2-179"></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-180" name="__codelineno-2-180" href="#__codelineno-2-180"></a>
<a id="__codelineno-2-181" name="__codelineno-2-181" href="#__codelineno-2-181"></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-2-182" name="__codelineno-2-182" href="#__codelineno-2-182"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
<a id="__codelineno-2-183" name="__codelineno-2-183" href="#__codelineno-2-183"></a>                    <span class="n">logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
<a id="__codelineno-2-184" name="__codelineno-2-184" href="#__codelineno-2-184"></a>                    <span class="n">labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-2-185" name="__codelineno-2-185" href="#__codelineno-2-185"></a>                    <span class="n">ignore_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-2-186" name="__codelineno-2-186" href="#__codelineno-2-186"></a>                <span class="p">)</span>
<a id="__codelineno-2-187" name="__codelineno-2-187" href="#__codelineno-2-187"></a>
<a id="__codelineno-2-188" name="__codelineno-2-188" href="#__codelineno-2-188"></a>                <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-2-189" name="__codelineno-2-189" href="#__codelineno-2-189"></a>
<a id="__codelineno-2-190" name="__codelineno-2-190" href="#__codelineno-2-190"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-2-191" name="__codelineno-2-191" href="#__codelineno-2-191"></a>        <span class="k">return</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
<a id="__codelineno-2-192" name="__codelineno-2-192" href="#__codelineno-2-192"></a>
<a id="__codelineno-2-193" name="__codelineno-2-193" href="#__codelineno-2-193"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
<a id="__codelineno-2-194" name="__codelineno-2-194" href="#__codelineno-2-194"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;テキスト生成サンプル&quot;&quot;&quot;</span>
<a id="__codelineno-2-195" name="__codelineno-2-195" href="#__codelineno-2-195"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-2-196" name="__codelineno-2-196" href="#__codelineno-2-196"></a>
<a id="__codelineno-2-197" name="__codelineno-2-197" href="#__codelineno-2-197"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Generated Samples ===&quot;</span><span class="p">)</span>
<a id="__codelineno-2-198" name="__codelineno-2-198" href="#__codelineno-2-198"></a>
<a id="__codelineno-2-199" name="__codelineno-2-199" href="#__codelineno-2-199"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
<a id="__codelineno-2-200" name="__codelineno-2-200" href="#__codelineno-2-200"></a>            <span class="c1"># BOS トークンから開始</span>
<a id="__codelineno-2-201" name="__codelineno-2-201" href="#__codelineno-2-201"></a>            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]],</span> 
<a id="__codelineno-2-202" name="__codelineno-2-202" href="#__codelineno-2-202"></a>                                    <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-2-203" name="__codelineno-2-203" href="#__codelineno-2-203"></a>
<a id="__codelineno-2-204" name="__codelineno-2-204" href="#__codelineno-2-204"></a>            <span class="n">generated_tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">bos_token_id</span><span class="p">]</span>
<a id="__codelineno-2-205" name="__codelineno-2-205" href="#__codelineno-2-205"></a>
<a id="__codelineno-2-206" name="__codelineno-2-206" href="#__codelineno-2-206"></a>            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length</span><span class="p">):</span>
<a id="__codelineno-2-207" name="__codelineno-2-207" href="#__codelineno-2-207"></a>                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-2-208" name="__codelineno-2-208" href="#__codelineno-2-208"></a>                    <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-2-209" name="__codelineno-2-209" href="#__codelineno-2-209"></a>                    <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">logits</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">temperature</span>
<a id="__codelineno-2-210" name="__codelineno-2-210" href="#__codelineno-2-210"></a>
<a id="__codelineno-2-211" name="__codelineno-2-211" href="#__codelineno-2-211"></a>                    <span class="c1"># サンプリング</span>
<a id="__codelineno-2-212" name="__codelineno-2-212" href="#__codelineno-2-212"></a>                    <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-213" name="__codelineno-2-213" href="#__codelineno-2-213"></a>                    <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-214" name="__codelineno-2-214" href="#__codelineno-2-214"></a>
<a id="__codelineno-2-215" name="__codelineno-2-215" href="#__codelineno-2-215"></a>                    <span class="n">generated_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_token</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-2-216" name="__codelineno-2-216" href="#__codelineno-2-216"></a>
<a id="__codelineno-2-217" name="__codelineno-2-217" href="#__codelineno-2-217"></a>                    <span class="c1"># EOS トークンで終了</span>
<a id="__codelineno-2-218" name="__codelineno-2-218" href="#__codelineno-2-218"></a>                    <span class="k">if</span> <span class="n">next_token</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
<a id="__codelineno-2-219" name="__codelineno-2-219" href="#__codelineno-2-219"></a>                        <span class="k">break</span>
<a id="__codelineno-2-220" name="__codelineno-2-220" href="#__codelineno-2-220"></a>
<a id="__codelineno-2-221" name="__codelineno-2-221" href="#__codelineno-2-221"></a>                    <span class="c1"># 次の入力</span>
<a id="__codelineno-2-222" name="__codelineno-2-222" href="#__codelineno-2-222"></a>                    <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">next_token</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-2-223" name="__codelineno-2-223" href="#__codelineno-2-223"></a>
<a id="__codelineno-2-224" name="__codelineno-2-224" href="#__codelineno-2-224"></a>            <span class="c1"># デコード</span>
<a id="__codelineno-2-225" name="__codelineno-2-225" href="#__codelineno-2-225"></a>            <span class="n">generated_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">generated_tokens</span><span class="p">)</span>
<a id="__codelineno-2-226" name="__codelineno-2-226" href="#__codelineno-2-226"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">generated_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-227" name="__codelineno-2-227" href="#__codelineno-2-227"></a>
<a id="__codelineno-2-228" name="__codelineno-2-228" href="#__codelineno-2-228"></a>        <span class="nb">print</span><span class="p">()</span>
<a id="__codelineno-2-229" name="__codelineno-2-229" href="#__codelineno-2-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-2-230" name="__codelineno-2-230" href="#__codelineno-2-230"></a>
<a id="__codelineno-2-231" name="__codelineno-2-231" href="#__codelineno-2-231"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-2-232" name="__codelineno-2-232" href="#__codelineno-2-232"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_linear_schedule_with_warmup</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">,</span> <span class="n">num_training_steps</span><span class="p">):</span>
<a id="__codelineno-2-233" name="__codelineno-2-233" href="#__codelineno-2-233"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;線形ウォームアップ + 線形減衰スケジューラ&quot;&quot;&quot;</span>
<a id="__codelineno-2-234" name="__codelineno-2-234" href="#__codelineno-2-234"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">lr_lambda</span><span class="p">(</span><span class="n">current_step</span><span class="p">):</span>
<a id="__codelineno-2-235" name="__codelineno-2-235" href="#__codelineno-2-235"></a>            <span class="k">if</span> <span class="n">current_step</span> <span class="o">&lt;</span> <span class="n">num_warmup_steps</span><span class="p">:</span>
<a id="__codelineno-2-236" name="__codelineno-2-236" href="#__codelineno-2-236"></a>                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">current_step</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_warmup_steps</span><span class="p">))</span>
<a id="__codelineno-2-237" name="__codelineno-2-237" href="#__codelineno-2-237"></a>            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_training_steps</span> <span class="o">-</span> <span class="n">current_step</span><span class="p">)</span> <span class="o">/</span> 
<a id="__codelineno-2-238" name="__codelineno-2-238" href="#__codelineno-2-238"></a>                      <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_training_steps</span> <span class="o">-</span> <span class="n">num_warmup_steps</span><span class="p">)))</span>
<a id="__codelineno-2-239" name="__codelineno-2-239" href="#__codelineno-2-239"></a>
<a id="__codelineno-2-240" name="__codelineno-2-240" href="#__codelineno-2-240"></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">LambdaLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_lambda</span><span class="p">)</span>
<a id="__codelineno-2-241" name="__codelineno-2-241" href="#__codelineno-2-241"></a>
<a id="__codelineno-2-242" name="__codelineno-2-242" href="#__codelineno-2-242"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_training_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-2-243" name="__codelineno-2-243" href="#__codelineno-2-243"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練履歴の可視化&quot;&quot;&quot;</span>
<a id="__codelineno-2-244" name="__codelineno-2-244" href="#__codelineno-2-244"></a>        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-2-245" name="__codelineno-2-245" href="#__codelineno-2-245"></a>
<a id="__codelineno-2-246" name="__codelineno-2-246" href="#__codelineno-2-246"></a>        <span class="c1"># 損失</span>
<a id="__codelineno-2-247" name="__codelineno-2-247" href="#__codelineno-2-247"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Loss&#39;</span><span class="p">)</span>
<a id="__codelineno-2-248" name="__codelineno-2-248" href="#__codelineno-2-248"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]:</span>
<a id="__codelineno-2-249" name="__codelineno-2-249" href="#__codelineno-2-249"></a>            <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Val Loss&#39;</span><span class="p">)</span>
<a id="__codelineno-2-250" name="__codelineno-2-250" href="#__codelineno-2-250"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<a id="__codelineno-2-251" name="__codelineno-2-251" href="#__codelineno-2-251"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<a id="__codelineno-2-252" name="__codelineno-2-252" href="#__codelineno-2-252"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Training and Validation Loss&#39;</span><span class="p">)</span>
<a id="__codelineno-2-253" name="__codelineno-2-253" href="#__codelineno-2-253"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-2-254" name="__codelineno-2-254" href="#__codelineno-2-254"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-2-255" name="__codelineno-2-255" href="#__codelineno-2-255"></a>
<a id="__codelineno-2-256" name="__codelineno-2-256" href="#__codelineno-2-256"></a>        <span class="c1"># パープレキシティ</span>
<a id="__codelineno-2-257" name="__codelineno-2-257" href="#__codelineno-2-257"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;perplexity&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Train Perplexity&#39;</span><span class="p">)</span>
<a id="__codelineno-2-258" name="__codelineno-2-258" href="#__codelineno-2-258"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<a id="__codelineno-2-259" name="__codelineno-2-259" href="#__codelineno-2-259"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Perplexity&#39;</span><span class="p">)</span>
<a id="__codelineno-2-260" name="__codelineno-2-260" href="#__codelineno-2-260"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Perplexity&#39;</span><span class="p">)</span>
<a id="__codelineno-2-261" name="__codelineno-2-261" href="#__codelineno-2-261"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<a id="__codelineno-2-262" name="__codelineno-2-262" href="#__codelineno-2-262"></a>        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-2-263" name="__codelineno-2-263" href="#__codelineno-2-263"></a>
<a id="__codelineno-2-264" name="__codelineno-2-264" href="#__codelineno-2-264"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-2-265" name="__codelineno-2-265" href="#__codelineno-2-265"></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-2-266" name="__codelineno-2-266" href="#__codelineno-2-266"></a>
<a id="__codelineno-2-267" name="__codelineno-2-267" href="#__codelineno-2-267"></a><span class="c1"># 使用例</span>
<a id="__codelineno-2-268" name="__codelineno-2-268" href="#__codelineno-2-268"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_pretraining_example</span><span class="p">():</span>
<a id="__codelineno-2-269" name="__codelineno-2-269" href="#__codelineno-2-269"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;事前学習の実行例&quot;&quot;&quot;</span>
<a id="__codelineno-2-270" name="__codelineno-2-270" href="#__codelineno-2-270"></a>
<a id="__codelineno-2-271" name="__codelineno-2-271" href="#__codelineno-2-271"></a>    <span class="c1"># サンプルテキストデータ</span>
<a id="__codelineno-2-272" name="__codelineno-2-272" href="#__codelineno-2-272"></a>    <span class="n">train_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-2-273" name="__codelineno-2-273" href="#__codelineno-2-273"></a>        <span class="s2">&quot;The quick brown fox jumps over the lazy dog.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-274" name="__codelineno-2-274" href="#__codelineno-2-274"></a>        <span class="s2">&quot;Machine learning is transforming the world.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-275" name="__codelineno-2-275" href="#__codelineno-2-275"></a>        <span class="s2">&quot;Natural language processing enables computers to understand human language.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-276" name="__codelineno-2-276" href="#__codelineno-2-276"></a>        <span class="s2">&quot;Deep learning models can learn complex patterns from data.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-277" name="__codelineno-2-277" href="#__codelineno-2-277"></a>        <span class="s2">&quot;Transformers have revolutionized NLP tasks.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-278" name="__codelineno-2-278" href="#__codelineno-2-278"></a>        <span class="s2">&quot;Attention is all you need for sequence modeling.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-279" name="__codelineno-2-279" href="#__codelineno-2-279"></a>        <span class="s2">&quot;Pre-training helps models learn general language understanding.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-280" name="__codelineno-2-280" href="#__codelineno-2-280"></a>        <span class="s2">&quot;Fine-tuning adapts models to specific tasks.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-281" name="__codelineno-2-281" href="#__codelineno-2-281"></a>    <span class="p">]</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># データを増やす</span>
<a id="__codelineno-2-282" name="__codelineno-2-282" href="#__codelineno-2-282"></a>
<a id="__codelineno-2-283" name="__codelineno-2-283" href="#__codelineno-2-283"></a>    <span class="n">val_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-2-284" name="__codelineno-2-284" href="#__codelineno-2-284"></a>        <span class="s2">&quot;AI systems are becoming more sophisticated.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-285" name="__codelineno-2-285" href="#__codelineno-2-285"></a>        <span class="s2">&quot;Language models can generate coherent text.&quot;</span><span class="p">,</span>
<a id="__codelineno-2-286" name="__codelineno-2-286" href="#__codelineno-2-286"></a>    <span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>
<a id="__codelineno-2-287" name="__codelineno-2-287" href="#__codelineno-2-287"></a>
<a id="__codelineno-2-288" name="__codelineno-2-288" href="#__codelineno-2-288"></a>    <span class="c1"># トークナイザーとデータセット</span>
<a id="__codelineno-2-289" name="__codelineno-2-289" href="#__codelineno-2-289"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SimpleTokenizer</span><span class="p">()</span>
<a id="__codelineno-2-290" name="__codelineno-2-290" href="#__codelineno-2-290"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">train_texts</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<a id="__codelineno-2-291" name="__codelineno-2-291" href="#__codelineno-2-291"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">TextDataset</span><span class="p">(</span><span class="n">val_texts</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<a id="__codelineno-2-292" name="__codelineno-2-292" href="#__codelineno-2-292"></a>
<a id="__codelineno-2-293" name="__codelineno-2-293" href="#__codelineno-2-293"></a>    <span class="c1"># モデル作成</span>
<a id="__codelineno-2-294" name="__codelineno-2-294" href="#__codelineno-2-294"></a>    <span class="n">vocab_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-2-295" name="__codelineno-2-295" href="#__codelineno-2-295"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">GPTWithPositionalEncoding</span><span class="p">(</span>
<a id="__codelineno-2-296" name="__codelineno-2-296" href="#__codelineno-2-296"></a>        <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span>
<a id="__codelineno-2-297" name="__codelineno-2-297" href="#__codelineno-2-297"></a>        <span class="n">d_model</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-2-298" name="__codelineno-2-298" href="#__codelineno-2-298"></a>        <span class="n">n_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-2-299" name="__codelineno-2-299" href="#__codelineno-2-299"></a>        <span class="n">n_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-2-300" name="__codelineno-2-300" href="#__codelineno-2-300"></a>        <span class="n">encoding_type</span><span class="o">=</span><span class="s1">&#39;learned&#39;</span>
<a id="__codelineno-2-301" name="__codelineno-2-301" href="#__codelineno-2-301"></a>    <span class="p">)</span>
<a id="__codelineno-2-302" name="__codelineno-2-302" href="#__codelineno-2-302"></a>
<a id="__codelineno-2-303" name="__codelineno-2-303" href="#__codelineno-2-303"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model parameters: </span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-304" name="__codelineno-2-304" href="#__codelineno-2-304"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary size: </span><span class="si">{</span><span class="n">vocab_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-2-305" name="__codelineno-2-305" href="#__codelineno-2-305"></a>
<a id="__codelineno-2-306" name="__codelineno-2-306" href="#__codelineno-2-306"></a>    <span class="c1"># トレーナー作成と訓練</span>
<a id="__codelineno-2-307" name="__codelineno-2-307" href="#__codelineno-2-307"></a>    <span class="n">trainer</span> <span class="o">=</span> <span class="n">PretrainingTrainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-2-308" name="__codelineno-2-308" href="#__codelineno-2-308"></a>
<a id="__codelineno-2-309" name="__codelineno-2-309" href="#__codelineno-2-309"></a>    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
<a id="__codelineno-2-310" name="__codelineno-2-310" href="#__codelineno-2-310"></a>        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_dataset</span><span class="p">,</span>
<a id="__codelineno-2-311" name="__codelineno-2-311" href="#__codelineno-2-311"></a>        <span class="n">val_dataset</span><span class="o">=</span><span class="n">val_dataset</span><span class="p">,</span>
<a id="__codelineno-2-312" name="__codelineno-2-312" href="#__codelineno-2-312"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-2-313" name="__codelineno-2-313" href="#__codelineno-2-313"></a>        <span class="n">num_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<a id="__codelineno-2-314" name="__codelineno-2-314" href="#__codelineno-2-314"></a>        <span class="n">learning_rate</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span>
<a id="__codelineno-2-315" name="__codelineno-2-315" href="#__codelineno-2-315"></a>        <span class="n">warmup_steps</span><span class="o">=</span><span class="mi">100</span>
<a id="__codelineno-2-316" name="__codelineno-2-316" href="#__codelineno-2-316"></a>    <span class="p">)</span>
<a id="__codelineno-2-317" name="__codelineno-2-317" href="#__codelineno-2-317"></a>
<a id="__codelineno-2-318" name="__codelineno-2-318" href="#__codelineno-2-318"></a>    <span class="c1"># 結果の可視化</span>
<a id="__codelineno-2-319" name="__codelineno-2-319" href="#__codelineno-2-319"></a>    <span class="n">trainer</span><span class="o">.</span><span class="n">plot_training_history</span><span class="p">()</span>
<a id="__codelineno-2-320" name="__codelineno-2-320" href="#__codelineno-2-320"></a>
<a id="__codelineno-2-321" name="__codelineno-2-321" href="#__codelineno-2-321"></a>    <span class="k">return</span> <span class="n">trainer</span><span class="p">,</span> <span class="n">model</span>
<a id="__codelineno-2-322" name="__codelineno-2-322" href="#__codelineno-2-322"></a>
<a id="__codelineno-2-323" name="__codelineno-2-323" href="#__codelineno-2-323"></a><span class="c1"># 実行</span>
<a id="__codelineno-2-324" name="__codelineno-2-324" href="#__codelineno-2-324"></a><span class="n">trainer</span><span class="p">,</span> <span class="n">pretrained_model</span> <span class="o">=</span> <span class="n">run_pretraining_example</span><span class="p">()</span>
</code></pre></div>
</details>
<h3 id="4">問題 4<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<p>ファインチューニングのための異なる戦略を実装してください（フル、最終層のみ、LoRA）。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataLoader</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">LoRALayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Low-Rank Adaptation (LoRA) レイヤー&quot;&quot;&quot;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">out_features</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a>                 <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">16.0</span><span class="p">):</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">rank</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a>        <span class="c1"># LoRA パラメータ</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">rank</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rank</span><span class="p">,</span> <span class="n">out_features</span><span class="p">))</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a>        <span class="c1"># 元の重みは凍結される（外部で管理）</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">merged</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a>        <span class="c1"># LoRA の追加項を計算</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>        <span class="n">lora_output</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_A</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora_B</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling</span>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a>        <span class="k">return</span> <span class="n">lora_output</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a><span class="k">class</span><span class="w"> </span><span class="nc">FineTuningStrategies</span><span class="p">:</span>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ファインチューニング戦略の実装&quot;&quot;&quot;</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">freeze_all_but_last</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;最終層以外をすべて凍結&quot;&quot;&quot;</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>        <span class="c1"># すべてのパラメータを凍結</span>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a>            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a>        <span class="c1"># 最終層（言語モデルヘッド）のみ解凍</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;lm_head&#39;</span><span class="p">):</span>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">lm_head</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a>        <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">apply_lora</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">16.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">:</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;LoRAを適用&quot;&quot;&quot;</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a>        <span class="c1"># すべてのパラメータを凍結</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a>        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a>            <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a>        <span class="c1"># Linear層にLoRAを追加</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>        <span class="n">lora_layers</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;lm_head&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a>                <span class="c1"># LoRAレイヤーを作成</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a>                <span class="n">lora_layer</span> <span class="o">=</span> <span class="n">LoRALayer</span><span class="p">(</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a>                    <span class="n">module</span><span class="o">.</span><span class="n">in_features</span><span class="p">,</span> 
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>                    <span class="n">module</span><span class="o">.</span><span class="n">out_features</span><span class="p">,</span>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a>                    <span class="n">rank</span><span class="o">=</span><span class="n">rank</span><span class="p">,</span>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a>                    <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a>                <span class="p">)</span>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a>                <span class="n">lora_layers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lora_layer</span>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a>        <span class="c1"># LoRAレイヤーをモデルに追加</span>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">lora_layer</span> <span class="ow">in</span> <span class="n">lora_layers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a>            <span class="n">parent_name</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a>            <span class="n">child_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a>            <span class="n">parent</span> <span class="o">=</span> <span class="n">model</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>            <span class="k">if</span> <span class="n">parent_name</span><span class="p">:</span>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a>                <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parent_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a>                    <span class="n">parent</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>            <span class="c1"># 元のLinear層をラップ</span>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a>            <span class="n">original_layer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_name</span><span class="p">)</span>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a>            <span class="k">class</span><span class="w"> </span><span class="nc">LoRAWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a>                <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">original</span><span class="p">,</span> <span class="n">lora</span><span class="p">):</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>                    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">original</span> <span class="o">=</span> <span class="n">original</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">lora</span> <span class="o">=</span> <span class="n">lora</span>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a>
<a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>                <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a>                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">original</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">lora</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a>
<a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a>            <span class="n">wrapped_layer</span> <span class="o">=</span> <span class="n">LoRAWrapper</span><span class="p">(</span><span class="n">original_layer</span><span class="p">,</span> <span class="n">lora_layer</span><span class="p">)</span>
<a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a>            <span class="nb">setattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_name</span><span class="p">,</span> <span class="n">wrapped_layer</span><span class="p">)</span>
<a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>
<a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a>        <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a>
<a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>    <span class="nd">@staticmethod</span>
<a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">count_trainable_parameters</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;訓練可能なパラメータ数をカウント&quot;&quot;&quot;</span>
<a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>        <span class="n">total_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>
<a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a>        <span class="n">trainable_params</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">)</span>
<a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a>        <span class="k">return</span> <span class="n">trainable_params</span><span class="p">,</span> <span class="n">total_params</span>
<a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a>
<a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a><span class="k">class</span><span class="w"> </span><span class="nc">ClassificationDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
<a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;テキスト分類用データセット&quot;&quot;&quot;</span>
<a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a>
<a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> 
<a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a>                 <span class="n">tokenizer</span><span class="p">,</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">):</span>
<a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">texts</span> <span class="o">=</span> <span class="n">texts</span>
<a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>
<a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">=</span> <span class="n">max_length</span>
<a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a>
<a id="__codelineno-3-114" name="__codelineno-3-114" href="#__codelineno-3-114"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-3-115" name="__codelineno-3-115" href="#__codelineno-3-115"></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">)</span>
<a id="__codelineno-3-116" name="__codelineno-3-116" href="#__codelineno-3-116"></a>
<a id="__codelineno-3-117" name="__codelineno-3-117" href="#__codelineno-3-117"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
<a id="__codelineno-3-118" name="__codelineno-3-118" href="#__codelineno-3-118"></a>        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-3-119" name="__codelineno-3-119" href="#__codelineno-3-119"></a>        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
<a id="__codelineno-3-120" name="__codelineno-3-120" href="#__codelineno-3-120"></a>
<a id="__codelineno-3-121" name="__codelineno-3-121" href="#__codelineno-3-121"></a>        <span class="c1"># トークン化</span>
<a id="__codelineno-3-122" name="__codelineno-3-122" href="#__codelineno-3-122"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-3-123" name="__codelineno-3-123" href="#__codelineno-3-123"></a>
<a id="__codelineno-3-124" name="__codelineno-3-124" href="#__codelineno-3-124"></a>        <span class="c1"># パディング/トランケート</span>
<a id="__codelineno-3-125" name="__codelineno-3-125" href="#__codelineno-3-125"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">:</span>
<a id="__codelineno-3-126" name="__codelineno-3-126" href="#__codelineno-3-126"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span><span class="p">]</span>
<a id="__codelineno-3-127" name="__codelineno-3-127" href="#__codelineno-3-127"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-3-128" name="__codelineno-3-128" href="#__codelineno-3-128"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
<a id="__codelineno-3-129" name="__codelineno-3-129" href="#__codelineno-3-129"></a>
<a id="__codelineno-3-130" name="__codelineno-3-130" href="#__codelineno-3-130"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-3-131" name="__codelineno-3-131" href="#__codelineno-3-131"></a>            <span class="s1">&#39;input_ids&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">),</span>
<a id="__codelineno-3-132" name="__codelineno-3-132" href="#__codelineno-3-132"></a>            <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">)</span>
<a id="__codelineno-3-133" name="__codelineno-3-133" href="#__codelineno-3-133"></a>        <span class="p">}</span>
<a id="__codelineno-3-134" name="__codelineno-3-134" href="#__codelineno-3-134"></a>
<a id="__codelineno-3-135" name="__codelineno-3-135" href="#__codelineno-3-135"></a><span class="k">class</span><span class="w"> </span><span class="nc">FineTuningTrainer</span><span class="p">:</span>
<a id="__codelineno-3-136" name="__codelineno-3-136" href="#__codelineno-3-136"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ファインチューニング用トレーナー&quot;&quot;&quot;</span>
<a id="__codelineno-3-137" name="__codelineno-3-137" href="#__codelineno-3-137"></a>
<a id="__codelineno-3-138" name="__codelineno-3-138" href="#__codelineno-3-138"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pretrained_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span><span class="p">):</span>
<a id="__codelineno-3-139" name="__codelineno-3-139" href="#__codelineno-3-139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span> <span class="o">=</span> <span class="n">strategy</span>
<a id="__codelineno-3-140" name="__codelineno-3-140" href="#__codelineno-3-140"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
<a id="__codelineno-3-141" name="__codelineno-3-141" href="#__codelineno-3-141"></a>
<a id="__codelineno-3-142" name="__codelineno-3-142" href="#__codelineno-3-142"></a>        <span class="c1"># 分類ヘッドを追加</span>
<a id="__codelineno-3-143" name="__codelineno-3-143" href="#__codelineno-3-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_model_for_classification</span><span class="p">(</span>
<a id="__codelineno-3-144" name="__codelineno-3-144" href="#__codelineno-3-144"></a>            <span class="n">pretrained_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">strategy</span>
<a id="__codelineno-3-145" name="__codelineno-3-145" href="#__codelineno-3-145"></a>        <span class="p">)</span>
<a id="__codelineno-3-146" name="__codelineno-3-146" href="#__codelineno-3-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-147" name="__codelineno-3-147" href="#__codelineno-3-147"></a>
<a id="__codelineno-3-148" name="__codelineno-3-148" href="#__codelineno-3-148"></a>        <span class="c1"># パラメータ数を表示</span>
<a id="__codelineno-3-149" name="__codelineno-3-149" href="#__codelineno-3-149"></a>        <span class="n">trainable</span><span class="p">,</span> <span class="n">total</span> <span class="o">=</span> <span class="n">FineTuningStrategies</span><span class="o">.</span><span class="n">count_trainable_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-3-150" name="__codelineno-3-150" href="#__codelineno-3-150"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Strategy: </span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-3-151" name="__codelineno-3-151" href="#__codelineno-3-151"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trainable parameters: </span><span class="si">{</span><span class="n">trainable</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-3-152" name="__codelineno-3-152" href="#__codelineno-3-152"></a>              <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">trainable</span><span class="o">/</span><span class="n">total</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
<a id="__codelineno-3-153" name="__codelineno-3-153" href="#__codelineno-3-153"></a>
<a id="__codelineno-3-154" name="__codelineno-3-154" href="#__codelineno-3-154"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_model_for_classification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
<a id="__codelineno-3-155" name="__codelineno-3-155" href="#__codelineno-3-155"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;分類用にモデルを準備&quot;&quot;&quot;</span>
<a id="__codelineno-3-156" name="__codelineno-3-156" href="#__codelineno-3-156"></a>
<a id="__codelineno-3-157" name="__codelineno-3-157" href="#__codelineno-3-157"></a>        <span class="k">class</span><span class="w"> </span><span class="nc">ClassificationModel</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<a id="__codelineno-3-158" name="__codelineno-3-158" href="#__codelineno-3-158"></a>            <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
<a id="__codelineno-3-159" name="__codelineno-3-159" href="#__codelineno-3-159"></a>                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<a id="__codelineno-3-160" name="__codelineno-3-160" href="#__codelineno-3-160"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">base_model</span>
<a id="__codelineno-3-161" name="__codelineno-3-161" href="#__codelineno-3-161"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
<a id="__codelineno-3-162" name="__codelineno-3-162" href="#__codelineno-3-162"></a>
<a id="__codelineno-3-163" name="__codelineno-3-163" href="#__codelineno-3-163"></a>                <span class="c1"># 分類ヘッド</span>
<a id="__codelineno-3-164" name="__codelineno-3-164" href="#__codelineno-3-164"></a>                <span class="n">hidden_size</span> <span class="o">=</span> <span class="n">base_model</span><span class="o">.</span><span class="n">d_model</span>
<a id="__codelineno-3-165" name="__codelineno-3-165" href="#__codelineno-3-165"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_size</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-3-166" name="__codelineno-3-166" href="#__codelineno-3-166"></a>
<a id="__codelineno-3-167" name="__codelineno-3-167" href="#__codelineno-3-167"></a>            <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">):</span>
<a id="__codelineno-3-168" name="__codelineno-3-168" href="#__codelineno-3-168"></a>                <span class="c1"># ベースモデルの出力を取得</span>
<a id="__codelineno-3-169" name="__codelineno-3-169" href="#__codelineno-3-169"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>  <span class="c1"># [batch, seq_len, hidden]</span>
<a id="__codelineno-3-170" name="__codelineno-3-170" href="#__codelineno-3-170"></a>
<a id="__codelineno-3-171" name="__codelineno-3-171" href="#__codelineno-3-171"></a>                <span class="c1"># 最初のトークン（[CLS]トークンの代わり）を使用</span>
<a id="__codelineno-3-172" name="__codelineno-3-172" href="#__codelineno-3-172"></a>                <span class="n">pooled_output</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-3-173" name="__codelineno-3-173" href="#__codelineno-3-173"></a>                <span class="n">pooled_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span><span class="p">(</span><span class="n">pooled_output</span><span class="p">)</span>
<a id="__codelineno-3-174" name="__codelineno-3-174" href="#__codelineno-3-174"></a>
<a id="__codelineno-3-175" name="__codelineno-3-175" href="#__codelineno-3-175"></a>                <span class="c1"># 分類</span>
<a id="__codelineno-3-176" name="__codelineno-3-176" href="#__codelineno-3-176"></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">pooled_output</span><span class="p">)</span>
<a id="__codelineno-3-177" name="__codelineno-3-177" href="#__codelineno-3-177"></a>                <span class="k">return</span> <span class="n">logits</span>
<a id="__codelineno-3-178" name="__codelineno-3-178" href="#__codelineno-3-178"></a>
<a id="__codelineno-3-179" name="__codelineno-3-179" href="#__codelineno-3-179"></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">ClassificationModel</span><span class="p">(</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">base_model</span><span class="p">),</span> <span class="n">num_classes</span><span class="p">)</span>
<a id="__codelineno-3-180" name="__codelineno-3-180" href="#__codelineno-3-180"></a>
<a id="__codelineno-3-181" name="__codelineno-3-181" href="#__codelineno-3-181"></a>        <span class="c1"># 戦略に応じてパラメータを調整</span>
<a id="__codelineno-3-182" name="__codelineno-3-182" href="#__codelineno-3-182"></a>        <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;last_layer&#39;</span><span class="p">:</span>
<a id="__codelineno-3-183" name="__codelineno-3-183" href="#__codelineno-3-183"></a>            <span class="n">model</span> <span class="o">=</span> <span class="n">FineTuningStrategies</span><span class="o">.</span><span class="n">freeze_all_but_last</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<a id="__codelineno-3-184" name="__codelineno-3-184" href="#__codelineno-3-184"></a>            <span class="c1"># 分類ヘッドも訓練可能にする</span>
<a id="__codelineno-3-185" name="__codelineno-3-185" href="#__codelineno-3-185"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-3-186" name="__codelineno-3-186" href="#__codelineno-3-186"></a>                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-3-187" name="__codelineno-3-187" href="#__codelineno-3-187"></a>
<a id="__codelineno-3-188" name="__codelineno-3-188" href="#__codelineno-3-188"></a>        <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;lora&#39;</span><span class="p">:</span>
<a id="__codelineno-3-189" name="__codelineno-3-189" href="#__codelineno-3-189"></a>            <span class="n">model</span><span class="o">.</span><span class="n">base_model</span> <span class="o">=</span> <span class="n">FineTuningStrategies</span><span class="o">.</span><span class="n">apply_lora</span><span class="p">(</span>
<a id="__codelineno-3-190" name="__codelineno-3-190" href="#__codelineno-3-190"></a>                <span class="n">model</span><span class="o">.</span><span class="n">base_model</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">16</span>
<a id="__codelineno-3-191" name="__codelineno-3-191" href="#__codelineno-3-191"></a>            <span class="p">)</span>
<a id="__codelineno-3-192" name="__codelineno-3-192" href="#__codelineno-3-192"></a>            <span class="c1"># 分類ヘッドは訓練可能</span>
<a id="__codelineno-3-193" name="__codelineno-3-193" href="#__codelineno-3-193"></a>            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">():</span>
<a id="__codelineno-3-194" name="__codelineno-3-194" href="#__codelineno-3-194"></a>                <span class="n">param</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-3-195" name="__codelineno-3-195" href="#__codelineno-3-195"></a>
<a id="__codelineno-3-196" name="__codelineno-3-196" href="#__codelineno-3-196"></a>        <span class="c1"># strategy == &#39;full&#39; の場合はすべて訓練可能</span>
<a id="__codelineno-3-197" name="__codelineno-3-197" href="#__codelineno-3-197"></a>
<a id="__codelineno-3-198" name="__codelineno-3-198" href="#__codelineno-3-198"></a>        <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-3-199" name="__codelineno-3-199" href="#__codelineno-3-199"></a>
<a id="__codelineno-3-200" name="__codelineno-3-200" href="#__codelineno-3-200"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
<a id="__codelineno-3-201" name="__codelineno-3-201" href="#__codelineno-3-201"></a>             <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">2e-5</span><span class="p">):</span>
<a id="__codelineno-3-202" name="__codelineno-3-202" href="#__codelineno-3-202"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;ファインチューニングの実行&quot;&quot;&quot;</span>
<a id="__codelineno-3-203" name="__codelineno-3-203" href="#__codelineno-3-203"></a>
<a id="__codelineno-3-204" name="__codelineno-3-204" href="#__codelineno-3-204"></a>        <span class="c1"># データローダー</span>
<a id="__codelineno-3-205" name="__codelineno-3-205" href="#__codelineno-3-205"></a>        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-3-206" name="__codelineno-3-206" href="#__codelineno-3-206"></a>        <span class="n">val_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-3-207" name="__codelineno-3-207" href="#__codelineno-3-207"></a>
<a id="__codelineno-3-208" name="__codelineno-3-208" href="#__codelineno-3-208"></a>        <span class="c1"># オプティマイザ（訓練可能なパラメータのみ）</span>
<a id="__codelineno-3-209" name="__codelineno-3-209" href="#__codelineno-3-209"></a>        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span>
<a id="__codelineno-3-210" name="__codelineno-3-210" href="#__codelineno-3-210"></a>            <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">],</span>
<a id="__codelineno-3-211" name="__codelineno-3-211" href="#__codelineno-3-211"></a>            <span class="n">lr</span><span class="o">=</span><span class="n">learning_rate</span><span class="p">,</span>
<a id="__codelineno-3-212" name="__codelineno-3-212" href="#__codelineno-3-212"></a>            <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.01</span>
<a id="__codelineno-3-213" name="__codelineno-3-213" href="#__codelineno-3-213"></a>        <span class="p">)</span>
<a id="__codelineno-3-214" name="__codelineno-3-214" href="#__codelineno-3-214"></a>
<a id="__codelineno-3-215" name="__codelineno-3-215" href="#__codelineno-3-215"></a>        <span class="c1"># 損失関数</span>
<a id="__codelineno-3-216" name="__codelineno-3-216" href="#__codelineno-3-216"></a>        <span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<a id="__codelineno-3-217" name="__codelineno-3-217" href="#__codelineno-3-217"></a>
<a id="__codelineno-3-218" name="__codelineno-3-218" href="#__codelineno-3-218"></a>        <span class="c1"># 訓練履歴</span>
<a id="__codelineno-3-219" name="__codelineno-3-219" href="#__codelineno-3-219"></a>        <span class="n">history</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;train_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;train_acc&#39;</span><span class="p">:</span> <span class="p">[],</span> 
<a id="__codelineno-3-220" name="__codelineno-3-220" href="#__codelineno-3-220"></a>                  <span class="s1">&#39;val_loss&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;val_acc&#39;</span><span class="p">:</span> <span class="p">[]}</span>
<a id="__codelineno-3-221" name="__codelineno-3-221" href="#__codelineno-3-221"></a>
<a id="__codelineno-3-222" name="__codelineno-3-222" href="#__codelineno-3-222"></a>        <span class="c1"># 訓練ループ</span>
<a id="__codelineno-3-223" name="__codelineno-3-223" href="#__codelineno-3-223"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
<a id="__codelineno-3-224" name="__codelineno-3-224" href="#__codelineno-3-224"></a>            <span class="c1"># 訓練</span>
<a id="__codelineno-3-225" name="__codelineno-3-225" href="#__codelineno-3-225"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<a id="__codelineno-3-226" name="__codelineno-3-226" href="#__codelineno-3-226"></a>            <span class="n">train_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-227" name="__codelineno-3-227" href="#__codelineno-3-227"></a>            <span class="n">train_correct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-228" name="__codelineno-3-228" href="#__codelineno-3-228"></a>            <span class="n">train_total</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-229" name="__codelineno-3-229" href="#__codelineno-3-229"></a>
<a id="__codelineno-3-230" name="__codelineno-3-230" href="#__codelineno-3-230"></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">train_loader</span><span class="p">:</span>
<a id="__codelineno-3-231" name="__codelineno-3-231" href="#__codelineno-3-231"></a>                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-232" name="__codelineno-3-232" href="#__codelineno-3-232"></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-233" name="__codelineno-3-233" href="#__codelineno-3-233"></a>
<a id="__codelineno-3-234" name="__codelineno-3-234" href="#__codelineno-3-234"></a>                <span class="c1"># 順伝播</span>
<a id="__codelineno-3-235" name="__codelineno-3-235" href="#__codelineno-3-235"></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-3-236" name="__codelineno-3-236" href="#__codelineno-3-236"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-3-237" name="__codelineno-3-237" href="#__codelineno-3-237"></a>
<a id="__codelineno-3-238" name="__codelineno-3-238" href="#__codelineno-3-238"></a>                <span class="c1"># 逆伝播</span>
<a id="__codelineno-3-239" name="__codelineno-3-239" href="#__codelineno-3-239"></a>                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
<a id="__codelineno-3-240" name="__codelineno-3-240" href="#__codelineno-3-240"></a>                <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<a id="__codelineno-3-241" name="__codelineno-3-241" href="#__codelineno-3-241"></a>                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clip_grad_norm_</span><span class="p">(</span>
<a id="__codelineno-3-242" name="__codelineno-3-242" href="#__codelineno-3-242"></a>                    <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">],</span> 
<a id="__codelineno-3-243" name="__codelineno-3-243" href="#__codelineno-3-243"></a>                    <span class="n">max_norm</span><span class="o">=</span><span class="mf">1.0</span>
<a id="__codelineno-3-244" name="__codelineno-3-244" href="#__codelineno-3-244"></a>                <span class="p">)</span>
<a id="__codelineno-3-245" name="__codelineno-3-245" href="#__codelineno-3-245"></a>                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
<a id="__codelineno-3-246" name="__codelineno-3-246" href="#__codelineno-3-246"></a>
<a id="__codelineno-3-247" name="__codelineno-3-247" href="#__codelineno-3-247"></a>                <span class="c1"># 統計</span>
<a id="__codelineno-3-248" name="__codelineno-3-248" href="#__codelineno-3-248"></a>                <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-249" name="__codelineno-3-249" href="#__codelineno-3-249"></a>                <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-250" name="__codelineno-3-250" href="#__codelineno-3-250"></a>                <span class="n">train_correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-251" name="__codelineno-3-251" href="#__codelineno-3-251"></a>                <span class="n">train_total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-252" name="__codelineno-3-252" href="#__codelineno-3-252"></a>
<a id="__codelineno-3-253" name="__codelineno-3-253" href="#__codelineno-3-253"></a>            <span class="c1"># 検証</span>
<a id="__codelineno-3-254" name="__codelineno-3-254" href="#__codelineno-3-254"></a>            <span class="n">val_loss</span><span class="p">,</span> <span class="n">val_acc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">val_loader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">)</span>
<a id="__codelineno-3-255" name="__codelineno-3-255" href="#__codelineno-3-255"></a>
<a id="__codelineno-3-256" name="__codelineno-3-256" href="#__codelineno-3-256"></a>            <span class="c1"># 記録</span>
<a id="__codelineno-3-257" name="__codelineno-3-257" href="#__codelineno-3-257"></a>            <span class="n">train_acc</span> <span class="o">=</span> <span class="n">train_correct</span> <span class="o">/</span> <span class="n">train_total</span>
<a id="__codelineno-3-258" name="__codelineno-3-258" href="#__codelineno-3-258"></a>            <span class="n">avg_train_loss</span> <span class="o">=</span> <span class="n">train_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span>
<a id="__codelineno-3-259" name="__codelineno-3-259" href="#__codelineno-3-259"></a>
<a id="__codelineno-3-260" name="__codelineno-3-260" href="#__codelineno-3-260"></a>            <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_train_loss</span><span class="p">)</span>
<a id="__codelineno-3-261" name="__codelineno-3-261" href="#__codelineno-3-261"></a>            <span class="n">history</span><span class="p">[</span><span class="s1">&#39;train_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_acc</span><span class="p">)</span>
<a id="__codelineno-3-262" name="__codelineno-3-262" href="#__codelineno-3-262"></a>            <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_loss</span><span class="p">)</span>
<a id="__codelineno-3-263" name="__codelineno-3-263" href="#__codelineno-3-263"></a>            <span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val_acc</span><span class="p">)</span>
<a id="__codelineno-3-264" name="__codelineno-3-264" href="#__codelineno-3-264"></a>
<a id="__codelineno-3-265" name="__codelineno-3-265" href="#__codelineno-3-265"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">num_epochs</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<a id="__codelineno-3-266" name="__codelineno-3-266" href="#__codelineno-3-266"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Train Loss: </span><span class="si">{</span><span class="n">avg_train_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Train Acc: </span><span class="si">{</span><span class="n">train_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-3-267" name="__codelineno-3-267" href="#__codelineno-3-267"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Val Loss: </span><span class="si">{</span><span class="n">val_loss</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Val Acc: </span><span class="si">{</span><span class="n">val_acc</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-3-268" name="__codelineno-3-268" href="#__codelineno-3-268"></a>
<a id="__codelineno-3-269" name="__codelineno-3-269" href="#__codelineno-3-269"></a>        <span class="k">return</span> <span class="n">history</span>
<a id="__codelineno-3-270" name="__codelineno-3-270" href="#__codelineno-3-270"></a>
<a id="__codelineno-3-271" name="__codelineno-3-271" href="#__codelineno-3-271"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">criterion</span><span class="p">):</span>
<a id="__codelineno-3-272" name="__codelineno-3-272" href="#__codelineno-3-272"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;モデルの評価&quot;&quot;&quot;</span>
<a id="__codelineno-3-273" name="__codelineno-3-273" href="#__codelineno-3-273"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-3-274" name="__codelineno-3-274" href="#__codelineno-3-274"></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-275" name="__codelineno-3-275" href="#__codelineno-3-275"></a>        <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-276" name="__codelineno-3-276" href="#__codelineno-3-276"></a>        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-3-277" name="__codelineno-3-277" href="#__codelineno-3-277"></a>
<a id="__codelineno-3-278" name="__codelineno-3-278" href="#__codelineno-3-278"></a>        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-3-279" name="__codelineno-3-279" href="#__codelineno-3-279"></a>            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
<a id="__codelineno-3-280" name="__codelineno-3-280" href="#__codelineno-3-280"></a>                <span class="n">input_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-281" name="__codelineno-3-281" href="#__codelineno-3-281"></a>                <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-3-282" name="__codelineno-3-282" href="#__codelineno-3-282"></a>
<a id="__codelineno-3-283" name="__codelineno-3-283" href="#__codelineno-3-283"></a>                <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_ids</span><span class="p">)</span>
<a id="__codelineno-3-284" name="__codelineno-3-284" href="#__codelineno-3-284"></a>                <span class="n">loss</span> <span class="o">=</span> <span class="n">criterion</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a id="__codelineno-3-285" name="__codelineno-3-285" href="#__codelineno-3-285"></a>
<a id="__codelineno-3-286" name="__codelineno-3-286" href="#__codelineno-3-286"></a>                <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-287" name="__codelineno-3-287" href="#__codelineno-3-287"></a>                <span class="n">_</span><span class="p">,</span> <span class="n">predicted</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-3-288" name="__codelineno-3-288" href="#__codelineno-3-288"></a>                <span class="n">correct</span> <span class="o">+=</span> <span class="p">(</span><span class="n">predicted</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-3-289" name="__codelineno-3-289" href="#__codelineno-3-289"></a>                <span class="n">total</span> <span class="o">+=</span> <span class="n">labels</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-3-290" name="__codelineno-3-290" href="#__codelineno-3-290"></a>
<a id="__codelineno-3-291" name="__codelineno-3-291" href="#__codelineno-3-291"></a>        <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">total_loss</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">)</span>
<a id="__codelineno-3-292" name="__codelineno-3-292" href="#__codelineno-3-292"></a>        <span class="n">accuracy</span> <span class="o">=</span> <span class="n">correct</span> <span class="o">/</span> <span class="n">total</span>
<a id="__codelineno-3-293" name="__codelineno-3-293" href="#__codelineno-3-293"></a>
<a id="__codelineno-3-294" name="__codelineno-3-294" href="#__codelineno-3-294"></a>        <span class="k">return</span> <span class="n">avg_loss</span><span class="p">,</span> <span class="n">accuracy</span>
<a id="__codelineno-3-295" name="__codelineno-3-295" href="#__codelineno-3-295"></a>
<a id="__codelineno-3-296" name="__codelineno-3-296" href="#__codelineno-3-296"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_finetuning_strategies</span><span class="p">():</span>
<a id="__codelineno-3-297" name="__codelineno-3-297" href="#__codelineno-3-297"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;ファインチューニング戦略の比較&quot;&quot;&quot;</span>
<a id="__codelineno-3-298" name="__codelineno-3-298" href="#__codelineno-3-298"></a>
<a id="__codelineno-3-299" name="__codelineno-3-299" href="#__codelineno-3-299"></a>    <span class="c1"># ダミーの分類データ</span>
<a id="__codelineno-3-300" name="__codelineno-3-300" href="#__codelineno-3-300"></a>    <span class="n">positive_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-301" name="__codelineno-3-301" href="#__codelineno-3-301"></a>        <span class="s2">&quot;This movie is fantastic! I loved every minute of it.&quot;</span><span class="p">,</span>
<a id="__codelineno-3-302" name="__codelineno-3-302" href="#__codelineno-3-302"></a>        <span class="s2">&quot;Amazing performance by the actors. Highly recommended!&quot;</span><span class="p">,</span>
<a id="__codelineno-3-303" name="__codelineno-3-303" href="#__codelineno-3-303"></a>        <span class="s2">&quot;Best film I&#39;ve seen this year. Absolutely brilliant!&quot;</span><span class="p">,</span>
<a id="__codelineno-3-304" name="__codelineno-3-304" href="#__codelineno-3-304"></a>    <span class="p">]</span> <span class="o">*</span> <span class="mi">50</span>
<a id="__codelineno-3-305" name="__codelineno-3-305" href="#__codelineno-3-305"></a>
<a id="__codelineno-3-306" name="__codelineno-3-306" href="#__codelineno-3-306"></a>    <span class="n">negative_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-3-307" name="__codelineno-3-307" href="#__codelineno-3-307"></a>        <span class="s2">&quot;Terrible movie. Complete waste of time.&quot;</span><span class="p">,</span>
<a id="__codelineno-3-308" name="__codelineno-3-308" href="#__codelineno-3-308"></a>        <span class="s2">&quot;Boring plot and bad acting. Very disappointed.&quot;</span><span class="p">,</span>
<a id="__codelineno-3-309" name="__codelineno-3-309" href="#__codelineno-3-309"></a>        <span class="s2">&quot;One of the worst films I&#39;ve ever seen.&quot;</span><span class="p">,</span>
<a id="__codelineno-3-310" name="__codelineno-3-310" href="#__codelineno-3-310"></a>    <span class="p">]</span> <span class="o">*</span> <span class="mi">50</span>
<a id="__codelineno-3-311" name="__codelineno-3-311" href="#__codelineno-3-311"></a>
<a id="__codelineno-3-312" name="__codelineno-3-312" href="#__codelineno-3-312"></a>    <span class="c1"># データセット作成</span>
<a id="__codelineno-3-313" name="__codelineno-3-313" href="#__codelineno-3-313"></a>    <span class="n">texts</span> <span class="o">=</span> <span class="n">positive_texts</span> <span class="o">+</span> <span class="n">negative_texts</span>
<a id="__codelineno-3-314" name="__codelineno-3-314" href="#__codelineno-3-314"></a>    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">positive_texts</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">negative_texts</span><span class="p">)</span>
<a id="__codelineno-3-315" name="__codelineno-3-315" href="#__codelineno-3-315"></a>
<a id="__codelineno-3-316" name="__codelineno-3-316" href="#__codelineno-3-316"></a>    <span class="c1"># シャッフル</span>
<a id="__codelineno-3-317" name="__codelineno-3-317" href="#__codelineno-3-317"></a>    <span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<a id="__codelineno-3-318" name="__codelineno-3-318" href="#__codelineno-3-318"></a>    <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">texts</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
<a id="__codelineno-3-319" name="__codelineno-3-319" href="#__codelineno-3-319"></a>    <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-3-320" name="__codelineno-3-320" href="#__codelineno-3-320"></a>    <span class="n">texts</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-3-321" name="__codelineno-3-321" href="#__codelineno-3-321"></a>
<a id="__codelineno-3-322" name="__codelineno-3-322" href="#__codelineno-3-322"></a>    <span class="c1"># 訓練/検証分割</span>
<a id="__codelineno-3-323" name="__codelineno-3-323" href="#__codelineno-3-323"></a>    <span class="n">split_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.8</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">texts</span><span class="p">))</span>
<a id="__codelineno-3-324" name="__codelineno-3-324" href="#__codelineno-3-324"></a>    <span class="n">train_texts</span><span class="p">,</span> <span class="n">val_texts</span> <span class="o">=</span> <span class="n">texts</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">texts</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<a id="__codelineno-3-325" name="__codelineno-3-325" href="#__codelineno-3-325"></a>    <span class="n">train_labels</span><span class="p">,</span> <span class="n">val_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[:</span><span class="n">split_idx</span><span class="p">],</span> <span class="n">labels</span><span class="p">[</span><span class="n">split_idx</span><span class="p">:]</span>
<a id="__codelineno-3-326" name="__codelineno-3-326" href="#__codelineno-3-326"></a>
<a id="__codelineno-3-327" name="__codelineno-3-327" href="#__codelineno-3-327"></a>    <span class="c1"># トークナイザーとデータセット</span>
<a id="__codelineno-3-328" name="__codelineno-3-328" href="#__codelineno-3-328"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SimpleTokenizer</span><span class="p">()</span>
<a id="__codelineno-3-329" name="__codelineno-3-329" href="#__codelineno-3-329"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">ClassificationDataset</span><span class="p">(</span><span class="n">train_texts</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-3-330" name="__codelineno-3-330" href="#__codelineno-3-330"></a>    <span class="n">val_dataset</span> <span class="o">=</span> <span class="n">ClassificationDataset</span><span class="p">(</span><span class="n">val_texts</span><span class="p">,</span> <span class="n">val_labels</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-3-331" name="__codelineno-3-331" href="#__codelineno-3-331"></a>
<a id="__codelineno-3-332" name="__codelineno-3-332" href="#__codelineno-3-332"></a>    <span class="c1"># 事前学習済みモデル（前の問題で作成したもの）</span>
<a id="__codelineno-3-333" name="__codelineno-3-333" href="#__codelineno-3-333"></a>    <span class="n">pretrained_model</span> <span class="o">=</span> <span class="n">GPTWithPositionalEncoding</span><span class="p">(</span>
<a id="__codelineno-3-334" name="__codelineno-3-334" href="#__codelineno-3-334"></a>        <span class="n">vocab_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">),</span>
<a id="__codelineno-3-335" name="__codelineno-3-335" href="#__codelineno-3-335"></a>        <span class="n">d_model</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-3-336" name="__codelineno-3-336" href="#__codelineno-3-336"></a>        <span class="n">n_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-3-337" name="__codelineno-3-337" href="#__codelineno-3-337"></a>        <span class="n">n_layers</span><span class="o">=</span><span class="mi">2</span>
<a id="__codelineno-3-338" name="__codelineno-3-338" href="#__codelineno-3-338"></a>    <span class="p">)</span>
<a id="__codelineno-3-339" name="__codelineno-3-339" href="#__codelineno-3-339"></a>
<a id="__codelineno-3-340" name="__codelineno-3-340" href="#__codelineno-3-340"></a>    <span class="c1"># 各戦略でファインチューニング</span>
<a id="__codelineno-3-341" name="__codelineno-3-341" href="#__codelineno-3-341"></a>    <span class="n">strategies</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="s1">&#39;last_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;lora&#39;</span><span class="p">]</span>
<a id="__codelineno-3-342" name="__codelineno-3-342" href="#__codelineno-3-342"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-3-343" name="__codelineno-3-343" href="#__codelineno-3-343"></a>
<a id="__codelineno-3-344" name="__codelineno-3-344" href="#__codelineno-3-344"></a>    <span class="k">for</span> <span class="n">strategy</span> <span class="ow">in</span> <span class="n">strategies</span><span class="p">:</span>
<a id="__codelineno-3-345" name="__codelineno-3-345" href="#__codelineno-3-345"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== </span><span class="si">{</span><span class="n">strategy</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2"> Fine-tuning ===&quot;</span><span class="p">)</span>
<a id="__codelineno-3-346" name="__codelineno-3-346" href="#__codelineno-3-346"></a>
<a id="__codelineno-3-347" name="__codelineno-3-347" href="#__codelineno-3-347"></a>        <span class="n">trainer</span> <span class="o">=</span> <span class="n">FineTuningTrainer</span><span class="p">(</span><span class="n">pretrained_model</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">)</span>
<a id="__codelineno-3-348" name="__codelineno-3-348" href="#__codelineno-3-348"></a>        <span class="n">history</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
<a id="__codelineno-3-349" name="__codelineno-3-349" href="#__codelineno-3-349"></a>            <span class="n">train_dataset</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span>
<a id="__codelineno-3-350" name="__codelineno-3-350" href="#__codelineno-3-350"></a>            <span class="n">num_epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
<a id="__codelineno-3-351" name="__codelineno-3-351" href="#__codelineno-3-351"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
<a id="__codelineno-3-352" name="__codelineno-3-352" href="#__codelineno-3-352"></a>            <span class="n">learning_rate</span><span class="o">=</span><span class="mf">2e-5</span> <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span> <span class="k">else</span> <span class="mf">5e-4</span>
<a id="__codelineno-3-353" name="__codelineno-3-353" href="#__codelineno-3-353"></a>        <span class="p">)</span>
<a id="__codelineno-3-354" name="__codelineno-3-354" href="#__codelineno-3-354"></a>
<a id="__codelineno-3-355" name="__codelineno-3-355" href="#__codelineno-3-355"></a>        <span class="n">results</span><span class="p">[</span><span class="n">strategy</span><span class="p">]</span> <span class="o">=</span> <span class="n">history</span>
<a id="__codelineno-3-356" name="__codelineno-3-356" href="#__codelineno-3-356"></a>
<a id="__codelineno-3-357" name="__codelineno-3-357" href="#__codelineno-3-357"></a>    <span class="c1"># 結果の可視化</span>
<a id="__codelineno-3-358" name="__codelineno-3-358" href="#__codelineno-3-358"></a>    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-3-359" name="__codelineno-3-359" href="#__codelineno-3-359"></a>
<a id="__codelineno-3-360" name="__codelineno-3-360" href="#__codelineno-3-360"></a>    <span class="k">for</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">history</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-3-361" name="__codelineno-3-361" href="#__codelineno-3-361"></a>        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_loss&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s1"> - Val Loss&#39;</span><span class="p">)</span>
<a id="__codelineno-3-362" name="__codelineno-3-362" href="#__codelineno-3-362"></a>        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">history</span><span class="p">[</span><span class="s1">&#39;val_acc&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strategy</span><span class="si">}</span><span class="s1"> - Val Acc&#39;</span><span class="p">)</span>
<a id="__codelineno-3-363" name="__codelineno-3-363" href="#__codelineno-3-363"></a>
<a id="__codelineno-3-364" name="__codelineno-3-364" href="#__codelineno-3-364"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<a id="__codelineno-3-365" name="__codelineno-3-365" href="#__codelineno-3-365"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Loss&#39;</span><span class="p">)</span>
<a id="__codelineno-3-366" name="__codelineno-3-366" href="#__codelineno-3-366"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation Loss Comparison&#39;</span><span class="p">)</span>
<a id="__codelineno-3-367" name="__codelineno-3-367" href="#__codelineno-3-367"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-3-368" name="__codelineno-3-368" href="#__codelineno-3-368"></a>    <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-3-369" name="__codelineno-3-369" href="#__codelineno-3-369"></a>
<a id="__codelineno-3-370" name="__codelineno-3-370" href="#__codelineno-3-370"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Epoch&#39;</span><span class="p">)</span>
<a id="__codelineno-3-371" name="__codelineno-3-371" href="#__codelineno-3-371"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">)</span>
<a id="__codelineno-3-372" name="__codelineno-3-372" href="#__codelineno-3-372"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Validation Accuracy Comparison&#39;</span><span class="p">)</span>
<a id="__codelineno-3-373" name="__codelineno-3-373" href="#__codelineno-3-373"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-3-374" name="__codelineno-3-374" href="#__codelineno-3-374"></a>    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-3-375" name="__codelineno-3-375" href="#__codelineno-3-375"></a>
<a id="__codelineno-3-376" name="__codelineno-3-376" href="#__codelineno-3-376"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-3-377" name="__codelineno-3-377" href="#__codelineno-3-377"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-3-378" name="__codelineno-3-378" href="#__codelineno-3-378"></a>
<a id="__codelineno-3-379" name="__codelineno-3-379" href="#__codelineno-3-379"></a>    <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-3-380" name="__codelineno-3-380" href="#__codelineno-3-380"></a>
<a id="__codelineno-3-381" name="__codelineno-3-381" href="#__codelineno-3-381"></a><span class="c1"># 比較実行</span>
<a id="__codelineno-3-382" name="__codelineno-3-382" href="#__codelineno-3-382"></a><span class="n">results</span> <span class="o">=</span> <span class="n">compare_finetuning_strategies</span><span class="p">()</span>
</code></pre></div>
</details>
<h2 id="53">演習 5.3: トークナイザーの詳細<a class="headerlink" href="#53" title="Permanent link">&para;</a></h2>
<h3 id="5_1">問題 5<a class="headerlink" href="#5_1" title="Permanent link">&para;</a></h3>
<p>BPE（Byte Pair Encoding）トークナイザーを完全実装してください。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="k">class</span><span class="w"> </span><span class="nc">BPETokenizer</span><span class="p">:</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Byte Pair Encoding トークナイザーの完全実装&quot;&quot;&quot;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span> <span class="o">=</span> <span class="n">min_frequency</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>        <span class="c1"># 特殊トークン</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;pad&gt;&#39;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;bos&gt;&#39;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;eos&gt;&#39;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>        <span class="c1"># 語彙</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\w+|[^\w\s]&#39;</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">merges</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">word_freq</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;BPEモデルの訓練&quot;&quot;&quot;</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training BPE tokenizer...&quot;</span><span class="p">)</span>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>        <span class="c1"># 1. 単語頻度をカウント</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>            <span class="n">words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">word_freq</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="c1"># 2. 単語を文字に分割（終端記号付き）</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>        <span class="n">word_splits</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_freq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a>            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span><span class="p">:</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a>                <span class="n">word_splits</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&lt;/w&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a>        <span class="c1"># 3. 初期語彙を作成（個別文字）</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">:</span> <span class="mi">3</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a>        <span class="p">}</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a>        <span class="n">char_freq</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_freq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a>            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span><span class="p">:</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a>                <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">word</span><span class="p">:</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a>                    <span class="n">char_freq</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">+=</span> <span class="n">freq</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>                <span class="n">char_freq</span><span class="p">[</span><span class="s1">&#39;&lt;/w&gt;&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">freq</span>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a>        <span class="c1"># 文字を語彙に追加</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a>        <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">char_freq</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a>            <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a>        <span class="c1"># 4. BPEマージを学習</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">:</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a>            <span class="c1"># ペアの頻度を計算</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a>            <span class="n">pair_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pair_frequencies</span><span class="p">(</span><span class="n">word_splits</span><span class="p">)</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">pair_freq</span><span class="p">:</span>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a>                <span class="k">break</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a>            <span class="c1"># 最頻出ペアを選択</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a>            <span class="n">best_pair</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pair_freq</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">pair_freq</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a>            <span class="n">freq</span> <span class="o">=</span> <span class="n">pair_freq</span><span class="p">[</span><span class="n">best_pair</span><span class="p">]</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span><span class="p">:</span>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a>                <span class="k">break</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a>            <span class="c1"># マージを実行</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_pair</span><span class="p">)</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>            <span class="n">new_token</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">best_pair</span><span class="p">)</span>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">new_token</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a>            <span class="c1"># 単語分割を更新</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a>            <span class="n">word_splits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_pair</span><span class="p">(</span><span class="n">word_splits</span><span class="p">,</span> <span class="n">best_pair</span><span class="p">)</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vocabulary size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training complete. Final vocabulary size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>        <span class="c1"># 逆引き辞書を作成</span>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_pair_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_splits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;隣接ペアの頻度を計算&quot;&quot;&quot;</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a>        <span class="n">pair_freq</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">word_splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a>            <span class="n">word_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_freq</span><span class="p">[</span><span class="n">word</span><span class="p">]</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>                <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">split</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a>                <span class="n">pair_freq</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">+=</span> <span class="n">word_freq</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a>        <span class="k">return</span> <span class="n">pair_freq</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word_splits</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> 
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a>                   <span class="n">pair</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;指定されたペアをマージ&quot;&quot;&quot;</span>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a>        <span class="n">new_word_splits</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a>        <span class="n">merged</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">split</span> <span class="ow">in</span> <span class="n">word_splits</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a>            <span class="n">new_split</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a>            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a>            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">):</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">split</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pair</span><span class="p">:</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a>                    <span class="n">new_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a>                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a>                    <span class="n">new_split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a>                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a>            <span class="n">new_word_splits</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_split</span>
<a id="__codelineno-4-125" name="__codelineno-4-125" href="#__codelineno-4-125"></a>
<a id="__codelineno-4-126" name="__codelineno-4-126" href="#__codelineno-4-126"></a>        <span class="k">return</span> <span class="n">new_word_splits</span>
<a id="__codelineno-4-127" name="__codelineno-4-127" href="#__codelineno-4-127"></a>
<a id="__codelineno-4-128" name="__codelineno-4-128" href="#__codelineno-4-128"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_tokenize_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-4-129" name="__codelineno-4-129" href="#__codelineno-4-129"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;単語をBPEトークンに分割&quot;&quot;&quot;</span>
<a id="__codelineno-4-130" name="__codelineno-4-130" href="#__codelineno-4-130"></a>        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-4-131" name="__codelineno-4-131" href="#__codelineno-4-131"></a>        <span class="n">splits</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&lt;/w&gt;&#39;</span><span class="p">]</span>
<a id="__codelineno-4-132" name="__codelineno-4-132" href="#__codelineno-4-132"></a>
<a id="__codelineno-4-133" name="__codelineno-4-133" href="#__codelineno-4-133"></a>        <span class="c1"># 学習したマージを順番に適用</span>
<a id="__codelineno-4-134" name="__codelineno-4-134" href="#__codelineno-4-134"></a>        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="p">:</span>
<a id="__codelineno-4-135" name="__codelineno-4-135" href="#__codelineno-4-135"></a>            <span class="n">new_splits</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-136" name="__codelineno-4-136" href="#__codelineno-4-136"></a>            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-137" name="__codelineno-4-137" href="#__codelineno-4-137"></a>
<a id="__codelineno-4-138" name="__codelineno-4-138" href="#__codelineno-4-138"></a>            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">):</span>
<a id="__codelineno-4-139" name="__codelineno-4-139" href="#__codelineno-4-139"></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">splits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">splits</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="n">pair</span><span class="p">:</span>
<a id="__codelineno-4-140" name="__codelineno-4-140" href="#__codelineno-4-140"></a>                    <span class="n">new_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pair</span><span class="p">))</span>
<a id="__codelineno-4-141" name="__codelineno-4-141" href="#__codelineno-4-141"></a>                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
<a id="__codelineno-4-142" name="__codelineno-4-142" href="#__codelineno-4-142"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-143" name="__codelineno-4-143" href="#__codelineno-4-143"></a>                    <span class="n">new_splits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">splits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<a id="__codelineno-4-144" name="__codelineno-4-144" href="#__codelineno-4-144"></a>                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-4-145" name="__codelineno-4-145" href="#__codelineno-4-145"></a>
<a id="__codelineno-4-146" name="__codelineno-4-146" href="#__codelineno-4-146"></a>            <span class="n">splits</span> <span class="o">=</span> <span class="n">new_splits</span>
<a id="__codelineno-4-147" name="__codelineno-4-147" href="#__codelineno-4-147"></a>
<a id="__codelineno-4-148" name="__codelineno-4-148" href="#__codelineno-4-148"></a>        <span class="k">return</span> <span class="n">splits</span>
<a id="__codelineno-4-149" name="__codelineno-4-149" href="#__codelineno-4-149"></a>
<a id="__codelineno-4-150" name="__codelineno-4-150" href="#__codelineno-4-150"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-4-151" name="__codelineno-4-151" href="#__codelineno-4-151"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;テキストをトークンIDに変換&quot;&quot;&quot;</span>
<a id="__codelineno-4-152" name="__codelineno-4-152" href="#__codelineno-4-152"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">]</span>
<a id="__codelineno-4-153" name="__codelineno-4-153" href="#__codelineno-4-153"></a>
<a id="__codelineno-4-154" name="__codelineno-4-154" href="#__codelineno-4-154"></a>        <span class="n">words</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">word_tokenizer</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
<a id="__codelineno-4-155" name="__codelineno-4-155" href="#__codelineno-4-155"></a>        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
<a id="__codelineno-4-156" name="__codelineno-4-156" href="#__codelineno-4-156"></a>            <span class="n">word_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tokenize_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="__codelineno-4-157" name="__codelineno-4-157" href="#__codelineno-4-157"></a>            <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">word_tokens</span><span class="p">:</span>
<a id="__codelineno-4-158" name="__codelineno-4-158" href="#__codelineno-4-158"></a>                <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-4-159" name="__codelineno-4-159" href="#__codelineno-4-159"></a>                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-4-160" name="__codelineno-4-160" href="#__codelineno-4-160"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-4-161" name="__codelineno-4-161" href="#__codelineno-4-161"></a>                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">)</span>
<a id="__codelineno-4-162" name="__codelineno-4-162" href="#__codelineno-4-162"></a>
<a id="__codelineno-4-163" name="__codelineno-4-163" href="#__codelineno-4-163"></a>        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">)</span>
<a id="__codelineno-4-164" name="__codelineno-4-164" href="#__codelineno-4-164"></a>
<a id="__codelineno-4-165" name="__codelineno-4-165" href="#__codelineno-4-165"></a>        <span class="c1"># トークンをIDに変換</span>
<a id="__codelineno-4-166" name="__codelineno-4-166" href="#__codelineno-4-166"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
<a id="__codelineno-4-167" name="__codelineno-4-167" href="#__codelineno-4-167"></a>
<a id="__codelineno-4-168" name="__codelineno-4-168" href="#__codelineno-4-168"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-4-169" name="__codelineno-4-169" href="#__codelineno-4-169"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;トークンIDをテキストに変換&quot;&quot;&quot;</span>
<a id="__codelineno-4-170" name="__codelineno-4-170" href="#__codelineno-4-170"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-4-171" name="__codelineno-4-171" href="#__codelineno-4-171"></a>
<a id="__codelineno-4-172" name="__codelineno-4-172" href="#__codelineno-4-172"></a>        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-4-173" name="__codelineno-4-173" href="#__codelineno-4-173"></a>            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span><span class="p">:</span>
<a id="__codelineno-4-174" name="__codelineno-4-174" href="#__codelineno-4-174"></a>                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
<a id="__codelineno-4-175" name="__codelineno-4-175" href="#__codelineno-4-175"></a>                <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span> 
<a id="__codelineno-4-176" name="__codelineno-4-176" href="#__codelineno-4-176"></a>                               <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">]:</span>
<a id="__codelineno-4-177" name="__codelineno-4-177" href="#__codelineno-4-177"></a>                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-4-178" name="__codelineno-4-178" href="#__codelineno-4-178"></a>
<a id="__codelineno-4-179" name="__codelineno-4-179" href="#__codelineno-4-179"></a>        <span class="c1"># トークンを結合</span>
<a id="__codelineno-4-180" name="__codelineno-4-180" href="#__codelineno-4-180"></a>        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
<a id="__codelineno-4-181" name="__codelineno-4-181" href="#__codelineno-4-181"></a>        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/w&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-4-182" name="__codelineno-4-182" href="#__codelineno-4-182"></a>        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-4-183" name="__codelineno-4-183" href="#__codelineno-4-183"></a>
<a id="__codelineno-4-184" name="__codelineno-4-184" href="#__codelineno-4-184"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-4-185" name="__codelineno-4-185" href="#__codelineno-4-185"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;トークナイザーを保存&quot;&quot;&quot;</span>
<a id="__codelineno-4-186" name="__codelineno-4-186" href="#__codelineno-4-186"></a>        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-4-187" name="__codelineno-4-187" href="#__codelineno-4-187"></a>            <span class="s1">&#39;vocab&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">,</span>
<a id="__codelineno-4-188" name="__codelineno-4-188" href="#__codelineno-4-188"></a>            <span class="s1">&#39;merges&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="p">,</span>
<a id="__codelineno-4-189" name="__codelineno-4-189" href="#__codelineno-4-189"></a>            <span class="s1">&#39;vocab_size&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">,</span>
<a id="__codelineno-4-190" name="__codelineno-4-190" href="#__codelineno-4-190"></a>            <span class="s1">&#39;min_frequency&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span>
<a id="__codelineno-4-191" name="__codelineno-4-191" href="#__codelineno-4-191"></a>        <span class="p">}</span>
<a id="__codelineno-4-192" name="__codelineno-4-192" href="#__codelineno-4-192"></a>
<a id="__codelineno-4-193" name="__codelineno-4-193" href="#__codelineno-4-193"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-4-194" name="__codelineno-4-194" href="#__codelineno-4-194"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-4-195" name="__codelineno-4-195" href="#__codelineno-4-195"></a>
<a id="__codelineno-4-196" name="__codelineno-4-196" href="#__codelineno-4-196"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-4-197" name="__codelineno-4-197" href="#__codelineno-4-197"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;トークナイザーを読み込み&quot;&quot;&quot;</span>
<a id="__codelineno-4-198" name="__codelineno-4-198" href="#__codelineno-4-198"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-4-199" name="__codelineno-4-199" href="#__codelineno-4-199"></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<a id="__codelineno-4-200" name="__codelineno-4-200" href="#__codelineno-4-200"></a>
<a id="__codelineno-4-201" name="__codelineno-4-201" href="#__codelineno-4-201"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vocab&#39;</span><span class="p">]</span>
<a id="__codelineno-4-202" name="__codelineno-4-202" href="#__codelineno-4-202"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">merges</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;merges&#39;</span><span class="p">]]</span>
<a id="__codelineno-4-203" name="__codelineno-4-203" href="#__codelineno-4-203"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vocab_size&#39;</span><span class="p">]</span>
<a id="__codelineno-4-204" name="__codelineno-4-204" href="#__codelineno-4-204"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;min_frequency&#39;</span><span class="p">]</span>
<a id="__codelineno-4-205" name="__codelineno-4-205" href="#__codelineno-4-205"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-4-206" name="__codelineno-4-206" href="#__codelineno-4-206"></a>
<a id="__codelineno-4-207" name="__codelineno-4-207" href="#__codelineno-4-207"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_vocabulary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-208" name="__codelineno-4-208" href="#__codelineno-4-208"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;語彙の分析&quot;&quot;&quot;</span>
<a id="__codelineno-4-209" name="__codelineno-4-209" href="#__codelineno-4-209"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;=== Vocabulary Analysis ===&quot;</span><span class="p">)</span>
<a id="__codelineno-4-210" name="__codelineno-4-210" href="#__codelineno-4-210"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total vocabulary size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-211" name="__codelineno-4-211" href="#__codelineno-4-211"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of merges: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-212" name="__codelineno-4-212" href="#__codelineno-4-212"></a>
<a id="__codelineno-4-213" name="__codelineno-4-213" href="#__codelineno-4-213"></a>        <span class="c1"># トークン長の分布</span>
<a id="__codelineno-4-214" name="__codelineno-4-214" href="#__codelineno-4-214"></a>        <span class="n">token_lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/w&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-4-215" name="__codelineno-4-215" href="#__codelineno-4-215"></a>                       <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span> 
<a id="__codelineno-4-216" name="__codelineno-4-216" href="#__codelineno-4-216"></a>                                      <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">]]</span>
<a id="__codelineno-4-217" name="__codelineno-4-217" href="#__codelineno-4-217"></a>
<a id="__codelineno-4-218" name="__codelineno-4-218" href="#__codelineno-4-218"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Token length distribution:&quot;</span><span class="p">)</span>
<a id="__codelineno-4-219" name="__codelineno-4-219" href="#__codelineno-4-219"></a>        <span class="n">length_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">token_lengths</span><span class="p">)</span>
<a id="__codelineno-4-220" name="__codelineno-4-220" href="#__codelineno-4-220"></a>        <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">length_counts</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
<a id="__codelineno-4-221" name="__codelineno-4-221" href="#__codelineno-4-221"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Length </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">length_counts</span><span class="p">[</span><span class="n">length</span><span class="p">]</span><span class="si">}</span><span class="s2"> tokens&quot;</span><span class="p">)</span>
<a id="__codelineno-4-222" name="__codelineno-4-222" href="#__codelineno-4-222"></a>
<a id="__codelineno-4-223" name="__codelineno-4-223" href="#__codelineno-4-223"></a>        <span class="c1"># 最も長いトークン</span>
<a id="__codelineno-4-224" name="__codelineno-4-224" href="#__codelineno-4-224"></a>        <span class="n">longest_tokens</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
<a id="__codelineno-4-225" name="__codelineno-4-225" href="#__codelineno-4-225"></a>            <span class="p">[(</span><span class="n">token</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/w&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-4-226" name="__codelineno-4-226" href="#__codelineno-4-226"></a>             <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span> 
<a id="__codelineno-4-227" name="__codelineno-4-227" href="#__codelineno-4-227"></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">]],</span>
<a id="__codelineno-4-228" name="__codelineno-4-228" href="#__codelineno-4-228"></a>            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-4-229" name="__codelineno-4-229" href="#__codelineno-4-229"></a>        <span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
<a id="__codelineno-4-230" name="__codelineno-4-230" href="#__codelineno-4-230"></a>
<a id="__codelineno-4-231" name="__codelineno-4-231" href="#__codelineno-4-231"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Longest tokens:&quot;</span><span class="p">)</span>
<a id="__codelineno-4-232" name="__codelineno-4-232" href="#__codelineno-4-232"></a>        <span class="k">for</span> <span class="n">token</span><span class="p">,</span> <span class="n">length</span> <span class="ow">in</span> <span class="n">longest_tokens</span><span class="p">:</span>
<a id="__codelineno-4-233" name="__codelineno-4-233" href="#__codelineno-4-233"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  &#39;</span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s2">&#39; (length: </span><span class="si">{</span><span class="n">length</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<a id="__codelineno-4-234" name="__codelineno-4-234" href="#__codelineno-4-234"></a>
<a id="__codelineno-4-235" name="__codelineno-4-235" href="#__codelineno-4-235"></a>        <span class="c1"># 最初のマージ</span>
<a id="__codelineno-4-236" name="__codelineno-4-236" href="#__codelineno-4-236"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">First 10 merges:&quot;</span><span class="p">)</span>
<a id="__codelineno-4-237" name="__codelineno-4-237" href="#__codelineno-4-237"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merges</span><span class="p">[:</span><span class="mi">10</span><span class="p">]):</span>
<a id="__codelineno-4-238" name="__codelineno-4-238" href="#__codelineno-4-238"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">. &#39;</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&#39; + &#39;</span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">a</span><span class="si">}{</span><span class="n">b</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-4-239" name="__codelineno-4-239" href="#__codelineno-4-239"></a>
<a id="__codelineno-4-240" name="__codelineno-4-240" href="#__codelineno-4-240"></a><span class="c1"># テストと可視化</span>
<a id="__codelineno-4-241" name="__codelineno-4-241" href="#__codelineno-4-241"></a><span class="k">def</span><span class="w"> </span><span class="nf">test_bpe_tokenizer</span><span class="p">():</span>
<a id="__codelineno-4-242" name="__codelineno-4-242" href="#__codelineno-4-242"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;BPEトークナイザーのテスト&quot;&quot;&quot;</span>
<a id="__codelineno-4-243" name="__codelineno-4-243" href="#__codelineno-4-243"></a>
<a id="__codelineno-4-244" name="__codelineno-4-244" href="#__codelineno-4-244"></a>    <span class="c1"># 訓練データ</span>
<a id="__codelineno-4-245" name="__codelineno-4-245" href="#__codelineno-4-245"></a>    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-4-246" name="__codelineno-4-246" href="#__codelineno-4-246"></a>        <span class="s2">&quot;The quick brown fox jumps over the lazy dog.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-247" name="__codelineno-4-247" href="#__codelineno-4-247"></a>        <span class="s2">&quot;Machine learning is transforming artificial intelligence.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-248" name="__codelineno-4-248" href="#__codelineno-4-248"></a>        <span class="s2">&quot;Natural language processing enables computers to understand text.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-249" name="__codelineno-4-249" href="#__codelineno-4-249"></a>        <span class="s2">&quot;Deep learning models can learn complex patterns.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-250" name="__codelineno-4-250" href="#__codelineno-4-250"></a>        <span class="s2">&quot;Transformers have revolutionized NLP tasks.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-251" name="__codelineno-4-251" href="#__codelineno-4-251"></a>        <span class="s2">&quot;Attention mechanism is the key innovation.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-252" name="__codelineno-4-252" href="#__codelineno-4-252"></a>        <span class="s2">&quot;Pre-training on large corpora improves performance.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-253" name="__codelineno-4-253" href="#__codelineno-4-253"></a>        <span class="s2">&quot;Fine-tuning adapts models to specific tasks.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-254" name="__codelineno-4-254" href="#__codelineno-4-254"></a>        <span class="s2">&quot;Tokenization is an important preprocessing step.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-255" name="__codelineno-4-255" href="#__codelineno-4-255"></a>        <span class="s2">&quot;Byte pair encoding is a subword tokenization method.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-256" name="__codelineno-4-256" href="#__codelineno-4-256"></a>    <span class="p">]</span> <span class="o">*</span> <span class="mi">10</span>  <span class="c1"># データを増やす</span>
<a id="__codelineno-4-257" name="__codelineno-4-257" href="#__codelineno-4-257"></a>
<a id="__codelineno-4-258" name="__codelineno-4-258" href="#__codelineno-4-258"></a>    <span class="c1"># BPEトークナイザーの訓練</span>
<a id="__codelineno-4-259" name="__codelineno-4-259" href="#__codelineno-4-259"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">BPETokenizer</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">min_frequency</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-4-260" name="__codelineno-4-260" href="#__codelineno-4-260"></a>    <span class="n">tokenizer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">texts</span><span class="p">)</span>
<a id="__codelineno-4-261" name="__codelineno-4-261" href="#__codelineno-4-261"></a>
<a id="__codelineno-4-262" name="__codelineno-4-262" href="#__codelineno-4-262"></a>    <span class="c1"># 語彙の分析</span>
<a id="__codelineno-4-263" name="__codelineno-4-263" href="#__codelineno-4-263"></a>    <span class="n">tokenizer</span><span class="o">.</span><span class="n">analyze_vocabulary</span><span class="p">()</span>
<a id="__codelineno-4-264" name="__codelineno-4-264" href="#__codelineno-4-264"></a>
<a id="__codelineno-4-265" name="__codelineno-4-265" href="#__codelineno-4-265"></a>    <span class="c1"># エンコード/デコードのテスト</span>
<a id="__codelineno-4-266" name="__codelineno-4-266" href="#__codelineno-4-266"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Encoding/Decoding Test ===&quot;</span><span class="p">)</span>
<a id="__codelineno-4-267" name="__codelineno-4-267" href="#__codelineno-4-267"></a>    <span class="n">test_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-4-268" name="__codelineno-4-268" href="#__codelineno-4-268"></a>        <span class="s2">&quot;Machine learning is amazing.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-269" name="__codelineno-4-269" href="#__codelineno-4-269"></a>        <span class="s2">&quot;Transformers revolutionized NLP.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-270" name="__codelineno-4-270" href="#__codelineno-4-270"></a>        <span class="s2">&quot;Unknown words like cryptocurrency.&quot;</span><span class="p">,</span>
<a id="__codelineno-4-271" name="__codelineno-4-271" href="#__codelineno-4-271"></a>    <span class="p">]</span>
<a id="__codelineno-4-272" name="__codelineno-4-272" href="#__codelineno-4-272"></a>
<a id="__codelineno-4-273" name="__codelineno-4-273" href="#__codelineno-4-273"></a>    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">test_texts</span><span class="p">:</span>
<a id="__codelineno-4-274" name="__codelineno-4-274" href="#__codelineno-4-274"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Original: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-275" name="__codelineno-4-275" href="#__codelineno-4-275"></a>
<a id="__codelineno-4-276" name="__codelineno-4-276" href="#__codelineno-4-276"></a>        <span class="c1"># エンコード</span>
<a id="__codelineno-4-277" name="__codelineno-4-277" href="#__codelineno-4-277"></a>        <span class="n">ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-4-278" name="__codelineno-4-278" href="#__codelineno-4-278"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">id_to_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
<a id="__codelineno-4-279" name="__codelineno-4-279" href="#__codelineno-4-279"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tokens: </span><span class="si">{</span><span class="n">tokens</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-280" name="__codelineno-4-280" href="#__codelineno-4-280"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;IDs: </span><span class="si">{</span><span class="n">ids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-281" name="__codelineno-4-281" href="#__codelineno-4-281"></a>
<a id="__codelineno-4-282" name="__codelineno-4-282" href="#__codelineno-4-282"></a>        <span class="c1"># デコード</span>
<a id="__codelineno-4-283" name="__codelineno-4-283" href="#__codelineno-4-283"></a>        <span class="n">decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-4-284" name="__codelineno-4-284" href="#__codelineno-4-284"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoded: </span><span class="si">{</span><span class="n">decoded</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-4-285" name="__codelineno-4-285" href="#__codelineno-4-285"></a>
<a id="__codelineno-4-286" name="__codelineno-4-286" href="#__codelineno-4-286"></a>    <span class="c1"># 圧縮率の計算</span>
<a id="__codelineno-4-287" name="__codelineno-4-287" href="#__codelineno-4-287"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Compression Analysis ===&quot;</span><span class="p">)</span>
<a id="__codelineno-4-288" name="__codelineno-4-288" href="#__codelineno-4-288"></a>    <span class="n">total_chars</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-289" name="__codelineno-4-289" href="#__codelineno-4-289"></a>    <span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-4-290" name="__codelineno-4-290" href="#__codelineno-4-290"></a>
<a id="__codelineno-4-291" name="__codelineno-4-291" href="#__codelineno-4-291"></a>    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
<a id="__codelineno-4-292" name="__codelineno-4-292" href="#__codelineno-4-292"></a>        <span class="n">chars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-4-293" name="__codelineno-4-293" href="#__codelineno-4-293"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
<a id="__codelineno-4-294" name="__codelineno-4-294" href="#__codelineno-4-294"></a>        <span class="n">total_chars</span> <span class="o">+=</span> <span class="n">chars</span>
<a id="__codelineno-4-295" name="__codelineno-4-295" href="#__codelineno-4-295"></a>        <span class="n">total_tokens</span> <span class="o">+=</span> <span class="n">tokens</span>
<a id="__codelineno-4-296" name="__codelineno-4-296" href="#__codelineno-4-296"></a>
<a id="__codelineno-4-297" name="__codelineno-4-297" href="#__codelineno-4-297"></a>    <span class="n">compression_ratio</span> <span class="o">=</span> <span class="n">total_chars</span> <span class="o">/</span> <span class="n">total_tokens</span>
<a id="__codelineno-4-298" name="__codelineno-4-298" href="#__codelineno-4-298"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average compression ratio: </span><span class="si">{</span><span class="n">compression_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> chars/token&quot;</span><span class="p">)</span>
<a id="__codelineno-4-299" name="__codelineno-4-299" href="#__codelineno-4-299"></a>
<a id="__codelineno-4-300" name="__codelineno-4-300" href="#__codelineno-4-300"></a>    <span class="k">return</span> <span class="n">tokenizer</span>
<a id="__codelineno-4-301" name="__codelineno-4-301" href="#__codelineno-4-301"></a>
<a id="__codelineno-4-302" name="__codelineno-4-302" href="#__codelineno-4-302"></a><span class="c1"># 実行</span>
<a id="__codelineno-4-303" name="__codelineno-4-303" href="#__codelineno-4-303"></a><span class="n">bpe_tokenizer</span> <span class="o">=</span> <span class="n">test_bpe_tokenizer</span><span class="p">()</span>
</code></pre></div>
</details>
<h3 id="6">問題 6<a class="headerlink" href="#6" title="Permanent link">&para;</a></h3>
<p>異なるトークナイザー（BPE、WordPiece、SentencePiece）の性能を比較してください。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">WordPieceTokenizer</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;WordPiece トークナイザーの簡易実装&quot;&quot;&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">min_frequency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span> <span class="o">=</span> <span class="n">min_frequency</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="s1">&#39;[UNK]&#39;</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="s1">&#39;[PAD]&#39;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span> <span class="o">=</span> <span class="s1">&#39;[CLS]&#39;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span> <span class="o">=</span> <span class="s1">&#39;[SEP]&#39;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;##&#39;</span>  <span class="c1"># サブワードプレフィックス</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;WordPieceモデルの訓練&quot;&quot;&quot;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a>        <span class="c1"># 簡略化のため、事前定義された語彙を使用</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>        <span class="c1"># 実際のWordPieceはより複雑なアルゴリズムを使用</span>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a>        <span class="c1"># 特殊トークン</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a>        <span class="p">}</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a>        <span class="c1"># 文字と一般的なサブワードを追加</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a>        <span class="n">chars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a>        <span class="n">words</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a>            <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a>                <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a>                <span class="n">chars</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a>        <span class="c1"># 個別文字を追加</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a>        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">chars</span><span class="p">):</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a>            <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a>        <span class="c1"># 頻出サブワードを追加（簡略化）</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a>        <span class="n">word_freq</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>        <span class="c1"># 単語の部分文字列を候補として生成</span>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a>        <span class="n">subword_freq</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a>        <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">word_freq</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a>            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span><span class="p">:</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a>                <span class="c1"># 単語全体</span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a>                <span class="c1"># サブワード</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)):</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a>                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a>                        <span class="n">subword</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a>                        <span class="n">subword_freq</span><span class="p">[</span><span class="n">subword</span><span class="p">]</span> <span class="o">+=</span> <span class="n">freq</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a>        <span class="c1"># 頻出サブワードを語彙に追加</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a>        <span class="k">for</span> <span class="n">subword</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">subword_freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">:</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>                <span class="k">break</span>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a>            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_frequency</span> <span class="ow">and</span> <span class="n">subword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">subword</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tokenize_word</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;単語をWordPieceトークンに分割&quot;&quot;&quot;</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a>        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a>        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a>            <span class="n">end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a>            <span class="n">cur_substr</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a>            <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a>                <span class="n">substr</span> <span class="o">=</span> <span class="n">word</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a>                <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a>                    <span class="n">substr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">substr</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a>                <span class="k">if</span> <span class="n">substr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a>                    <span class="n">cur_substr</span> <span class="o">=</span> <span class="n">substr</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>                    <span class="k">break</span>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a>                <span class="n">end</span> <span class="o">-=</span> <span class="mi">1</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a>            <span class="k">if</span> <span class="n">cur_substr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a>                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">)</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a>                <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a>                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_substr</span><span class="p">)</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a>                <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a>        <span class="k">return</span> <span class="n">tokens</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;テキストをトークンIDに変換&quot;&quot;&quot;</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="p">]</span>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>        <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a>            <span class="n">word_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenize_word</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>            <span class="n">tokens</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">word_tokens</span><span class="p">)</span>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a>        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span><span class="p">)</span>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;トークンIDをテキストに変換&quot;&quot;&quot;</span>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a>        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a>            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span><span class="p">:</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a>                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a>                <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span> 
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a>                               <span class="bp">self</span><span class="o">.</span><span class="n">cls_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sep_token</span><span class="p">]:</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a>                    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a>                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):])</span>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a>                        <span class="k">if</span> <span class="n">tokens</span><span class="p">:</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a>                            <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>                        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a>        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a><span class="k">class</span><span class="w"> </span><span class="nc">SentencePieceTokenizer</span><span class="p">:</span>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;SentencePiece トークナイザーの簡易実装&quot;&quot;&quot;</span>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">character_coverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9995</span><span class="p">):</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span> <span class="o">=</span> <span class="n">vocab_size</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">character_coverage</span> <span class="o">=</span> <span class="n">character_coverage</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;unk&gt;&#39;</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;pad&gt;&#39;</span>
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;s&gt;&#39;</span>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span> <span class="o">=</span> <span class="s1">&#39;&lt;/s&gt;&#39;</span>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span> <span class="o">=</span> <span class="s1">&#39;▁&#39;</span>  <span class="c1"># スペースを表す記号</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;SentencePieceモデルの訓練（簡略化版）&quot;&quot;&quot;</span>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a>        <span class="c1"># 実際のSentencePieceは unigram language model を使用</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>        <span class="p">}</span>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a>
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a>        <span class="c1"># 文字頻度を計算</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>        <span class="n">char_freq</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">:</span>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a>            <span class="c1"># スペースを特殊記号に置換</span>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a>            <span class="n">normalized_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span> <span class="o">+</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span><span class="p">)</span>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>            <span class="n">char_freq</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">normalized_text</span><span class="p">)</span>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a>        <span class="c1"># 文字カバレッジに基づいて文字を選択</span>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a>        <span class="n">total_chars</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">char_freq</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a>        <span class="n">covered_chars</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a>        <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">char_freq</span><span class="o">.</span><span class="n">most_common</span><span class="p">():</span>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a>            <span class="k">if</span> <span class="n">char</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a>                <span class="n">covered_chars</span> <span class="o">+=</span> <span class="n">freq</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a>                <span class="k">if</span> <span class="n">covered_chars</span> <span class="o">/</span> <span class="n">total_chars</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">character_coverage</span><span class="p">:</span>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a>                    <span class="k">break</span>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a>        <span class="c1"># サブワード候補を生成（簡略化）</span>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a>        <span class="n">subword_scores</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a>        <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">[:</span><span class="mi">100</span><span class="p">]:</span>  <span class="c1"># 計算量削減のため一部のみ使用</span>
<a id="__codelineno-5-179" name="__codelineno-5-179" href="#__codelineno-5-179"></a>            <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span> <span class="o">+</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span><span class="p">)</span>
<a id="__codelineno-5-180" name="__codelineno-5-180" href="#__codelineno-5-180"></a>
<a id="__codelineno-5-181" name="__codelineno-5-181" href="#__codelineno-5-181"></a>            <span class="c1"># 全てのサブストリングを候補として生成</span>
<a id="__codelineno-5-182" name="__codelineno-5-182" href="#__codelineno-5-182"></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized</span><span class="p">)):</span>
<a id="__codelineno-5-183" name="__codelineno-5-183" href="#__codelineno-5-183"></a>                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
<a id="__codelineno-5-184" name="__codelineno-5-184" href="#__codelineno-5-184"></a>                    <span class="n">subword</span> <span class="o">=</span> <span class="n">normalized</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
<a id="__codelineno-5-185" name="__codelineno-5-185" href="#__codelineno-5-185"></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subword</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-5-186" name="__codelineno-5-186" href="#__codelineno-5-186"></a>                        <span class="c1"># スコア計算（簡略化：頻度のみ）</span>
<a id="__codelineno-5-187" name="__codelineno-5-187" href="#__codelineno-5-187"></a>                        <span class="n">subword_scores</span><span class="p">[</span><span class="n">subword</span><span class="p">]</span> <span class="o">=</span> <span class="n">subword_scores</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subword</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-5-188" name="__codelineno-5-188" href="#__codelineno-5-188"></a>
<a id="__codelineno-5-189" name="__codelineno-5-189" href="#__codelineno-5-189"></a>        <span class="c1"># スコアの高いサブワードを語彙に追加</span>
<a id="__codelineno-5-190" name="__codelineno-5-190" href="#__codelineno-5-190"></a>        <span class="k">for</span> <span class="n">subword</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">subword_scores</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> 
<a id="__codelineno-5-191" name="__codelineno-5-191" href="#__codelineno-5-191"></a>                                   <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-5-192" name="__codelineno-5-192" href="#__codelineno-5-192"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab_size</span><span class="p">:</span>
<a id="__codelineno-5-193" name="__codelineno-5-193" href="#__codelineno-5-193"></a>                <span class="k">break</span>
<a id="__codelineno-5-194" name="__codelineno-5-194" href="#__codelineno-5-194"></a>
<a id="__codelineno-5-195" name="__codelineno-5-195" href="#__codelineno-5-195"></a>            <span class="k">if</span> <span class="n">subword</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-5-196" name="__codelineno-5-196" href="#__codelineno-5-196"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">subword</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-5-197" name="__codelineno-5-197" href="#__codelineno-5-197"></a>
<a id="__codelineno-5-198" name="__codelineno-5-198" href="#__codelineno-5-198"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-5-199" name="__codelineno-5-199" href="#__codelineno-5-199"></a>
<a id="__codelineno-5-200" name="__codelineno-5-200" href="#__codelineno-5-200"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-5-201" name="__codelineno-5-201" href="#__codelineno-5-201"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;テキストをトークンIDに変換（簡略化版）&quot;&quot;&quot;</span>
<a id="__codelineno-5-202" name="__codelineno-5-202" href="#__codelineno-5-202"></a>        <span class="c1"># 実際のSentencePieceはViterbiアルゴリズムを使用</span>
<a id="__codelineno-5-203" name="__codelineno-5-203" href="#__codelineno-5-203"></a>
<a id="__codelineno-5-204" name="__codelineno-5-204" href="#__codelineno-5-204"></a>        <span class="n">normalized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span> <span class="o">+</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span><span class="p">)</span>
<a id="__codelineno-5-205" name="__codelineno-5-205" href="#__codelineno-5-205"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">]</span>
<a id="__codelineno-5-206" name="__codelineno-5-206" href="#__codelineno-5-206"></a>
<a id="__codelineno-5-207" name="__codelineno-5-207" href="#__codelineno-5-207"></a>        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-5-208" name="__codelineno-5-208" href="#__codelineno-5-208"></a>        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized</span><span class="p">):</span>
<a id="__codelineno-5-209" name="__codelineno-5-209" href="#__codelineno-5-209"></a>            <span class="c1"># 最長一致で貪欲に分割</span>
<a id="__codelineno-5-210" name="__codelineno-5-210" href="#__codelineno-5-210"></a>            <span class="n">match_found</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-5-211" name="__codelineno-5-211" href="#__codelineno-5-211"></a>
<a id="__codelineno-5-212" name="__codelineno-5-212" href="#__codelineno-5-212"></a>            <span class="k">for</span> <span class="n">length</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-5-213" name="__codelineno-5-213" href="#__codelineno-5-213"></a>                <span class="n">subword</span> <span class="o">=</span> <span class="n">normalized</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">length</span><span class="p">]</span>
<a id="__codelineno-5-214" name="__codelineno-5-214" href="#__codelineno-5-214"></a>
<a id="__codelineno-5-215" name="__codelineno-5-215" href="#__codelineno-5-215"></a>                <span class="k">if</span> <span class="n">subword</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">:</span>
<a id="__codelineno-5-216" name="__codelineno-5-216" href="#__codelineno-5-216"></a>                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subword</span><span class="p">)</span>
<a id="__codelineno-5-217" name="__codelineno-5-217" href="#__codelineno-5-217"></a>                    <span class="n">i</span> <span class="o">+=</span> <span class="n">length</span>
<a id="__codelineno-5-218" name="__codelineno-5-218" href="#__codelineno-5-218"></a>                    <span class="n">match_found</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-5-219" name="__codelineno-5-219" href="#__codelineno-5-219"></a>                    <span class="k">break</span>
<a id="__codelineno-5-220" name="__codelineno-5-220" href="#__codelineno-5-220"></a>
<a id="__codelineno-5-221" name="__codelineno-5-221" href="#__codelineno-5-221"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">match_found</span><span class="p">:</span>
<a id="__codelineno-5-222" name="__codelineno-5-222" href="#__codelineno-5-222"></a>                <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">)</span>
<a id="__codelineno-5-223" name="__codelineno-5-223" href="#__codelineno-5-223"></a>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-5-224" name="__codelineno-5-224" href="#__codelineno-5-224"></a>
<a id="__codelineno-5-225" name="__codelineno-5-225" href="#__codelineno-5-225"></a>        <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">)</span>
<a id="__codelineno-5-226" name="__codelineno-5-226" href="#__codelineno-5-226"></a>
<a id="__codelineno-5-227" name="__codelineno-5-227" href="#__codelineno-5-227"></a>        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
<a id="__codelineno-5-228" name="__codelineno-5-228" href="#__codelineno-5-228"></a>
<a id="__codelineno-5-229" name="__codelineno-5-229" href="#__codelineno-5-229"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-5-230" name="__codelineno-5-230" href="#__codelineno-5-230"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;トークンIDをテキストに変換&quot;&quot;&quot;</span>
<a id="__codelineno-5-231" name="__codelineno-5-231" href="#__codelineno-5-231"></a>        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-5-232" name="__codelineno-5-232" href="#__codelineno-5-232"></a>
<a id="__codelineno-5-233" name="__codelineno-5-233" href="#__codelineno-5-233"></a>        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
<a id="__codelineno-5-234" name="__codelineno-5-234" href="#__codelineno-5-234"></a>            <span class="k">if</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span><span class="p">:</span>
<a id="__codelineno-5-235" name="__codelineno-5-235" href="#__codelineno-5-235"></a>                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_to_token</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
<a id="__codelineno-5-236" name="__codelineno-5-236" href="#__codelineno-5-236"></a>                <span class="k">if</span> <span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unk_token</span><span class="p">,</span> 
<a id="__codelineno-5-237" name="__codelineno-5-237" href="#__codelineno-5-237"></a>                               <span class="bp">self</span><span class="o">.</span><span class="n">bos_token</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eos_token</span><span class="p">]:</span>
<a id="__codelineno-5-238" name="__codelineno-5-238" href="#__codelineno-5-238"></a>                    <span class="n">tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<a id="__codelineno-5-239" name="__codelineno-5-239" href="#__codelineno-5-239"></a>
<a id="__codelineno-5-240" name="__codelineno-5-240" href="#__codelineno-5-240"></a>        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
<a id="__codelineno-5-241" name="__codelineno-5-241" href="#__codelineno-5-241"></a>        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">space_symbol</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a id="__codelineno-5-242" name="__codelineno-5-242" href="#__codelineno-5-242"></a>
<a id="__codelineno-5-243" name="__codelineno-5-243" href="#__codelineno-5-243"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_tokenizers</span><span class="p">():</span>
<a id="__codelineno-5-244" name="__codelineno-5-244" href="#__codelineno-5-244"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;トークナイザーの比較&quot;&quot;&quot;</span>
<a id="__codelineno-5-245" name="__codelineno-5-245" href="#__codelineno-5-245"></a>
<a id="__codelineno-5-246" name="__codelineno-5-246" href="#__codelineno-5-246"></a>    <span class="c1"># テストデータ</span>
<a id="__codelineno-5-247" name="__codelineno-5-247" href="#__codelineno-5-247"></a>    <span class="n">train_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-248" name="__codelineno-5-248" href="#__codelineno-5-248"></a>        <span class="s2">&quot;The quick brown fox jumps over the lazy dog.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-249" name="__codelineno-5-249" href="#__codelineno-5-249"></a>        <span class="s2">&quot;Machine learning transforms artificial intelligence.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-250" name="__codelineno-5-250" href="#__codelineno-5-250"></a>        <span class="s2">&quot;Natural language processing is fascinating.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-251" name="__codelineno-5-251" href="#__codelineno-5-251"></a>        <span class="s2">&quot;Deep neural networks learn complex patterns.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-252" name="__codelineno-5-252" href="#__codelineno-5-252"></a>        <span class="s2">&quot;Tokenization is crucial for text processing.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-253" name="__codelineno-5-253" href="#__codelineno-5-253"></a>    <span class="p">]</span> <span class="o">*</span> <span class="mi">20</span>
<a id="__codelineno-5-254" name="__codelineno-5-254" href="#__codelineno-5-254"></a>
<a id="__codelineno-5-255" name="__codelineno-5-255" href="#__codelineno-5-255"></a>    <span class="n">test_texts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-5-256" name="__codelineno-5-256" href="#__codelineno-5-256"></a>        <span class="s2">&quot;Machine learning is amazing!&quot;</span><span class="p">,</span>
<a id="__codelineno-5-257" name="__codelineno-5-257" href="#__codelineno-5-257"></a>        <span class="s2">&quot;Tokenizers split text into tokens.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-258" name="__codelineno-5-258" href="#__codelineno-5-258"></a>        <span class="s2">&quot;Unknown words like cryptocurrency appear.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-259" name="__codelineno-5-259" href="#__codelineno-5-259"></a>        <span class="s2">&quot;The quick brown fox runs fast.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-260" name="__codelineno-5-260" href="#__codelineno-5-260"></a>        <span class="s2">&quot;Deep learning revolutionizes AI.&quot;</span><span class="p">,</span>
<a id="__codelineno-5-261" name="__codelineno-5-261" href="#__codelineno-5-261"></a>    <span class="p">]</span>
<a id="__codelineno-5-262" name="__codelineno-5-262" href="#__codelineno-5-262"></a>
<a id="__codelineno-5-263" name="__codelineno-5-263" href="#__codelineno-5-263"></a>    <span class="c1"># 各トークナイザーを訓練</span>
<a id="__codelineno-5-264" name="__codelineno-5-264" href="#__codelineno-5-264"></a>    <span class="n">tokenizers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-5-265" name="__codelineno-5-265" href="#__codelineno-5-265"></a>        <span class="s1">&#39;BPE&#39;</span><span class="p">:</span> <span class="n">BPETokenizer</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="mi">500</span><span class="p">),</span>
<a id="__codelineno-5-266" name="__codelineno-5-266" href="#__codelineno-5-266"></a>        <span class="s1">&#39;WordPiece&#39;</span><span class="p">:</span> <span class="n">WordPieceTokenizer</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="mi">500</span><span class="p">),</span>
<a id="__codelineno-5-267" name="__codelineno-5-267" href="#__codelineno-5-267"></a>        <span class="s1">&#39;SentencePiece&#39;</span><span class="p">:</span> <span class="n">SentencePieceTokenizer</span><span class="p">(</span><span class="n">vocab_size</span><span class="o">=</span><span class="mi">500</span><span class="p">),</span>
<a id="__codelineno-5-268" name="__codelineno-5-268" href="#__codelineno-5-268"></a>    <span class="p">}</span>
<a id="__codelineno-5-269" name="__codelineno-5-269" href="#__codelineno-5-269"></a>
<a id="__codelineno-5-270" name="__codelineno-5-270" href="#__codelineno-5-270"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Training tokenizers...&quot;</span><span class="p">)</span>
<a id="__codelineno-5-271" name="__codelineno-5-271" href="#__codelineno-5-271"></a>    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-5-272" name="__codelineno-5-272" href="#__codelineno-5-272"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
<a id="__codelineno-5-273" name="__codelineno-5-273" href="#__codelineno-5-273"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-274" name="__codelineno-5-274" href="#__codelineno-5-274"></a>        <span class="n">tokenizer</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_texts</span><span class="p">)</span>
<a id="__codelineno-5-275" name="__codelineno-5-275" href="#__codelineno-5-275"></a>        <span class="n">train_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-5-276" name="__codelineno-5-276" href="#__codelineno-5-276"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> training time: </span><span class="si">{</span><span class="n">train_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
<a id="__codelineno-5-277" name="__codelineno-5-277" href="#__codelineno-5-277"></a>
<a id="__codelineno-5-278" name="__codelineno-5-278" href="#__codelineno-5-278"></a>    <span class="c1"># 比較メトリクス</span>
<a id="__codelineno-5-279" name="__codelineno-5-279" href="#__codelineno-5-279"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">{</span>
<a id="__codelineno-5-280" name="__codelineno-5-280" href="#__codelineno-5-280"></a>        <span class="s1">&#39;compression_ratio&#39;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-5-281" name="__codelineno-5-281" href="#__codelineno-5-281"></a>        <span class="s1">&#39;unk_rate&#39;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-5-282" name="__codelineno-5-282" href="#__codelineno-5-282"></a>        <span class="s1">&#39;encode_time&#39;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-5-283" name="__codelineno-5-283" href="#__codelineno-5-283"></a>        <span class="s1">&#39;decode_time&#39;</span><span class="p">:</span> <span class="p">[],</span>
<a id="__codelineno-5-284" name="__codelineno-5-284" href="#__codelineno-5-284"></a>        <span class="s1">&#39;vocab_size&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">)</span>
<a id="__codelineno-5-285" name="__codelineno-5-285" href="#__codelineno-5-285"></a>    <span class="p">}</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
<a id="__codelineno-5-286" name="__codelineno-5-286" href="#__codelineno-5-286"></a>
<a id="__codelineno-5-287" name="__codelineno-5-287" href="#__codelineno-5-287"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Tokenization Comparison ===&quot;</span><span class="p">)</span>
<a id="__codelineno-5-288" name="__codelineno-5-288" href="#__codelineno-5-288"></a>
<a id="__codelineno-5-289" name="__codelineno-5-289" href="#__codelineno-5-289"></a>    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">test_texts</span><span class="p">:</span>
<a id="__codelineno-5-290" name="__codelineno-5-290" href="#__codelineno-5-290"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Text: </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-291" name="__codelineno-5-291" href="#__codelineno-5-291"></a>
<a id="__codelineno-5-292" name="__codelineno-5-292" href="#__codelineno-5-292"></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">tokenizer</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-5-293" name="__codelineno-5-293" href="#__codelineno-5-293"></a>            <span class="c1"># エンコード</span>
<a id="__codelineno-5-294" name="__codelineno-5-294" href="#__codelineno-5-294"></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-295" name="__codelineno-5-295" href="#__codelineno-5-295"></a>            <span class="n">ids</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<a id="__codelineno-5-296" name="__codelineno-5-296" href="#__codelineno-5-296"></a>            <span class="n">encode_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-5-297" name="__codelineno-5-297" href="#__codelineno-5-297"></a>
<a id="__codelineno-5-298" name="__codelineno-5-298" href="#__codelineno-5-298"></a>            <span class="c1"># デコード</span>
<a id="__codelineno-5-299" name="__codelineno-5-299" href="#__codelineno-5-299"></a>            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-5-300" name="__codelineno-5-300" href="#__codelineno-5-300"></a>            <span class="n">decoded</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-5-301" name="__codelineno-5-301" href="#__codelineno-5-301"></a>            <span class="n">decode_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a id="__codelineno-5-302" name="__codelineno-5-302" href="#__codelineno-5-302"></a>
<a id="__codelineno-5-303" name="__codelineno-5-303" href="#__codelineno-5-303"></a>            <span class="c1"># メトリクス計算</span>
<a id="__codelineno-5-304" name="__codelineno-5-304" href="#__codelineno-5-304"></a>            <span class="n">compression_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-5-305" name="__codelineno-5-305" href="#__codelineno-5-305"></a>
<a id="__codelineno-5-306" name="__codelineno-5-306" href="#__codelineno-5-306"></a>            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;BPE&#39;</span><span class="p">:</span>
<a id="__codelineno-5-307" name="__codelineno-5-307" href="#__codelineno-5-307"></a>                <span class="n">unk_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span>
<a id="__codelineno-5-308" name="__codelineno-5-308" href="#__codelineno-5-308"></a>            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;WordPiece&#39;</span><span class="p">:</span>
<a id="__codelineno-5-309" name="__codelineno-5-309" href="#__codelineno-5-309"></a>                <span class="n">unk_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span>
<a id="__codelineno-5-310" name="__codelineno-5-310" href="#__codelineno-5-310"></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># SentencePiece</span>
<a id="__codelineno-5-311" name="__codelineno-5-311" href="#__codelineno-5-311"></a>                <span class="n">unk_count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">vocab</span><span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">unk_token</span><span class="p">])</span>
<a id="__codelineno-5-312" name="__codelineno-5-312" href="#__codelineno-5-312"></a>
<a id="__codelineno-5-313" name="__codelineno-5-313" href="#__codelineno-5-313"></a>            <span class="n">unk_rate</span> <span class="o">=</span> <span class="n">unk_count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-5-314" name="__codelineno-5-314" href="#__codelineno-5-314"></a>
<a id="__codelineno-5-315" name="__codelineno-5-315" href="#__codelineno-5-315"></a>            <span class="c1"># 結果保存</span>
<a id="__codelineno-5-316" name="__codelineno-5-316" href="#__codelineno-5-316"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;compression_ratio&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compression_ratio</span><span class="p">)</span>
<a id="__codelineno-5-317" name="__codelineno-5-317" href="#__codelineno-5-317"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;unk_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unk_rate</span><span class="p">)</span>
<a id="__codelineno-5-318" name="__codelineno-5-318" href="#__codelineno-5-318"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;encode_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">encode_time</span><span class="p">)</span>
<a id="__codelineno-5-319" name="__codelineno-5-319" href="#__codelineno-5-319"></a>            <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;decode_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">decode_time</span><span class="p">)</span>
<a id="__codelineno-5-320" name="__codelineno-5-320" href="#__codelineno-5-320"></a>
<a id="__codelineno-5-321" name="__codelineno-5-321" href="#__codelineno-5-321"></a>            <span class="c1"># トークン表示</span>
<a id="__codelineno-5-322" name="__codelineno-5-322" href="#__codelineno-5-322"></a>            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;BPE&#39;</span><span class="p">:</span>
<a id="__codelineno-5-323" name="__codelineno-5-323" href="#__codelineno-5-323"></a>                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">id_to_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
<a id="__codelineno-5-324" name="__codelineno-5-324" href="#__codelineno-5-324"></a>            <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;WordPiece&#39;</span><span class="p">:</span>
<a id="__codelineno-5-325" name="__codelineno-5-325" href="#__codelineno-5-325"></a>                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">id_to_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
<a id="__codelineno-5-326" name="__codelineno-5-326" href="#__codelineno-5-326"></a>            <span class="k">else</span><span class="p">:</span>  <span class="c1"># SentencePiece</span>
<a id="__codelineno-5-327" name="__codelineno-5-327" href="#__codelineno-5-327"></a>                <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">id_to_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>
<a id="__codelineno-5-328" name="__codelineno-5-328" href="#__codelineno-5-328"></a>
<a id="__codelineno-5-329" name="__codelineno-5-329" href="#__codelineno-5-329"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<a id="__codelineno-5-330" name="__codelineno-5-330" href="#__codelineno-5-330"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Tokens: </span><span class="si">{</span><span class="n">tokens</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-331" name="__codelineno-5-331" href="#__codelineno-5-331"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Compression: </span><span class="si">{</span><span class="n">compression_ratio</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-332" name="__codelineno-5-332" href="#__codelineno-5-332"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  UNK rate: </span><span class="si">{</span><span class="n">unk_rate</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-333" name="__codelineno-5-333" href="#__codelineno-5-333"></a>
<a id="__codelineno-5-334" name="__codelineno-5-334" href="#__codelineno-5-334"></a>    <span class="c1"># 結果の可視化</span>
<a id="__codelineno-5-335" name="__codelineno-5-335" href="#__codelineno-5-335"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-5-336" name="__codelineno-5-336" href="#__codelineno-5-336"></a>
<a id="__codelineno-5-337" name="__codelineno-5-337" href="#__codelineno-5-337"></a>    <span class="c1"># 1. 圧縮率</span>
<a id="__codelineno-5-338" name="__codelineno-5-338" href="#__codelineno-5-338"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-339" name="__codelineno-5-339" href="#__codelineno-5-339"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-5-340" name="__codelineno-5-340" href="#__codelineno-5-340"></a>        <span class="n">avg_compression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;compression_ratio&#39;</span><span class="p">])</span>
<a id="__codelineno-5-341" name="__codelineno-5-341" href="#__codelineno-5-341"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avg_compression</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-5-342" name="__codelineno-5-342" href="#__codelineno-5-342"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Average Compression Ratio&#39;</span><span class="p">)</span>
<a id="__codelineno-5-343" name="__codelineno-5-343" href="#__codelineno-5-343"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Characters per Token&#39;</span><span class="p">)</span>
<a id="__codelineno-5-344" name="__codelineno-5-344" href="#__codelineno-5-344"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-5-345" name="__codelineno-5-345" href="#__codelineno-5-345"></a>
<a id="__codelineno-5-346" name="__codelineno-5-346" href="#__codelineno-5-346"></a>    <span class="c1"># 2. UNKトークン率</span>
<a id="__codelineno-5-347" name="__codelineno-5-347" href="#__codelineno-5-347"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-348" name="__codelineno-5-348" href="#__codelineno-5-348"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-5-349" name="__codelineno-5-349" href="#__codelineno-5-349"></a>        <span class="n">avg_unk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;unk_rate&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-5-350" name="__codelineno-5-350" href="#__codelineno-5-350"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avg_unk</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-5-351" name="__codelineno-5-351" href="#__codelineno-5-351"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Average UNK Token Rate&#39;</span><span class="p">)</span>
<a id="__codelineno-5-352" name="__codelineno-5-352" href="#__codelineno-5-352"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;UNK Rate (%)&#39;</span><span class="p">)</span>
<a id="__codelineno-5-353" name="__codelineno-5-353" href="#__codelineno-5-353"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-5-354" name="__codelineno-5-354" href="#__codelineno-5-354"></a>
<a id="__codelineno-5-355" name="__codelineno-5-355" href="#__codelineno-5-355"></a>    <span class="c1"># 3. エンコード時間</span>
<a id="__codelineno-5-356" name="__codelineno-5-356" href="#__codelineno-5-356"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-5-357" name="__codelineno-5-357" href="#__codelineno-5-357"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-5-358" name="__codelineno-5-358" href="#__codelineno-5-358"></a>        <span class="n">avg_encode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;encode_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-5-359" name="__codelineno-5-359" href="#__codelineno-5-359"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">avg_encode</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-5-360" name="__codelineno-5-360" href="#__codelineno-5-360"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Average Encoding Time&#39;</span><span class="p">)</span>
<a id="__codelineno-5-361" name="__codelineno-5-361" href="#__codelineno-5-361"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Time (ms)&#39;</span><span class="p">)</span>
<a id="__codelineno-5-362" name="__codelineno-5-362" href="#__codelineno-5-362"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-5-363" name="__codelineno-5-363" href="#__codelineno-5-363"></a>
<a id="__codelineno-5-364" name="__codelineno-5-364" href="#__codelineno-5-364"></a>    <span class="c1"># 4. 語彙サイズ</span>
<a id="__codelineno-5-365" name="__codelineno-5-365" href="#__codelineno-5-365"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-366" name="__codelineno-5-366" href="#__codelineno-5-366"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-5-367" name="__codelineno-5-367" href="#__codelineno-5-367"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;vocab_size&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-5-368" name="__codelineno-5-368" href="#__codelineno-5-368"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Vocabulary Size&#39;</span><span class="p">)</span>
<a id="__codelineno-5-369" name="__codelineno-5-369" href="#__codelineno-5-369"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of Tokens&#39;</span><span class="p">)</span>
<a id="__codelineno-5-370" name="__codelineno-5-370" href="#__codelineno-5-370"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-5-371" name="__codelineno-5-371" href="#__codelineno-5-371"></a>
<a id="__codelineno-5-372" name="__codelineno-5-372" href="#__codelineno-5-372"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-5-373" name="__codelineno-5-373" href="#__codelineno-5-373"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-5-374" name="__codelineno-5-374" href="#__codelineno-5-374"></a>
<a id="__codelineno-5-375" name="__codelineno-5-375" href="#__codelineno-5-375"></a>    <span class="c1"># サマリー表示</span>
<a id="__codelineno-5-376" name="__codelineno-5-376" href="#__codelineno-5-376"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Summary ===&quot;</span><span class="p">)</span>
<a id="__codelineno-5-377" name="__codelineno-5-377" href="#__codelineno-5-377"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Tokenizer&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Compression&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;UNK Rate&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Encode(ms)&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Vocab Size&#39;</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-378" name="__codelineno-5-378" href="#__codelineno-5-378"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">65</span><span class="p">)</span>
<a id="__codelineno-5-379" name="__codelineno-5-379" href="#__codelineno-5-379"></a>
<a id="__codelineno-5-380" name="__codelineno-5-380" href="#__codelineno-5-380"></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-5-381" name="__codelineno-5-381" href="#__codelineno-5-381"></a>        <span class="n">avg_comp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;compression_ratio&#39;</span><span class="p">])</span>
<a id="__codelineno-5-382" name="__codelineno-5-382" href="#__codelineno-5-382"></a>        <span class="n">avg_unk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;unk_rate&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">100</span>
<a id="__codelineno-5-383" name="__codelineno-5-383" href="#__codelineno-5-383"></a>        <span class="n">avg_encode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;encode_time&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-5-384" name="__codelineno-5-384" href="#__codelineno-5-384"></a>        <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;vocab_size&#39;</span><span class="p">]</span>
<a id="__codelineno-5-385" name="__codelineno-5-385" href="#__codelineno-5-385"></a>
<a id="__codelineno-5-386" name="__codelineno-5-386" href="#__codelineno-5-386"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_comp</span><span class="si">:</span><span class="s2">&lt;12.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_unk</span><span class="si">:</span><span class="s2">&lt;10.1f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_encode</span><span class="si">:</span><span class="s2">&lt;12.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">vocab_size</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-5-387" name="__codelineno-5-387" href="#__codelineno-5-387"></a>
<a id="__codelineno-5-388" name="__codelineno-5-388" href="#__codelineno-5-388"></a>    <span class="k">return</span> <span class="n">tokenizers</span><span class="p">,</span> <span class="n">results</span>
<a id="__codelineno-5-389" name="__codelineno-5-389" href="#__codelineno-5-389"></a>
<a id="__codelineno-5-390" name="__codelineno-5-390" href="#__codelineno-5-390"></a><span class="c1"># 比較実行</span>
<a id="__codelineno-5-391" name="__codelineno-5-391" href="#__codelineno-5-391"></a><span class="n">tokenizers</span><span class="p">,</span> <span class="n">comparison_results</span> <span class="o">=</span> <span class="n">compare_tokenizers</span><span class="p">()</span>
</code></pre></div>
</details>
<h2 id="54">演習 5.4: 推論時の工夫<a class="headerlink" href="#54" title="Permanent link">&para;</a></h2>
<h3 id="7">問題 7<a class="headerlink" href="#7" title="Permanent link">&para;</a></h3>
<p>ビームサーチとサンプリング手法（top-k, top-p）を実装し、生成品質を比較してください。</p>
<details class="解答">
<summary>解答</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">F</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="nd">@dataclass</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">GenerationConfig</span><span class="p">:</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;生成設定&quot;&quot;&quot;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>    <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a>    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a>    <span class="n">top_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>    <span class="n">top_p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.9</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a>    <span class="n">repetition_penalty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a>    <span class="n">num_beams</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a>    <span class="n">do_sample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="k">class</span><span class="w"> </span><span class="nc">TextGenerator</span><span class="p">:</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;テキスト生成クラス&quot;&quot;&quot;</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;cuda&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">):</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">,</span> 
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a>                <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sampling&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;指定された手法でテキストを生成&quot;&quot;&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a>        <span class="c1"># プロンプトをエンコード</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a>        <span class="n">input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">prompt</span><span class="p">)],</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a>        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;greedy&#39;</span><span class="p">:</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>            <span class="n">output_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_greedy_search</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;beam_search&#39;</span><span class="p">:</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a>            <span class="n">output_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beam_search</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;sampling&#39;</span><span class="p">:</span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a>            <span class="n">output_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampling</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;top_k&#39;</span><span class="p">:</span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a>            <span class="n">output_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_k_sampling</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;top_p&#39;</span><span class="p">:</span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a>            <span class="n">output_ids</span><span class="p">,</span> <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_top_p_sampling</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>        <span class="c1"># デコード</span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>        <span class="n">generated_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">output_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>            <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">generated_text</span><span class="p">,</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>            <span class="s1">&#39;ids&#39;</span><span class="p">:</span> <span class="n">output_ids</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a>            <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a>            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a>        <span class="p">}</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_greedy_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a>                      <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;貪欲法による生成&quot;&quot;&quot;</span>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a>        <span class="n">generated</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a>                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a>                <span class="c1"># Repetition penalty</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a>                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">repetition_penalty</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_repetition_penalty</span><span class="p">(</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>                        <span class="n">next_token_logits</span><span class="p">,</span> <span class="n">generated</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">repetition_penalty</span>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a>                    <span class="p">)</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>                <span class="c1"># 最も確率の高いトークンを選択</span>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a>                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a>                <span class="n">generated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">generated</span><span class="p">,</span> <span class="n">next_token</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a>                <span class="c1"># EOSトークンで終了</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>                <span class="k">if</span> <span class="n">next_token</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a>                    <span class="k">break</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a>        <span class="k">return</span> <span class="n">generated</span><span class="p">,</span> <span class="n">scores</span>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_beam_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>                    <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;ビームサーチによる生成&quot;&quot;&quot;</span>
<a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a>        <span class="n">num_beams</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">num_beams</span>
<a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>
<a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a>        <span class="c1"># ビームの初期化</span>
<a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>        <span class="n">beam_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_beams</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a>        <span class="n">beam_scores</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1e9</span>  <span class="c1"># 最初は1つのビームのみ有効</span>
<a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a>
<a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a>        <span class="c1"># 各ビームの系列</span>
<a id="__codelineno-6-100" name="__codelineno-6-100" href="#__codelineno-6-100"></a>        <span class="n">beam_sequences</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_beams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-101" name="__codelineno-6-101" href="#__codelineno-6-101"></a>        <span class="n">beam_sequences</span> <span class="o">=</span> <span class="n">beam_sequences</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_beams</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-102" name="__codelineno-6-102" href="#__codelineno-6-102"></a>
<a id="__codelineno-6-103" name="__codelineno-6-103" href="#__codelineno-6-103"></a>        <span class="c1"># 完了したビーム</span>
<a id="__codelineno-6-104" name="__codelineno-6-104" href="#__codelineno-6-104"></a>        <span class="n">done</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_beams</span><span class="p">)</span>
<a id="__codelineno-6-105" name="__codelineno-6-105" href="#__codelineno-6-105"></a>        <span class="n">scores_history</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-106" name="__codelineno-6-106" href="#__codelineno-6-106"></a>
<a id="__codelineno-6-107" name="__codelineno-6-107" href="#__codelineno-6-107"></a>        <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-6-108" name="__codelineno-6-108" href="#__codelineno-6-108"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-6-109" name="__codelineno-6-109" href="#__codelineno-6-109"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">beam_sequences</span><span class="p">)</span>
<a id="__codelineno-6-110" name="__codelineno-6-110" href="#__codelineno-6-110"></a>                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
<a id="__codelineno-6-111" name="__codelineno-6-111" href="#__codelineno-6-111"></a>
<a id="__codelineno-6-112" name="__codelineno-6-112" href="#__codelineno-6-112"></a>                <span class="c1"># スコア計算</span>
<a id="__codelineno-6-113" name="__codelineno-6-113" href="#__codelineno-6-113"></a>                <span class="n">vocab_size</span> <span class="o">=</span> <span class="n">next_token_logits</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-6-114" name="__codelineno-6-114" href="#__codelineno-6-114"></a>                <span class="n">next_token_scores</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-115" name="__codelineno-6-115" href="#__codelineno-6-115"></a>
<a id="__codelineno-6-116" name="__codelineno-6-116" href="#__codelineno-6-116"></a>                <span class="c1"># 現在のビームスコアを加算</span>
<a id="__codelineno-6-117" name="__codelineno-6-117" href="#__codelineno-6-117"></a>                <span class="n">next_token_scores</span> <span class="o">=</span> <span class="n">next_token_scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_beams</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-118" name="__codelineno-6-118" href="#__codelineno-6-118"></a>                <span class="n">next_token_scores</span> <span class="o">=</span> <span class="n">next_token_scores</span> <span class="o">+</span> <span class="n">beam_scores</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-119" name="__codelineno-6-119" href="#__codelineno-6-119"></a>
<a id="__codelineno-6-120" name="__codelineno-6-120" href="#__codelineno-6-120"></a>                <span class="c1"># 全候補から上位k個を選択</span>
<a id="__codelineno-6-121" name="__codelineno-6-121" href="#__codelineno-6-121"></a>                <span class="n">next_token_scores</span> <span class="o">=</span> <span class="n">next_token_scores</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_beams</span> <span class="o">*</span> <span class="n">vocab_size</span><span class="p">)</span>
<a id="__codelineno-6-122" name="__codelineno-6-122" href="#__codelineno-6-122"></a>                <span class="n">next_scores</span><span class="p">,</span> <span class="n">next_tokens</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span>
<a id="__codelineno-6-123" name="__codelineno-6-123" href="#__codelineno-6-123"></a>                    <span class="n">next_token_scores</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">num_beams</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">sorted</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-6-124" name="__codelineno-6-124" href="#__codelineno-6-124"></a>                <span class="p">)</span>
<a id="__codelineno-6-125" name="__codelineno-6-125" href="#__codelineno-6-125"></a>
<a id="__codelineno-6-126" name="__codelineno-6-126" href="#__codelineno-6-126"></a>                <span class="c1"># 次のビームを構築</span>
<a id="__codelineno-6-127" name="__codelineno-6-127" href="#__codelineno-6-127"></a>                <span class="n">next_batch_beam</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-128" name="__codelineno-6-128" href="#__codelineno-6-128"></a>
<a id="__codelineno-6-129" name="__codelineno-6-129" href="#__codelineno-6-129"></a>                <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
<a id="__codelineno-6-130" name="__codelineno-6-130" href="#__codelineno-6-130"></a>                    <span class="n">next_sent_beam</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-131" name="__codelineno-6-131" href="#__codelineno-6-131"></a>
<a id="__codelineno-6-132" name="__codelineno-6-132" href="#__codelineno-6-132"></a>                    <span class="k">for</span> <span class="n">rank</span><span class="p">,</span> <span class="p">(</span><span class="n">token_score</span><span class="p">,</span> <span class="n">token_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
<a id="__codelineno-6-133" name="__codelineno-6-133" href="#__codelineno-6-133"></a>                        <span class="nb">zip</span><span class="p">(</span><span class="n">next_scores</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">],</span> <span class="n">next_tokens</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">])</span>
<a id="__codelineno-6-134" name="__codelineno-6-134" href="#__codelineno-6-134"></a>                    <span class="p">):</span>
<a id="__codelineno-6-135" name="__codelineno-6-135" href="#__codelineno-6-135"></a>                        <span class="n">beam_id</span> <span class="o">=</span> <span class="n">token_id</span> <span class="o">//</span> <span class="n">vocab_size</span>
<a id="__codelineno-6-136" name="__codelineno-6-136" href="#__codelineno-6-136"></a>                        <span class="n">token_id</span> <span class="o">=</span> <span class="n">token_id</span> <span class="o">%</span> <span class="n">vocab_size</span>
<a id="__codelineno-6-137" name="__codelineno-6-137" href="#__codelineno-6-137"></a>
<a id="__codelineno-6-138" name="__codelineno-6-138" href="#__codelineno-6-138"></a>                        <span class="n">effective_beam_id</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">num_beams</span> <span class="o">+</span> <span class="n">beam_id</span>
<a id="__codelineno-6-139" name="__codelineno-6-139" href="#__codelineno-6-139"></a>
<a id="__codelineno-6-140" name="__codelineno-6-140" href="#__codelineno-6-140"></a>                        <span class="c1"># EOSトークンの処理</span>
<a id="__codelineno-6-141" name="__codelineno-6-141" href="#__codelineno-6-141"></a>                        <span class="k">if</span> <span class="n">token_id</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
<a id="__codelineno-6-142" name="__codelineno-6-142" href="#__codelineno-6-142"></a>                            <span class="n">done</span><span class="p">[</span><span class="n">effective_beam_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-6-143" name="__codelineno-6-143" href="#__codelineno-6-143"></a>
<a id="__codelineno-6-144" name="__codelineno-6-144" href="#__codelineno-6-144"></a>                        <span class="n">next_sent_beam</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
<a id="__codelineno-6-145" name="__codelineno-6-145" href="#__codelineno-6-145"></a>                            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">token_score</span><span class="p">,</span>
<a id="__codelineno-6-146" name="__codelineno-6-146" href="#__codelineno-6-146"></a>                            <span class="s1">&#39;token_id&#39;</span><span class="p">:</span> <span class="n">token_id</span><span class="p">,</span>
<a id="__codelineno-6-147" name="__codelineno-6-147" href="#__codelineno-6-147"></a>                            <span class="s1">&#39;beam_id&#39;</span><span class="p">:</span> <span class="n">effective_beam_id</span>
<a id="__codelineno-6-148" name="__codelineno-6-148" href="#__codelineno-6-148"></a>                        <span class="p">})</span>
<a id="__codelineno-6-149" name="__codelineno-6-149" href="#__codelineno-6-149"></a>
<a id="__codelineno-6-150" name="__codelineno-6-150" href="#__codelineno-6-150"></a>                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_sent_beam</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">num_beams</span><span class="p">:</span>
<a id="__codelineno-6-151" name="__codelineno-6-151" href="#__codelineno-6-151"></a>                            <span class="k">break</span>
<a id="__codelineno-6-152" name="__codelineno-6-152" href="#__codelineno-6-152"></a>
<a id="__codelineno-6-153" name="__codelineno-6-153" href="#__codelineno-6-153"></a>                    <span class="n">next_batch_beam</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">next_sent_beam</span><span class="p">)</span>
<a id="__codelineno-6-154" name="__codelineno-6-154" href="#__codelineno-6-154"></a>
<a id="__codelineno-6-155" name="__codelineno-6-155" href="#__codelineno-6-155"></a>                <span class="c1"># ビームを更新</span>
<a id="__codelineno-6-156" name="__codelineno-6-156" href="#__codelineno-6-156"></a>                <span class="n">beam_scores</span> <span class="o">=</span> <span class="n">beam_scores</span><span class="o">.</span><span class="n">new_zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">num_beams</span><span class="p">))</span>
<a id="__codelineno-6-157" name="__codelineno-6-157" href="#__codelineno-6-157"></a>                <span class="n">beam_sequences</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-158" name="__codelineno-6-158" href="#__codelineno-6-158"></a>
<a id="__codelineno-6-159" name="__codelineno-6-159" href="#__codelineno-6-159"></a>                <span class="k">for</span> <span class="n">beam_idx</span><span class="p">,</span> <span class="n">beam</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">next_batch_beam</span><span class="p">):</span>
<a id="__codelineno-6-160" name="__codelineno-6-160" href="#__codelineno-6-160"></a>                    <span class="n">batch_idx</span> <span class="o">=</span> <span class="n">beam_idx</span> <span class="o">//</span> <span class="n">num_beams</span>
<a id="__codelineno-6-161" name="__codelineno-6-161" href="#__codelineno-6-161"></a>                    <span class="n">beam_scores</span><span class="p">[</span><span class="n">batch_idx</span><span class="p">,</span> <span class="n">beam_idx</span> <span class="o">%</span> <span class="n">num_beams</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span>
<a id="__codelineno-6-162" name="__codelineno-6-162" href="#__codelineno-6-162"></a>
<a id="__codelineno-6-163" name="__codelineno-6-163" href="#__codelineno-6-163"></a>                    <span class="n">prev_seq</span> <span class="o">=</span> <span class="n">beam_sequences</span><span class="p">[</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;beam_id&#39;</span><span class="p">]]</span>
<a id="__codelineno-6-164" name="__codelineno-6-164" href="#__codelineno-6-164"></a>                    <span class="n">new_seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">prev_seq</span><span class="p">,</span> <span class="n">beam</span><span class="p">[</span><span class="s1">&#39;token_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
<a id="__codelineno-6-165" name="__codelineno-6-165" href="#__codelineno-6-165"></a>                    <span class="n">beam_sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_seq</span><span class="p">)</span>
<a id="__codelineno-6-166" name="__codelineno-6-166" href="#__codelineno-6-166"></a>
<a id="__codelineno-6-167" name="__codelineno-6-167" href="#__codelineno-6-167"></a>                <span class="n">beam_sequences</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">beam_sequences</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-6-168" name="__codelineno-6-168" href="#__codelineno-6-168"></a>                <span class="n">scores_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beam_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<a id="__codelineno-6-169" name="__codelineno-6-169" href="#__codelineno-6-169"></a>
<a id="__codelineno-6-170" name="__codelineno-6-170" href="#__codelineno-6-170"></a>                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">done</span><span class="p">):</span>
<a id="__codelineno-6-171" name="__codelineno-6-171" href="#__codelineno-6-171"></a>                    <span class="k">break</span>
<a id="__codelineno-6-172" name="__codelineno-6-172" href="#__codelineno-6-172"></a>
<a id="__codelineno-6-173" name="__codelineno-6-173" href="#__codelineno-6-173"></a>        <span class="c1"># 最良のビームを返す</span>
<a id="__codelineno-6-174" name="__codelineno-6-174" href="#__codelineno-6-174"></a>        <span class="n">best_beam_idx</span> <span class="o">=</span> <span class="n">beam_scores</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
<a id="__codelineno-6-175" name="__codelineno-6-175" href="#__codelineno-6-175"></a>        <span class="n">best_sequence</span> <span class="o">=</span> <span class="n">beam_sequences</span><span class="p">[</span><span class="n">best_beam_idx</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-6-176" name="__codelineno-6-176" href="#__codelineno-6-176"></a>
<a id="__codelineno-6-177" name="__codelineno-6-177" href="#__codelineno-6-177"></a>        <span class="k">return</span> <span class="n">best_sequence</span><span class="p">,</span> <span class="n">scores_history</span>
<a id="__codelineno-6-178" name="__codelineno-6-178" href="#__codelineno-6-178"></a>
<a id="__codelineno-6-179" name="__codelineno-6-179" href="#__codelineno-6-179"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
<a id="__codelineno-6-180" name="__codelineno-6-180" href="#__codelineno-6-180"></a>                 <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-6-181" name="__codelineno-6-181" href="#__codelineno-6-181"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;温度付きサンプリング&quot;&quot;&quot;</span>
<a id="__codelineno-6-182" name="__codelineno-6-182" href="#__codelineno-6-182"></a>        <span class="n">generated</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-6-183" name="__codelineno-6-183" href="#__codelineno-6-183"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-184" name="__codelineno-6-184" href="#__codelineno-6-184"></a>
<a id="__codelineno-6-185" name="__codelineno-6-185" href="#__codelineno-6-185"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-6-186" name="__codelineno-6-186" href="#__codelineno-6-186"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-6-187" name="__codelineno-6-187" href="#__codelineno-6-187"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
<a id="__codelineno-6-188" name="__codelineno-6-188" href="#__codelineno-6-188"></a>                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">temperature</span>
<a id="__codelineno-6-189" name="__codelineno-6-189" href="#__codelineno-6-189"></a>
<a id="__codelineno-6-190" name="__codelineno-6-190" href="#__codelineno-6-190"></a>                <span class="c1"># Repetition penalty</span>
<a id="__codelineno-6-191" name="__codelineno-6-191" href="#__codelineno-6-191"></a>                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">repetition_penalty</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
<a id="__codelineno-6-192" name="__codelineno-6-192" href="#__codelineno-6-192"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_apply_repetition_penalty</span><span class="p">(</span>
<a id="__codelineno-6-193" name="__codelineno-6-193" href="#__codelineno-6-193"></a>                        <span class="n">next_token_logits</span><span class="p">,</span> <span class="n">generated</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">repetition_penalty</span>
<a id="__codelineno-6-194" name="__codelineno-6-194" href="#__codelineno-6-194"></a>                    <span class="p">)</span>
<a id="__codelineno-6-195" name="__codelineno-6-195" href="#__codelineno-6-195"></a>
<a id="__codelineno-6-196" name="__codelineno-6-196" href="#__codelineno-6-196"></a>                <span class="c1"># サンプリング</span>
<a id="__codelineno-6-197" name="__codelineno-6-197" href="#__codelineno-6-197"></a>                <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-198" name="__codelineno-6-198" href="#__codelineno-6-198"></a>                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-199" name="__codelineno-6-199" href="#__codelineno-6-199"></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_token</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-6-200" name="__codelineno-6-200" href="#__codelineno-6-200"></a>                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<a id="__codelineno-6-201" name="__codelineno-6-201" href="#__codelineno-6-201"></a>
<a id="__codelineno-6-202" name="__codelineno-6-202" href="#__codelineno-6-202"></a>                <span class="n">generated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">generated</span><span class="p">,</span> <span class="n">next_token</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-203" name="__codelineno-6-203" href="#__codelineno-6-203"></a>
<a id="__codelineno-6-204" name="__codelineno-6-204" href="#__codelineno-6-204"></a>                <span class="k">if</span> <span class="n">next_token</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
<a id="__codelineno-6-205" name="__codelineno-6-205" href="#__codelineno-6-205"></a>                    <span class="k">break</span>
<a id="__codelineno-6-206" name="__codelineno-6-206" href="#__codelineno-6-206"></a>
<a id="__codelineno-6-207" name="__codelineno-6-207" href="#__codelineno-6-207"></a>        <span class="k">return</span> <span class="n">generated</span><span class="p">,</span> <span class="n">scores</span>
<a id="__codelineno-6-208" name="__codelineno-6-208" href="#__codelineno-6-208"></a>
<a id="__codelineno-6-209" name="__codelineno-6-209" href="#__codelineno-6-209"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_top_k_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
<a id="__codelineno-6-210" name="__codelineno-6-210" href="#__codelineno-6-210"></a>                       <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-6-211" name="__codelineno-6-211" href="#__codelineno-6-211"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Top-kサンプリング&quot;&quot;&quot;</span>
<a id="__codelineno-6-212" name="__codelineno-6-212" href="#__codelineno-6-212"></a>        <span class="n">generated</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-6-213" name="__codelineno-6-213" href="#__codelineno-6-213"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-214" name="__codelineno-6-214" href="#__codelineno-6-214"></a>
<a id="__codelineno-6-215" name="__codelineno-6-215" href="#__codelineno-6-215"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-6-216" name="__codelineno-6-216" href="#__codelineno-6-216"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-6-217" name="__codelineno-6-217" href="#__codelineno-6-217"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
<a id="__codelineno-6-218" name="__codelineno-6-218" href="#__codelineno-6-218"></a>                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">temperature</span>
<a id="__codelineno-6-219" name="__codelineno-6-219" href="#__codelineno-6-219"></a>
<a id="__codelineno-6-220" name="__codelineno-6-220" href="#__codelineno-6-220"></a>                <span class="c1"># Top-kフィルタリング</span>
<a id="__codelineno-6-221" name="__codelineno-6-221" href="#__codelineno-6-221"></a>                <span class="n">top_k_logits</span><span class="p">,</span> <span class="n">top_k_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span>
<a id="__codelineno-6-222" name="__codelineno-6-222" href="#__codelineno-6-222"></a>                    <span class="n">next_token_logits</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">top_k</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
<a id="__codelineno-6-223" name="__codelineno-6-223" href="#__codelineno-6-223"></a>                <span class="p">)</span>
<a id="__codelineno-6-224" name="__codelineno-6-224" href="#__codelineno-6-224"></a>
<a id="__codelineno-6-225" name="__codelineno-6-225" href="#__codelineno-6-225"></a>                <span class="c1"># 確率を再計算</span>
<a id="__codelineno-6-226" name="__codelineno-6-226" href="#__codelineno-6-226"></a>                <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">top_k_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-227" name="__codelineno-6-227" href="#__codelineno-6-227"></a>
<a id="__codelineno-6-228" name="__codelineno-6-228" href="#__codelineno-6-228"></a>                <span class="c1"># サンプリング</span>
<a id="__codelineno-6-229" name="__codelineno-6-229" href="#__codelineno-6-229"></a>                <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-230" name="__codelineno-6-230" href="#__codelineno-6-230"></a>                <span class="n">next_token</span> <span class="o">=</span> <span class="n">top_k_indices</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span>
<a id="__codelineno-6-231" name="__codelineno-6-231" href="#__codelineno-6-231"></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">sample_idx</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-6-232" name="__codelineno-6-232" href="#__codelineno-6-232"></a>                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<a id="__codelineno-6-233" name="__codelineno-6-233" href="#__codelineno-6-233"></a>
<a id="__codelineno-6-234" name="__codelineno-6-234" href="#__codelineno-6-234"></a>                <span class="n">generated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">generated</span><span class="p">,</span> <span class="n">next_token</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-235" name="__codelineno-6-235" href="#__codelineno-6-235"></a>
<a id="__codelineno-6-236" name="__codelineno-6-236" href="#__codelineno-6-236"></a>                <span class="k">if</span> <span class="n">next_token</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
<a id="__codelineno-6-237" name="__codelineno-6-237" href="#__codelineno-6-237"></a>                    <span class="k">break</span>
<a id="__codelineno-6-238" name="__codelineno-6-238" href="#__codelineno-6-238"></a>
<a id="__codelineno-6-239" name="__codelineno-6-239" href="#__codelineno-6-239"></a>        <span class="k">return</span> <span class="n">generated</span><span class="p">,</span> <span class="n">scores</span>
<a id="__codelineno-6-240" name="__codelineno-6-240" href="#__codelineno-6-240"></a>
<a id="__codelineno-6-241" name="__codelineno-6-241" href="#__codelineno-6-241"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_top_p_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_ids</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
<a id="__codelineno-6-242" name="__codelineno-6-242" href="#__codelineno-6-242"></a>                       <span class="n">config</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<a id="__codelineno-6-243" name="__codelineno-6-243" href="#__codelineno-6-243"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Top-p (Nucleus) サンプリング&quot;&quot;&quot;</span>
<a id="__codelineno-6-244" name="__codelineno-6-244" href="#__codelineno-6-244"></a>        <span class="n">generated</span> <span class="o">=</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-6-245" name="__codelineno-6-245" href="#__codelineno-6-245"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-246" name="__codelineno-6-246" href="#__codelineno-6-246"></a>
<a id="__codelineno-6-247" name="__codelineno-6-247" href="#__codelineno-6-247"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">max_length</span> <span class="o">-</span> <span class="n">input_ids</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
<a id="__codelineno-6-248" name="__codelineno-6-248" href="#__codelineno-6-248"></a>            <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
<a id="__codelineno-6-249" name="__codelineno-6-249" href="#__codelineno-6-249"></a>                <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">generated</span><span class="p">)</span>
<a id="__codelineno-6-250" name="__codelineno-6-250" href="#__codelineno-6-250"></a>                <span class="n">next_token_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">config</span><span class="o">.</span><span class="n">temperature</span>
<a id="__codelineno-6-251" name="__codelineno-6-251" href="#__codelineno-6-251"></a>
<a id="__codelineno-6-252" name="__codelineno-6-252" href="#__codelineno-6-252"></a>                <span class="c1"># ソートして累積確率を計算</span>
<a id="__codelineno-6-253" name="__codelineno-6-253" href="#__codelineno-6-253"></a>                <span class="n">sorted_logits</span><span class="p">,</span> <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
<a id="__codelineno-6-254" name="__codelineno-6-254" href="#__codelineno-6-254"></a>                    <span class="n">next_token_logits</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-6-255" name="__codelineno-6-255" href="#__codelineno-6-255"></a>                <span class="p">)</span>
<a id="__codelineno-6-256" name="__codelineno-6-256" href="#__codelineno-6-256"></a>                <span class="n">cumulative_probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span>
<a id="__codelineno-6-257" name="__codelineno-6-257" href="#__codelineno-6-257"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">sorted_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span>
<a id="__codelineno-6-258" name="__codelineno-6-258" href="#__codelineno-6-258"></a>                <span class="p">)</span>
<a id="__codelineno-6-259" name="__codelineno-6-259" href="#__codelineno-6-259"></a>
<a id="__codelineno-6-260" name="__codelineno-6-260" href="#__codelineno-6-260"></a>                <span class="c1"># Top-pを超える位置を見つける</span>
<a id="__codelineno-6-261" name="__codelineno-6-261" href="#__codelineno-6-261"></a>                <span class="n">sorted_indices_to_remove</span> <span class="o">=</span> <span class="n">cumulative_probs</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">.</span><span class="n">top_p</span>
<a id="__codelineno-6-262" name="__codelineno-6-262" href="#__codelineno-6-262"></a>                <span class="c1"># 少なくとも1つは残す</span>
<a id="__codelineno-6-263" name="__codelineno-6-263" href="#__codelineno-6-263"></a>                <span class="n">sorted_indices_to_remove</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sorted_indices_to_remove</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
<a id="__codelineno-6-264" name="__codelineno-6-264" href="#__codelineno-6-264"></a>                <span class="n">sorted_indices_to_remove</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-6-265" name="__codelineno-6-265" href="#__codelineno-6-265"></a>
<a id="__codelineno-6-266" name="__codelineno-6-266" href="#__codelineno-6-266"></a>                <span class="c1"># フィルタリング</span>
<a id="__codelineno-6-267" name="__codelineno-6-267" href="#__codelineno-6-267"></a>                <span class="n">indices_to_remove</span> <span class="o">=</span> <span class="n">sorted_indices_to_remove</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
<a id="__codelineno-6-268" name="__codelineno-6-268" href="#__codelineno-6-268"></a>                    <span class="mi">1</span><span class="p">,</span> <span class="n">sorted_indices</span><span class="p">,</span> <span class="n">sorted_indices_to_remove</span>
<a id="__codelineno-6-269" name="__codelineno-6-269" href="#__codelineno-6-269"></a>                <span class="p">)</span>
<a id="__codelineno-6-270" name="__codelineno-6-270" href="#__codelineno-6-270"></a>                <span class="n">next_token_logits</span><span class="p">[</span><span class="n">indices_to_remove</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
<a id="__codelineno-6-271" name="__codelineno-6-271" href="#__codelineno-6-271"></a>
<a id="__codelineno-6-272" name="__codelineno-6-272" href="#__codelineno-6-272"></a>                <span class="c1"># サンプリング</span>
<a id="__codelineno-6-273" name="__codelineno-6-273" href="#__codelineno-6-273"></a>                <span class="n">probs</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">next_token_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-274" name="__codelineno-6-274" href="#__codelineno-6-274"></a>                <span class="n">next_token</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-275" name="__codelineno-6-275" href="#__codelineno-6-275"></a>                <span class="n">score</span> <span class="o">=</span> <span class="n">probs</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">next_token</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<a id="__codelineno-6-276" name="__codelineno-6-276" href="#__codelineno-6-276"></a>                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
<a id="__codelineno-6-277" name="__codelineno-6-277" href="#__codelineno-6-277"></a>
<a id="__codelineno-6-278" name="__codelineno-6-278" href="#__codelineno-6-278"></a>                <span class="n">generated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">generated</span><span class="p">,</span> <span class="n">next_token</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-6-279" name="__codelineno-6-279" href="#__codelineno-6-279"></a>
<a id="__codelineno-6-280" name="__codelineno-6-280" href="#__codelineno-6-280"></a>                <span class="k">if</span> <span class="n">next_token</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token_id</span><span class="p">:</span>
<a id="__codelineno-6-281" name="__codelineno-6-281" href="#__codelineno-6-281"></a>                    <span class="k">break</span>
<a id="__codelineno-6-282" name="__codelineno-6-282" href="#__codelineno-6-282"></a>
<a id="__codelineno-6-283" name="__codelineno-6-283" href="#__codelineno-6-283"></a>        <span class="k">return</span> <span class="n">generated</span><span class="p">,</span> <span class="n">scores</span>
<a id="__codelineno-6-284" name="__codelineno-6-284" href="#__codelineno-6-284"></a>
<a id="__codelineno-6-285" name="__codelineno-6-285" href="#__codelineno-6-285"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_repetition_penalty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> 
<a id="__codelineno-6-286" name="__codelineno-6-286" href="#__codelineno-6-286"></a>                                <span class="n">generated</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">penalty</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<a id="__codelineno-6-287" name="__codelineno-6-287" href="#__codelineno-6-287"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;繰り返しペナルティを適用&quot;&quot;&quot;</span>
<a id="__codelineno-6-288" name="__codelineno-6-288" href="#__codelineno-6-288"></a>        <span class="k">for</span> <span class="n">token_id</span> <span class="ow">in</span> <span class="n">generated</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
<a id="__codelineno-6-289" name="__codelineno-6-289" href="#__codelineno-6-289"></a>            <span class="k">if</span> <span class="n">logits</span><span class="p">[:,</span> <span class="n">token_id</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-6-290" name="__codelineno-6-290" href="#__codelineno-6-290"></a>                <span class="n">logits</span><span class="p">[:,</span> <span class="n">token_id</span><span class="p">]</span> <span class="o">*=</span> <span class="n">penalty</span>
<a id="__codelineno-6-291" name="__codelineno-6-291" href="#__codelineno-6-291"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-6-292" name="__codelineno-6-292" href="#__codelineno-6-292"></a>                <span class="n">logits</span><span class="p">[:,</span> <span class="n">token_id</span><span class="p">]</span> <span class="o">/=</span> <span class="n">penalty</span>
<a id="__codelineno-6-293" name="__codelineno-6-293" href="#__codelineno-6-293"></a>
<a id="__codelineno-6-294" name="__codelineno-6-294" href="#__codelineno-6-294"></a><span class="k">def</span><span class="w"> </span><span class="nf">compare_generation_methods</span><span class="p">():</span>
<a id="__codelineno-6-295" name="__codelineno-6-295" href="#__codelineno-6-295"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;生成手法の比較&quot;&quot;&quot;</span>
<a id="__codelineno-6-296" name="__codelineno-6-296" href="#__codelineno-6-296"></a>
<a id="__codelineno-6-297" name="__codelineno-6-297" href="#__codelineno-6-297"></a>    <span class="c1"># ダミーモデルとトークナイザー（前の演習から）</span>
<a id="__codelineno-6-298" name="__codelineno-6-298" href="#__codelineno-6-298"></a>    <span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">100</span>
<a id="__codelineno-6-299" name="__codelineno-6-299" href="#__codelineno-6-299"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">GPTWithPositionalEncoding</span><span class="p">(</span>
<a id="__codelineno-6-300" name="__codelineno-6-300" href="#__codelineno-6-300"></a>        <span class="n">vocab_size</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span>
<a id="__codelineno-6-301" name="__codelineno-6-301" href="#__codelineno-6-301"></a>        <span class="n">d_model</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-6-302" name="__codelineno-6-302" href="#__codelineno-6-302"></a>        <span class="n">n_heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<a id="__codelineno-6-303" name="__codelineno-6-303" href="#__codelineno-6-303"></a>        <span class="n">n_layers</span><span class="o">=</span><span class="mi">2</span>
<a id="__codelineno-6-304" name="__codelineno-6-304" href="#__codelineno-6-304"></a>    <span class="p">)</span>
<a id="__codelineno-6-305" name="__codelineno-6-305" href="#__codelineno-6-305"></a>
<a id="__codelineno-6-306" name="__codelineno-6-306" href="#__codelineno-6-306"></a>    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">SimpleTokenizer</span><span class="p">()</span>
<a id="__codelineno-6-307" name="__codelineno-6-307" href="#__codelineno-6-307"></a>
<a id="__codelineno-6-308" name="__codelineno-6-308" href="#__codelineno-6-308"></a>    <span class="c1"># テキストジェネレーター</span>
<a id="__codelineno-6-309" name="__codelineno-6-309" href="#__codelineno-6-309"></a>    <span class="n">generator</span> <span class="o">=</span> <span class="n">TextGenerator</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<a id="__codelineno-6-310" name="__codelineno-6-310" href="#__codelineno-6-310"></a>
<a id="__codelineno-6-311" name="__codelineno-6-311" href="#__codelineno-6-311"></a>    <span class="c1"># プロンプト</span>
<a id="__codelineno-6-312" name="__codelineno-6-312" href="#__codelineno-6-312"></a>    <span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-6-313" name="__codelineno-6-313" href="#__codelineno-6-313"></a>        <span class="s2">&quot;The weather today is&quot;</span><span class="p">,</span>
<a id="__codelineno-6-314" name="__codelineno-6-314" href="#__codelineno-6-314"></a>        <span class="s2">&quot;Machine learning can&quot;</span><span class="p">,</span>
<a id="__codelineno-6-315" name="__codelineno-6-315" href="#__codelineno-6-315"></a>        <span class="s2">&quot;In the future, we will&quot;</span><span class="p">,</span>
<a id="__codelineno-6-316" name="__codelineno-6-316" href="#__codelineno-6-316"></a>    <span class="p">]</span>
<a id="__codelineno-6-317" name="__codelineno-6-317" href="#__codelineno-6-317"></a>
<a id="__codelineno-6-318" name="__codelineno-6-318" href="#__codelineno-6-318"></a>    <span class="c1"># 各手法で生成</span>
<a id="__codelineno-6-319" name="__codelineno-6-319" href="#__codelineno-6-319"></a>    <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;greedy&#39;</span><span class="p">,</span> <span class="s1">&#39;beam_search&#39;</span><span class="p">,</span> <span class="s1">&#39;sampling&#39;</span><span class="p">,</span> <span class="s1">&#39;top_k&#39;</span><span class="p">,</span> <span class="s1">&#39;top_p&#39;</span><span class="p">]</span>
<a id="__codelineno-6-320" name="__codelineno-6-320" href="#__codelineno-6-320"></a>    <span class="n">configs</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-6-321" name="__codelineno-6-321" href="#__codelineno-6-321"></a>        <span class="s1">&#39;greedy&#39;</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
<a id="__codelineno-6-322" name="__codelineno-6-322" href="#__codelineno-6-322"></a>        <span class="s1">&#39;beam_search&#39;</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">num_beams</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
<a id="__codelineno-6-323" name="__codelineno-6-323" href="#__codelineno-6-323"></a>        <span class="s1">&#39;sampling&#39;</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">do_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-6-324" name="__codelineno-6-324" href="#__codelineno-6-324"></a>        <span class="s1">&#39;top_k&#39;</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span>
<a id="__codelineno-6-325" name="__codelineno-6-325" href="#__codelineno-6-325"></a>        <span class="s1">&#39;top_p&#39;</span><span class="p">:</span> <span class="n">GenerationConfig</span><span class="p">(</span><span class="n">temperature</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">top_p</span><span class="o">=</span><span class="mf">0.95</span><span class="p">),</span>
<a id="__codelineno-6-326" name="__codelineno-6-326" href="#__codelineno-6-326"></a>    <span class="p">}</span>
<a id="__codelineno-6-327" name="__codelineno-6-327" href="#__codelineno-6-327"></a>
<a id="__codelineno-6-328" name="__codelineno-6-328" href="#__codelineno-6-328"></a>    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">method</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">}</span>
<a id="__codelineno-6-329" name="__codelineno-6-329" href="#__codelineno-6-329"></a>
<a id="__codelineno-6-330" name="__codelineno-6-330" href="#__codelineno-6-330"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Generation Method Comparison ===</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-331" name="__codelineno-6-331" href="#__codelineno-6-331"></a>
<a id="__codelineno-6-332" name="__codelineno-6-332" href="#__codelineno-6-332"></a>    <span class="k">for</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">prompts</span><span class="p">:</span>
<a id="__codelineno-6-333" name="__codelineno-6-333" href="#__codelineno-6-333"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prompt: &#39;</span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
<a id="__codelineno-6-334" name="__codelineno-6-334" href="#__codelineno-6-334"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
<a id="__codelineno-6-335" name="__codelineno-6-335" href="#__codelineno-6-335"></a>
<a id="__codelineno-6-336" name="__codelineno-6-336" href="#__codelineno-6-336"></a>        <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
<a id="__codelineno-6-337" name="__codelineno-6-337" href="#__codelineno-6-337"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">configs</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
<a id="__codelineno-6-338" name="__codelineno-6-338" href="#__codelineno-6-338"></a>            <span class="n">results</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<a id="__codelineno-6-339" name="__codelineno-6-339" href="#__codelineno-6-339"></a>
<a id="__codelineno-6-340" name="__codelineno-6-340" href="#__codelineno-6-340"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">method</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
<a id="__codelineno-6-341" name="__codelineno-6-341" href="#__codelineno-6-341"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generated: </span><span class="si">{</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-342" name="__codelineno-6-342" href="#__codelineno-6-342"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Avg Score: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-343" name="__codelineno-6-343" href="#__codelineno-6-343"></a>
<a id="__codelineno-6-344" name="__codelineno-6-344" href="#__codelineno-6-344"></a>    <span class="c1"># 多様性と品質の分析</span>
<a id="__codelineno-6-345" name="__codelineno-6-345" href="#__codelineno-6-345"></a>    <span class="n">analyze_generation_quality</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">prompts</span><span class="p">)</span>
<a id="__codelineno-6-346" name="__codelineno-6-346" href="#__codelineno-6-346"></a>
<a id="__codelineno-6-347" name="__codelineno-6-347" href="#__codelineno-6-347"></a>    <span class="k">return</span> <span class="n">results</span>
<a id="__codelineno-6-348" name="__codelineno-6-348" href="#__codelineno-6-348"></a>
<a id="__codelineno-6-349" name="__codelineno-6-349" href="#__codelineno-6-349"></a><span class="k">def</span><span class="w"> </span><span class="nf">analyze_generation_quality</span><span class="p">(</span><span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]],</span> <span class="n">prompts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-6-350" name="__codelineno-6-350" href="#__codelineno-6-350"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;生成品質の分析&quot;&quot;&quot;</span>
<a id="__codelineno-6-351" name="__codelineno-6-351" href="#__codelineno-6-351"></a>
<a id="__codelineno-6-352" name="__codelineno-6-352" href="#__codelineno-6-352"></a>    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<a id="__codelineno-6-353" name="__codelineno-6-353" href="#__codelineno-6-353"></a>
<a id="__codelineno-6-354" name="__codelineno-6-354" href="#__codelineno-6-354"></a>    <span class="c1"># 1. 平均スコア（信頼度）</span>
<a id="__codelineno-6-355" name="__codelineno-6-355" href="#__codelineno-6-355"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-356" name="__codelineno-6-356" href="#__codelineno-6-356"></a>    <span class="n">avg_scores</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-6-357" name="__codelineno-6-357" href="#__codelineno-6-357"></a>    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_results</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-6-358" name="__codelineno-6-358" href="#__codelineno-6-358"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">method_results</span><span class="p">]</span>
<a id="__codelineno-6-359" name="__codelineno-6-359" href="#__codelineno-6-359"></a>        <span class="n">avg_scores</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
<a id="__codelineno-6-360" name="__codelineno-6-360" href="#__codelineno-6-360"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">avg_scores</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-6-361" name="__codelineno-6-361" href="#__codelineno-6-361"></a>
<a id="__codelineno-6-362" name="__codelineno-6-362" href="#__codelineno-6-362"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Average Generation Confidence&#39;</span><span class="p">)</span>
<a id="__codelineno-6-363" name="__codelineno-6-363" href="#__codelineno-6-363"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average Score&#39;</span><span class="p">)</span>
<a id="__codelineno-6-364" name="__codelineno-6-364" href="#__codelineno-6-364"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<a id="__codelineno-6-365" name="__codelineno-6-365" href="#__codelineno-6-365"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-6-366" name="__codelineno-6-366" href="#__codelineno-6-366"></a>
<a id="__codelineno-6-367" name="__codelineno-6-367" href="#__codelineno-6-367"></a>    <span class="c1"># 2. 生成長の分布</span>
<a id="__codelineno-6-368" name="__codelineno-6-368" href="#__codelineno-6-368"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-6-369" name="__codelineno-6-369" href="#__codelineno-6-369"></a>    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_results</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-6-370" name="__codelineno-6-370" href="#__codelineno-6-370"></a>        <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">method_results</span><span class="p">]</span>
<a id="__codelineno-6-371" name="__codelineno-6-371" href="#__codelineno-6-371"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lengths</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<a id="__codelineno-6-372" name="__codelineno-6-372" href="#__codelineno-6-372"></a>
<a id="__codelineno-6-373" name="__codelineno-6-373" href="#__codelineno-6-373"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Generation Length by Method&#39;</span><span class="p">)</span>
<a id="__codelineno-6-374" name="__codelineno-6-374" href="#__codelineno-6-374"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Example Index&#39;</span><span class="p">)</span>
<a id="__codelineno-6-375" name="__codelineno-6-375" href="#__codelineno-6-375"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Sequence Length&#39;</span><span class="p">)</span>
<a id="__codelineno-6-376" name="__codelineno-6-376" href="#__codelineno-6-376"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<a id="__codelineno-6-377" name="__codelineno-6-377" href="#__codelineno-6-377"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-6-378" name="__codelineno-6-378" href="#__codelineno-6-378"></a>
<a id="__codelineno-6-379" name="__codelineno-6-379" href="#__codelineno-6-379"></a>    <span class="c1"># 3. トークンの多様性（ユニークトークン数）</span>
<a id="__codelineno-6-380" name="__codelineno-6-380" href="#__codelineno-6-380"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-6-381" name="__codelineno-6-381" href="#__codelineno-6-381"></a>    <span class="n">diversity_scores</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-6-382" name="__codelineno-6-382" href="#__codelineno-6-382"></a>    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_results</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-6-383" name="__codelineno-6-383" href="#__codelineno-6-383"></a>        <span class="n">unique_ratios</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-384" name="__codelineno-6-384" href="#__codelineno-6-384"></a>        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">method_results</span><span class="p">:</span>
<a id="__codelineno-6-385" name="__codelineno-6-385" href="#__codelineno-6-385"></a>            <span class="n">tokens</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-6-386" name="__codelineno-6-386" href="#__codelineno-6-386"></a>            <span class="n">unique_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
<a id="__codelineno-6-387" name="__codelineno-6-387" href="#__codelineno-6-387"></a>            <span class="n">unique_ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unique_ratio</span><span class="p">)</span>
<a id="__codelineno-6-388" name="__codelineno-6-388" href="#__codelineno-6-388"></a>        <span class="n">diversity_scores</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">unique_ratios</span><span class="p">)</span>
<a id="__codelineno-6-389" name="__codelineno-6-389" href="#__codelineno-6-389"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">diversity_scores</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-6-390" name="__codelineno-6-390" href="#__codelineno-6-390"></a>
<a id="__codelineno-6-391" name="__codelineno-6-391" href="#__codelineno-6-391"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Token Diversity (Unique Token Ratio)&#39;</span><span class="p">)</span>
<a id="__codelineno-6-392" name="__codelineno-6-392" href="#__codelineno-6-392"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Unique Token Ratio&#39;</span><span class="p">)</span>
<a id="__codelineno-6-393" name="__codelineno-6-393" href="#__codelineno-6-393"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<a id="__codelineno-6-394" name="__codelineno-6-394" href="#__codelineno-6-394"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-6-395" name="__codelineno-6-395" href="#__codelineno-6-395"></a>
<a id="__codelineno-6-396" name="__codelineno-6-396" href="#__codelineno-6-396"></a>    <span class="c1"># 4. スコアの安定性（標準偏差）</span>
<a id="__codelineno-6-397" name="__codelineno-6-397" href="#__codelineno-6-397"></a>    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-6-398" name="__codelineno-6-398" href="#__codelineno-6-398"></a>    <span class="n">stability_scores</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-6-399" name="__codelineno-6-399" href="#__codelineno-6-399"></a>    <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_results</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-6-400" name="__codelineno-6-400" href="#__codelineno-6-400"></a>        <span class="n">score_stds</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;scores&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> 
<a id="__codelineno-6-401" name="__codelineno-6-401" href="#__codelineno-6-401"></a>                     <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">method_results</span><span class="p">]</span>
<a id="__codelineno-6-402" name="__codelineno-6-402" href="#__codelineno-6-402"></a>        <span class="n">stability_scores</span><span class="p">[</span><span class="n">method</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">score_stds</span><span class="p">)</span>
<a id="__codelineno-6-403" name="__codelineno-6-403" href="#__codelineno-6-403"></a>        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">stability_scores</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<a id="__codelineno-6-404" name="__codelineno-6-404" href="#__codelineno-6-404"></a>
<a id="__codelineno-6-405" name="__codelineno-6-405" href="#__codelineno-6-405"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Score Stability (Lower is More Stable)&#39;</span><span class="p">)</span>
<a id="__codelineno-6-406" name="__codelineno-6-406" href="#__codelineno-6-406"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average Score Std Dev&#39;</span><span class="p">)</span>
<a id="__codelineno-6-407" name="__codelineno-6-407" href="#__codelineno-6-407"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<a id="__codelineno-6-408" name="__codelineno-6-408" href="#__codelineno-6-408"></a>    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<a id="__codelineno-6-409" name="__codelineno-6-409" href="#__codelineno-6-409"></a>
<a id="__codelineno-6-410" name="__codelineno-6-410" href="#__codelineno-6-410"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<a id="__codelineno-6-411" name="__codelineno-6-411" href="#__codelineno-6-411"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<a id="__codelineno-6-412" name="__codelineno-6-412" href="#__codelineno-6-412"></a>
<a id="__codelineno-6-413" name="__codelineno-6-413" href="#__codelineno-6-413"></a>    <span class="c1"># サマリー統計</span>
<a id="__codelineno-6-414" name="__codelineno-6-414" href="#__codelineno-6-414"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Generation Quality Summary ===&quot;</span><span class="p">)</span>
<a id="__codelineno-6-415" name="__codelineno-6-415" href="#__codelineno-6-415"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Method&#39;</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Avg Score&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Diversity&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;Stability&#39;</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-416" name="__codelineno-6-416" href="#__codelineno-6-416"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">55</span><span class="p">)</span>
<a id="__codelineno-6-417" name="__codelineno-6-417" href="#__codelineno-6-417"></a>
<a id="__codelineno-6-418" name="__codelineno-6-418" href="#__codelineno-6-418"></a>    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
<a id="__codelineno-6-419" name="__codelineno-6-419" href="#__codelineno-6-419"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">avg_scores</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-6-420" name="__codelineno-6-420" href="#__codelineno-6-420"></a>              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">diversity_scores</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12.4f</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-6-421" name="__codelineno-6-421" href="#__codelineno-6-421"></a>              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stability_scores</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-6-422" name="__codelineno-6-422" href="#__codelineno-6-422"></a>
<a id="__codelineno-6-423" name="__codelineno-6-423" href="#__codelineno-6-423"></a><span class="c1"># 実行</span>
<a id="__codelineno-6-424" name="__codelineno-6-424" href="#__codelineno-6-424"></a><span class="n">generation_results</span> <span class="o">=</span> <span class="n">compare_generation_methods</span><span class="p">()</span>
</code></pre></div>
</details>
<h2 id="_1">チャレンジ問題<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="8">問題 8 🌟<a class="headerlink" href="#8" title="Permanent link">&para;</a></h3>
<p>実用的なチャットボットシステムを構築してください。以下の機能を含む：
- コンテキスト管理（会話履歴）
- プロンプトエンジニアリング
- 安全性フィルター
- ストリーミング出力</p>
<details class="解答">
<summary>解答</summary>
<p>```python
import torch
import torch.nn as nn
from typing import List, Dict, Optional, Generator, Tuple
import asyncio
from dataclasses import dataclass, field
from datetime import datetime
import re
from collections import deque</p>
<p>@dataclass
class Message:
    """チャットメッセージ"""
    role: str  # 'user' or 'assistant'
    content: str
    timestamp: datetime = field(default_factory=datetime.now)
    metadata: Dict = field(default_factory=dict)</p>
<p>@dataclass
class ChatConfig:
    """チャット設定"""
    max_context_length: int = 2048
    max_response_length: int = 512
    temperature: float = 0.7
    top_p: float = 0.9
    repetition_penalty: float = 1.1
    system_prompt: str = "You are a helpful assistant."
    safety_threshold: float = 0.8
    streaming: bool = True</p>
<p>class SafetyFilter:
    """安全性フィルター"""</p>
<div class="highlight"><pre><span></span><code>def __init__(self, threshold: float = 0.8):
    self.threshold = threshold
    # 簡易的な禁止語リスト（実際はより洗練されたモデルを使用）
    self.banned_patterns = [
        r&#39;\b(hate|violence|illegal)\b&#39;,
        r&#39;\b(harmful|dangerous)\b&#39;,
    ]

def is_safe(self, text: str) -&gt; Tuple[bool, Optional[str]]:
    &quot;&quot;&quot;テキストの安全性をチェック&quot;&quot;&quot;
    text_lower = text.lower()

    # 禁止パターンのチェック
    for pattern in self.banned_patterns:
        if re.search(pattern, text_lower):
            return False, f&quot;Content contains prohibited pattern: {pattern}&quot;

    # その他の安全性チェック（簡略化）
    if len(text) &gt; 10000:
        return False, &quot;Content too long&quot;

    return True, None

def sanitize(self, text: str) -&gt; str:
    &quot;&quot;&quot;テキストをサニタイズ&quot;&quot;&quot;
    # 基本的なサニタイゼーション
    text = text.strip()
    # 連続する空白を1つに
    text = re.sub(r&#39;\s+&#39;, &#39; &#39;, text)
    return text
</code></pre></div>
<p>class ConversationManager:
    """会話コンテキスト管理"""</p>
<div class="highlight"><pre><span></span><code>def __init__(self, max_context_length: int = 2048):
    self.max_context_length = max_context_length
    self.messages: deque[Message] = deque()
    self.token_counts: deque[int] = deque()

def add_message(self, message: Message, token_count: int):
    &quot;&quot;&quot;メッセージを追加&quot;&quot;&quot;
    self.messages.append(message)
    self.token_counts.append(token_count)

    # コンテキスト長を管理
    while sum(self.token_counts) &gt; self.max_context_length and len(self.messages) &gt; 2:
        self.messages.popleft()
        self.token_counts.popleft()

def get_context(self) -&gt; List[Message]:
    &quot;&quot;&quot;現在のコンテキストを取得&quot;&quot;&quot;
    return list(self.messages)

def clear(self):
    &quot;&quot;&quot;会話履歴をクリア&quot;&quot;&quot;
    self.messages.clear()
    self.token_counts.clear()

def format_for_model(self, tokenizer) -&gt; str:
    &quot;&quot;&quot;モデル入力用にフォーマット&quot;&quot;&quot;
    formatted_messages = []

    for msg in self.messages:
        if msg.role == &#39;user&#39;:
            formatted_messages.append(f&quot;User: {msg.content}&quot;)
        else:
            formatted_messages.append(f&quot;Assistant: {msg.content}&quot;)

    return &quot;\n&quot;.join(formatted_messages) + &quot;\nAssistant:&quot;
</code></pre></div>
<p>class PromptEngineering:
    """プロンプトエンジニアリング"""</p>
<div class="highlight"><pre><span></span><code>@staticmethod
def create_system_prompt(config: ChatConfig) -&gt; str:
    &quot;&quot;&quot;システムプロンプトを作成&quot;&quot;&quot;
    return f&quot;&quot;&quot;&lt;|system|&gt;
</code></pre></div>
</details>
<p>{config.system_prompt}</p>
<p>Guidelines:
1. Be helpful, harmless, and honest
2. Provide clear and concise responses
3. Admit when you don't know something
4. Refuse inappropriate requests politely
&lt;|endofsystem|&gt;"""</p>
<div class="highlight"><pre><span></span><code>    @staticmethod
    def format_chat_prompt(messages: List[Message], config: ChatConfig) -&gt; str:
        &quot;&quot;&quot;チャットプロンプトをフォーマット&quot;&quot;&quot;
        prompt_parts = [PromptEngineering.create_system_prompt(config)]

        for msg in messages:
            if msg.role == &#39;user&#39;:
                prompt_parts.append(f&quot;&lt;|user|&gt;\n{msg.content}\n&lt;|endofuser|&gt;&quot;)
            else:
                prompt_parts.append(f&quot;&lt;|assistant|&gt;\n{msg.content}\n&lt;|endofassistant|&gt;&quot;)

        # 最後のアシスタントプロンプトを追加
        prompt_parts.append(&quot;&lt;|assistant|&gt;&quot;)

        return &quot;\n&quot;.join(prompt_parts)

class StreamingChatbot:
    &quot;&quot;&quot;ストリーミング対応チャットボット&quot;&quot;&quot;

    def __init__(self, model, tokenizer, config: ChatConfig):
        self.model = model
        self.tokenizer = tokenizer
        self.config = config
        self.device = next(model.parameters()).device

        self.conversation = ConversationManager(config.max_context_length)
        self.safety_filter = SafetyFilter(config.safety_threshold)
        self.prompt_engineering = PromptEngineering()

    def generate_streaming(self, prompt: str) -&gt; Generator[str, None, None]:
        &quot;&quot;&quot;ストリーミング生成&quot;&quot;&quot;
        input_ids = torch.tensor([self.tokenizer.encode(prompt)], device=self.device)
        generated_ids = input_ids.clone()

        past_key_values = None
        generated_text = &quot;&quot;

        for _ in range(self.config.max_response_length):
            with torch.no_grad():
                if past_key_values is None:
                    outputs = self.model(generated_ids)
                else:
                    # 効率化のため前回のキャッシュを使用
                    outputs = self.model(
                        generated_ids[:, -1:],
                        past_key_values=past_key_values
                    )

                next_token_logits = outputs[:, -1, :]

                # 温度スケーリング
                next_token_logits = next_token_logits / self.config.temperature

                # Repetition penalty
                if self.config.repetition_penalty != 1.0:
                    for token_id in generated_ids[0].unique():
                        if next_token_logits[:, token_id] &lt; 0:
                            next_token_logits[:, token_id] *= self.config.repetition_penalty
                        else:
                            next_token_logits[:, token_id] /= self.config.repetition_penalty

                # Top-p sampling
                sorted_logits, sorted_indices = torch.sort(next_token_logits, descending=True)
                cumulative_probs = torch.cumsum(F.softmax(sorted_logits, dim=-1), dim=-1)

                sorted_indices_to_remove = cumulative_probs &gt; self.config.top_p
                sorted_indices_to_remove[..., 1:] = sorted_indices_to_remove[..., :-1].clone()
                sorted_indices_to_remove[..., 0] = 0

                indices_to_remove = sorted_indices_to_remove.scatter(
                    1, sorted_indices, sorted_indices_to_remove
                )
                next_token_logits[indices_to_remove] = -float(&#39;inf&#39;)

                # サンプリング
                probs = F.softmax(next_token_logits, dim=-1)
                next_token = torch.multinomial(probs, num_samples=1)

                # トークンを追加
                generated_ids = torch.cat([generated_ids, next_token], dim=1)

                # デコード
                token_text = self.tokenizer.decode([next_token.item()])
                generated_text += token_text

                # ストリーミング出力
                yield token_text

                # 終了条件
                if next_token.item() == self.tokenizer.eos_token_id:
                    break

                # 安全性チェック（定期的に）
                if len(generated_text) % 50 == 0:
                    is_safe, _ = self.safety_filter.is_safe(generated_text)
                    if not is_safe:
                        yield &quot;\n[Content filtered]&quot;
                        break

    async def chat_async(self, user_input: str) -&gt; AsyncGenerator[str, None]:
        &quot;&quot;&quot;非同期チャット&quot;&quot;&quot;
        # 入力の安全性チェック
        is_safe, reason = self.safety_filter.is_safe(user_input)
        if not is_safe:
            yield f&quot;I cannot process this request. Reason: {reason}&quot;
            return

        # サニタイズ
        user_input = self.safety_filter.sanitize(user_input)

        # ユーザーメッセージを追加
        user_msg = Message(role=&#39;user&#39;, content=user_input)
        user_token_count = len(self.tokenizer.encode(user_input))
        self.conversation.add_message(user_msg, user_token_count)

        # プロンプトを構築
        prompt = self.prompt_engineering.format_chat_prompt(
            self.conversation.get_context(), 
            self.config
        )

        # ストリーミング生成
        response_text = &quot;&quot;
        async for token in self._async_generate(prompt):
            response_text += token
            yield token

        # アシスタントメッセージを追加
        assistant_msg = Message(role=&#39;assistant&#39;, content=response_text)
        assistant_token_count = len(self.tokenizer.encode(response_text))
        self.conversation.add_message(assistant_msg, assistant_token_count)

    async def _async_generate(self, prompt: str) -&gt; AsyncGenerator[str, None]:
        &quot;&quot;&quot;非同期生成（実際の実装では別スレッドで実行）&quot;&quot;&quot;
        for token in self.generate_streaming(prompt):
            await asyncio.sleep(0.01)  # シミュレートされた遅延
            yield token

    def chat(self, user_input: str) -&gt; str:
        &quot;&quot;&quot;同期的なチャット（ストリーミングなし）&quot;&quot;&quot;
        # 入力チェック
        is_safe, reason = self.safety_filter.is_safe(user_input)
        if not is_safe:
            return f&quot;I cannot process this request. Reason: {reason}&quot;

        user_input = self.safety_filter.sanitize(user_input)

        # メッセージ追加
        user_msg = Message(role=&#39;user&#39;, content=user_input)
        user_token_count = len(self.tokenizer.encode(user_input))
        self.conversation.add_message(user_msg, user_token_count)

        # プロンプト構築
        prompt = self.prompt_engineering.format_chat_prompt(
            self.conversation.get_context(),
            self.config
        )

        # 生成
        response_text = &quot;&quot;
        for token in self.generate_streaming(prompt):
            response_text += token

        # 最終的な安全性チェック
        is_safe, _ = self.safety_filter.is_safe(response_text)
        if not is_safe:
            response_text = &quot;I apologize, but I cannot provide that response.&quot;

        # アシスタントメッセージ追加
        assistant_msg = Message(role=&#39;assistant&#39;, content=response_text)
        assistant_token_count = len(self.tokenizer.encode(response_text))
        self.conversation.add_message(assistant_msg, assistant_token_count)

        return response_text

class ChatbotUI:
    &quot;&quot;&quot;簡易的なチャットボットUI&quot;&quot;&quot;

    def __init__(self, chatbot: StreamingChatbot):
        self.chatbot = chatbot

    def run(self):
        &quot;&quot;&quot;インタラクティブチャットループ&quot;&quot;&quot;
        print(&quot;=== Chatbot Started ===&quot;)
        print(&quot;Type &#39;quit&#39; to exit, &#39;clear&#39; to clear conversation history&quot;)
        print(&quot;-&quot; * 50)

        while True:
            try:
                user_input = input(&quot;\nYou: &quot;).strip()

                if user_input.lower() == &#39;quit&#39;:
                    print(&quot;Goodbye!&quot;)
                    break

                if user_input.lower() == &#39;clear&#39;:
                    self.chatbot.conversation.clear()
                    print(&quot;Conversation history cleared.&quot;)
                    continue

                if not user_input:
                    continue

                print(&quot;\nAssistant: &quot;, end=&#39;&#39;, flush=True)

                if self.chatbot.config.streaming:
                    # ストリーミング出力
                    for token in self.chatbot.generate_streaming(user_input):
                        print(token, end=&#39;&#39;, flush=True)
                    print()  # 改行
                else:
                    # 通常の出力
                    response = self.chatbot.chat(user_input)
                    print(response)

            except KeyboardInterrupt:
                print(&quot;\n\nInterrupted. Type &#39;quit&#39; to exit.&quot;)
            except Exception as e:
                print(f&quot;\nError: {e}&quot;)

# 使用例
def demo_chatbot():
    &quot;&quot;&quot;チャットボットのデモ&quot;&quot;&quot;

    # モデルとトークナイザー（前の演習から）
    model = GPTWithPositionalEncoding(
        vocab_size=1000,
        d_model=256,
        n_heads=8,
        n_layers=4
    )

    tokenizer = SimpleTokenizer()

    # チャットボット設定
    config = ChatConfig(
        max_context_length=1024,
        temperature=0.8,
        top_p=0.95,
        system_prompt=&quot;You are a helpful AI assistant.&quot;,
        streaming=True
    )

    # チャットボット作成
    chatbot = StreamingChatbot(model, tokenizer, config)

    # デモ会話
    print(&quot;=== Chatbot Demo ===\n&quot;)

    test_conversations = [
        &quot;Hello! How are you?&quot;,
        &quot;Can you explain machine learning?&quot;,
        &quot;What&#39;s the weather like?&quot;,
        &quot;Tell me a joke.&quot;,
    ]

    for user_input in test_conversations:
        print(f&quot;User: {user_input}&quot;)
        print(&quot;Assistant: &quot;, end=&#39;&#39;)

        response = chatbot.chat(user_input)
        print(response)
        print(&quot;-&quot; * 50)

    # 会話履歴の表示
    print(&quot;\n=== Conversation History ===&quot;)
    for msg in chatbot.conversation.get_context():
        print(f&quot;{msg.role.upper()}: {msg.content[:50]}...&quot;)

    return chatbot

# デモ実行
chatbot_instance = demo_chatbot()

# インタラクティブモードを開始する場合
# ui = ChatbotUI(chatbot_instance)
# ui.run()
```
</code></pre></div>
<h2 id="_2">次のステップ<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>これらの演習を完了したら、以下の発展的なトピックに挑戦してみてください：</p>
<ol>
<li><strong>マルチモーダルTransformer</strong>: 画像とテキストを同時に扱う</li>
<li><strong>効率的なアーキテクチャ</strong>: Reformer、Linformer、Performerの実装</li>
<li><strong>強化学習との統合</strong>: RLHF（Reinforcement Learning from Human Feedback）</li>
<li><strong>分散学習</strong>: モデル並列、データ並列の実装</li>
</ol>
<p>💡 <strong>学習のアドバイス</strong>:
- 各実装を小さな部分から始めて徐々に複雑にしていく
- 実際のデータセットで実験してみる
- 最新の研究論文を読んで新しい手法を試す
- コミュニティのコードを参考にしながら自分なりの改良を加える</p>
<p>頑張ってください！🚀</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最終更新日">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">June 24, 2025 01:18:16</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="作成日">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime">June 24, 2025 01:18:16</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  ページトップへ戻る
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.path", "navigation.top", "toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u30b3\u30d4\u30fc\u3057\u307e\u3057\u305f", "clipboard.copy": "\u30af\u30ea\u30c3\u30d7\u30dc\u30fc\u30c9\u3078\u30b3\u30d4\u30fc", "search.result.more.one": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3082\u30461\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.more.other": "\u3053\u306e\u30da\u30fc\u30b8\u5185\u306b\u3042\u3068#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.none": "\u4f55\u3082\u898b\u3064\u304b\u308a\u307e\u305b\u3093\u3067\u3057\u305f", "search.result.one": "1\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.other": "#\u4ef6\u898b\u3064\u304b\u308a\u307e\u3057\u305f", "search.result.placeholder": "\u691c\u7d22\u30ad\u30fc\u30ef\u30fc\u30c9\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044", "search.result.term.missing": "\u691c\u7d22\u306b\u542b\u307e\u308c\u306a\u3044", "select.version": "\u30d0\u30fc\u30b8\u30e7\u30f3\u5207\u308a\u66ff\u3048"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>